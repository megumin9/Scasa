<!doctype html>
<html>
<head>
<title>/usr/STLcheck/sekitest/Cataclysm-DDA/src/melee.cpp</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { position:relative }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.msg.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Wrong iterator dereferenced -->

<!-- BUGTYPE Iterator out of range -->

<!-- BUGCATEGORY Misuse of STL APIs -->

<!-- BUGFILE /usr/STLcheck/sekitest/Cataclysm-DDA/src/melee.cpp -->

<!-- FILENAME melee.cpp -->

<!-- FUNCTIONNAME melee_message -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 6b8eeded0a2540e13c4acad8b1d332e7 -->

<!-- BUGLINE 2643 -->

<!-- BUGCOLUMN 25 -->

<!-- BUGPATHLENGTH 76 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/melee.cpp</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 2643, column 25</a><br />Wrong iterator dereferenced</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -analyzer-opt-analyze-nested-blocks -analyzer-config-compatibility-mode true -analyzer-purge none -analyzer-checker core -analyzer-checker apiModeling -analyzer-checker unix -analyzer-checker deadcode -analyzer-checker cplusplus -analyzer-checker security.insecureAPI.UncheckedReturn -analyzer-checker security.insecureAPI.getpw -analyzer-checker security.insecureAPI.gets -analyzer-checker security.insecureAPI.mktemp -analyzer-checker security.insecureAPI.mkstemp -analyzer-checker security.insecureAPI.vfork -analyzer-checker nullability.NullPassedToNonnull -analyzer-checker nullability.NullReturnedFromNonnull -analyzer-checker STL_seki -analyzer-disable-checker deadcode -analyzer-config experimental-enable-naive-ctu-analysis=true -analyzer-config ctu-invocation-list=/usr/STLcheck/sekitest/Cataclysm-DDA/build/csa-scan/invocations.yaml -analyzer-config suppress-null-return-paths=false -analyzer-config ctu-index-name=/usr/STLcheck/sekitest/Cataclysm-DDA/build/csa-scan/externalDefMap.txt -analyzer-config aggressive-binary-operation-simplification=true -analyzer-config crosscheck-with-z3=true -analyzer-config ctu-dir=/usr/STLcheck/sekitest/Cataclysm-DDA/build/csa-scan -w -ferror-limit 19 -Werror -Wall -Wextra -Wformat-signedness -Wlogical-op -Wmissing-declarations -Wmissing-noreturn -Wnon-virtual-dtor -Wold-style-cast -Woverloaded-virtual -Wpedantic -Wsuggest-override -Wunused-macros -Wzero-as-null-pointer-constant -Wno-unknown-warning-option -Wno-dangling-reference -Wno-c++20-compat -Wno-unknown-warning-option -Wredundant-decls -o /usr/STLcheck/sekitest/Cataclysm-DDA/build/csa-scan/reports -disable-free -analyze -x c++ /usr/STLcheck/sekitest/Cataclysm-DDA/src/melee.cpp -target-cpu x86-64 -tune-cpu generic -triple x86_64-unknown-linux-gnu -resource-dir /usr/STLcheck/seki/build-release/lib/clang/15.0.0 -I /usr/STLcheck/sekitest/Cataclysm-DDA/src -isystem /usr/STLcheck/sekitest/Cataclysm-DDA/src/third-party -isystem /usr/STLcheck/clang/include/clang/v1 -isystem /usr/STLcheck/seki/build-release/lib/clang/15.0.0/include -isystem /usr/local/include -isystem /usr/bin/../lib/gcc/x86_64-linux-gnu/12/../../../../x86_64-linux-gnu/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -std=c++17 -fcxx-exceptions -fexceptions -fmath-errno -pthread -pic-level 2 -pic-is-pie -fvisibility default -fdeprecated-macro -fgnuc-version=4.2.1 -ffp-contract=on -fno-experimental-relative-c++-abi-vtables -O1 -fdebug-compilation-dir=/usr/STLcheck/sekitest/Cataclysm-DDA/build/src -fcoverage-compilation-dir=/usr/STLcheck/sekitest/Cataclysm-DDA/build/src -faddrsig -dwarf-version=5 -debugger-tuning=gdb -funwind-tables=2 -mconstructor-aliases -clear-ast-before-backend -main-file-name melee.cpp -finline-functions -debug-info-kind=constructor -fdiagnostics-hotness-threshold=0 -fdiagnostics-misexpect-tolerance=0 -setup-static-analyzer -D BACKTRACE -D CMAKE -D GIT_VERSION -D LOCALIZE -D USE_HOME_DIR -D __GCC_HAVE_DWARF2_CFI_ASM=1
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"443": 1, "444": 1, "445": 1, "446": 1, "447": 1, "448": 1, "449": 1, "451": 1, "582": 1, "583": 1, "584": 1, "585": 1, "586": 1, "594": 1, "595": 1, "596": 1, "600": 1, "622": 1, "624": 1, "625": 1, "627": 1, "629": 1, "634": 1, "656": 1, "658": 1, "659": 1, "660": 1, "661": 1, "662": 1, "668": 1, "670": 1, "671": 1, "722": 1, "724": 1, "726": 1, "727": 1, "731": 1, "732": 1, "734": 1, "737": 1, "738": 1, "740": 1, "746": 1, "749": 1, "752": 1, "753": 1, "766": 1, "769": 1, "770": 1, "771": 1, "774": 1, "775": 1, "778": 1, "788": 1, "794": 1, "799": 1, "804": 1, "807": 1, "808": 1, "812": 1, "822": 1, "824": 1, "826": 1, "835": 1, "836": 1, "837": 1, "840": 1, "841": 1, "842": 1, "844": 1, "845": 1, "846": 1, "847": 1, "848": 1, "852": 1, "853": 1, "867": 1, "885": 1, "890": 1, "891": 1, "897": 1, "898": 1, "899": 1, "902": 1, "907": 1, "908": 1, "1086": 1, "1087": 1, "1088": 1, "1094": 1, "1095": 1, "1096": 1, "1099": 1, "1100": 1, "1102": 1, "1105": 1, "1106": 1, "1112": 1, "1114": 1, "1117": 1, "1123": 1, "1129": 1, "1130": 1, "1135": 1, "1137": 1, "1151": 1, "1154": 1, "1167": 1, "1168": 1, "1169": 1, "2531": 1, "2532": 1, "2533": 1, "2537": 1, "2538": 1, "2539": 1, "2540": 1, "2541": 1, "2542": 1, "2543": 1, "2546": 1, "2547": 1, "2548": 1, "2549": 1, "2550": 1, "2551": 1, "2552": 1, "2556": 1, "2557": 1, "2558": 1, "2559": 1, "2560": 1, "2561": 1, "2562": 1, "2563": 1, "2564": 1, "2565": 1, "2568": 1, "2569": 1, "2570": 1, "2571": 1, "2572": 1, "2573": 1, "2574": 1, "2575": 1, "2576": 1, "2577": 1, "2582": 1, "2583": 1, "2584": 1, "2585": 1, "2586": 1, "2587": 1, "2588": 1, "2591": 1, "2592": 1, "2593": 1, "2594": 1, "2595": 1, "2596": 1, "2597": 1, "2601": 1, "2602": 1, "2603": 1, "2613": 1, "2625": 1, "2628": 1, "2629": 1, "2630": 1, "2632": 1, "2634": 1, "2637": 1, "2640": 1, "2642": 1, "2643": 1}, "922": {"24": 1, "25": 1, "26": 1, "27": 1}, "3130": {"23": 1, "24": 1, "25": 1, "26": 1, "27": 1}, "10202": {"193": 1, "194": 1, "195": 1, "196": 1, "197": 1}, "11216": {"33": 1, "34": 1, "35": 1, "36": 1, "37": 1}, "62258": {"610": 1, "611": 1, "612": 1, "613": 1, "614": 1, "615": 1, "616": 1, "720": 1, "721": 1, "722": 1, "723": 1, "724": 1, "758": 1, "759": 1, "760": 1, "761": 1, "762": 1}, "82585": {"155": 1, "156": 1, "157": 1, "158": 1, "187": 1, "188": 1, "189": 1, "190": 1}, "83620": {"72": 1, "73": 1}, "85210": {"30": 1, "31": 1, "32": 1, "33": 1, "34": 1, "35": 1, "39": 1, "40": 1, "41": 1, "42": 1, "43": 1, "44": 1}, "86401": {"30": 1, "31": 1, "32": 1, "33": 1, "34": 1, "35": 1, "39": 1, "40": 1, "41": 1, "42": 1, "43": 1, "44": 1}, "122997": {"4190": 1, "4191": 1, "4192": 1, "4193": 1, "4194": 1, "4196": 1, "4197": 1, "4198": 1, "4199": 1, "4221": 1, "4222": 1, "4223": 1, "4224": 1, "4225": 1, "4226": 1}, "123201": {"207": 1, "218": 1}, "153480": {"124": 1, "125": 1, "126": 1, "127": 1, "128": 1, "129": 1, "139": 1, "140": 1, "226": 1, "238": 1, "239": 1, "244": 1, "245": 1, "260": 1, "261": 1}, "164033": {"28": 1}, "173948": {"21": 1, "22": 1}, "174091": {"148": 1, "149": 1, "222": 1, "223": 1, "238": 1, "239": 1, "433": 1, "457": 1, "458": 1, "459": 1, "460": 1, "515": 1, "516": 1, "517": 1, "518": 1}, "176866": {"914": 1, "919": 1, "920": 1, "921": 1, "922": 1, "923": 1, "930": 1, "939": 1, "941": 1, "988": 1, "989": 1, "991": 1, "992": 1, "993": 1, "994": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  // SHIFT + S
  if (event.shiftKey && event.keyCode == 83) {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].click();
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
    <input type="checkbox" name="showArrows"
           id="showArrows" style="margin-left: 10px" />
    <label for="showArrows">
       Show control flow arrows
    </label>
</form>

<script type='text/javascript'>
// Return range of numbers from a range [lower, upper).
function range(lower, upper) {
  var array = [];
  for (var i = lower; i <= upper; ++i) {
      array.push(i);
  }
  return array;
}

var getRelatedArrowIndices = function(pathId) {
  // HTML numeration of events is a bit different than it is in the path.
  // Everything is rotated one step to the right, so the last element
  // (error diagnostic) has index 0.
  if (pathId == 0) {
    // arrowIndices has at least 2 elements
    pathId = arrowIndices.length - 1;
  }

  return range(arrowIndices[pathId], arrowIndices[pathId - 1]);
}

var highlightArrowsForSelectedEvent = function() {
  const selectedNum = findNum();
  const arrowIndicesToHighlight = getRelatedArrowIndices(selectedNum);
  arrowIndicesToHighlight.forEach((index) => {
    var arrow = document.querySelector("#arrow" + index);
    if(arrow) {
      classListAdd(arrow, "selected")
    }
  });
}

var getAbsoluteBoundingRect = function(element) {
  const relative = element.getBoundingClientRect();
  return {
    left: relative.left + window.pageXOffset,
    right: relative.right + window.pageXOffset,
    top: relative.top + window.pageYOffset,
    bottom: relative.bottom + window.pageYOffset,
    height: relative.height,
    width: relative.width
  };
}

var drawArrow = function(index) {
  // This function is based on the great answer from SO:
  //   https://stackoverflow.com/a/39575674/11582326
  var start = document.querySelector("#start" + index);
  var end   = document.querySelector("#end" + index);
  var arrow = document.querySelector("#arrow" + index);

  var startRect = getAbsoluteBoundingRect(start);
  var endRect   = getAbsoluteBoundingRect(end);

  // It is an arrow from a token to itself, no need to visualize it.
  if (startRect.top == endRect.top &&
      startRect.left == endRect.left)
    return;

  // Each arrow is a very simple BÃ©zier curve, with two nodes and
  // two handles.  So, we need to calculate four points in the window:
  //   * start node
  var posStart    = { x: 0, y: 0 };
  //   * end node
  var posEnd      = { x: 0, y: 0 };
  //   * handle for the start node
  var startHandle = { x: 0, y: 0 };
  //   * handle for the end node
  var endHandle   = { x: 0, y: 0 };
  // One can visualize it as follows:
  //
  //         start handle
  //        /
  //       X"""_.-""""X
  //         .'        \
  //        /           start node
  //       |
  //       |
  //       |      end node
  //        \    /
  //         `->X
  //        X-'
  //         \
  //          end handle
  //
  // NOTE: (0, 0) is the top left corner of the window.

  // We have 3 similar, but still different scenarios to cover:
  //
  //   1. Two tokens on different lines.
  //             -xxx
  //           /
  //           \
  //             -> xxx
  //      In this situation, we draw arrow on the left curving to the left.
  //   2. Two tokens on the same line, and the destination is on the right.
  //             ____
  //            /    \
  //           /      V
  //        xxx        xxx
  //      In this situation, we draw arrow above curving upwards.
  //   3. Two tokens on the same line, and the destination is on the left.
  //        xxx        xxx
  //           ^      /
  //            \____/
  //      In this situation, we draw arrow below curving downwards.
  const onDifferentLines = startRect.top <= endRect.top - 5 ||
    startRect.top >= endRect.top + 5;
  const leftToRight = startRect.left < endRect.left;

  // NOTE: various magic constants are chosen empirically for
  //       better positioning and look
  if (onDifferentLines) {
    // Case #1
    const topToBottom = startRect.top < endRect.top;
    posStart.x = startRect.left - 1;
    // We don't want to start it at the top left corner of the token,
    // it doesn't feel like this is where the arrow comes from.
    // For this reason, we start it in the middle of the left side
    // of the token.
    posStart.y = startRect.top + startRect.height / 2;

    // End node has arrow head and we give it a bit more space.
    posEnd.x = endRect.left - 4;
    posEnd.y = endRect.top;

    // Utility object with x and y offsets for handles.
    var curvature = {
      // We want bottom-to-top arrow to curve a bit more, so it doesn't
      // overlap much with top-to-bottom curves (much more frequent).
      x: topToBottom ? 15 : 25,
      y: Math.min((posEnd.y - posStart.y) / 3, 10)
    }

    // When destination is on the different line, we can make a
    // curvier arrow because we have space for it.
    // So, instead of using
    //
    //   startHandle.x = posStart.x - curvature.x
    //   endHandle.x   = posEnd.x - curvature.x
    //
    // We use the leftmost of these two values for both handles.
    startHandle.x = Math.min(posStart.x, posEnd.x) - curvature.x;
    endHandle.x = startHandle.x;

    // Curving downwards from the start node...
    startHandle.y = posStart.y + curvature.y;
    // ... and upwards from the end node.
    endHandle.y = posEnd.y - curvature.y;

  } else if (leftToRight) {
    // Case #2
    // Starting from the top right corner...
    posStart.x = startRect.right - 1;
    posStart.y = startRect.top;

    // ...and ending at the top left corner of the end token.
    posEnd.x = endRect.left + 1;
    posEnd.y = endRect.top - 1;

    // Utility object with x and y offsets for handles.
    var curvature = {
      x: Math.min((posEnd.x - posStart.x) / 3, 15),
      y: 5
    }

    // Curving to the right...
    startHandle.x = posStart.x + curvature.x;
    // ... and upwards from the start node.
    startHandle.y = posStart.y - curvature.y;

    // And to the left...
    endHandle.x = posEnd.x - curvature.x;
    // ... and upwards from the end node.
    endHandle.y = posEnd.y - curvature.y;

  } else {
    // Case #3
    // Starting from the bottom right corner...
    posStart.x = startRect.right;
    posStart.y = startRect.bottom;

    // ...and ending also at the bottom right corner, but of the end token.
    posEnd.x = endRect.right - 1;
    posEnd.y = endRect.bottom + 1;

    // Utility object with x and y offsets for handles.
    var curvature = {
      x: Math.min((posStart.x - posEnd.x) / 3, 15),
      y: 5
    }

    // Curving to the left...
    startHandle.x = posStart.x - curvature.x;
    // ... and downwards from the start node.
    startHandle.y = posStart.y + curvature.y;

    // And to the right...
    endHandle.x = posEnd.x + curvature.x;
    // ... and downwards from the end node.
    endHandle.y = posEnd.y + curvature.y;
  }

  // Put it all together into a path.
  // More information on the format:
  //   https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths
  var pathStr = "M" + posStart.x + "," + posStart.y + " " +
    "C" + startHandle.x + "," + startHandle.y + " " +
    endHandle.x + "," + endHandle.y + " " +
    posEnd.x + "," + posEnd.y;

  arrow.setAttribute("d", pathStr);
};

var drawArrows = function() {
  const numOfArrows = document.querySelectorAll("path[id^=arrow]").length;
  for (var i = 0; i < numOfArrows; ++i) {
    drawArrow(i);
  }
}

var toggleArrows = function(event) {
  const arrows = document.querySelector("#arrows");
  if (event.target.checked) {
    arrows.setAttribute("visibility", "visible");
  } else {
    arrows.setAttribute("visibility", "hidden");
  }
}

window.addEventListener("resize", drawArrows);
document.addEventListener("DOMContentLoaded", function() {
  // Whenever we show invocation, locations change, i.e. we
  // need to redraw arrows.
  document
    .querySelector('input[id="showinvocation"]')
    .addEventListener("click", drawArrows);
  // Hiding irrelevant lines also should cause arrow rerender.
  document
    .querySelector('input[name="showCounterexample"]')
    .addEventListener("change", drawArrows);
  document
    .querySelector('input[name="showArrows"]')
    .addEventListener("change", toggleArrows);
  drawArrows();
  // Default highlighting for the last event.
  highlightArrowsForSelectedEvent();
});
</script>
  
<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".msg.selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var classListAdd = function(el, theClass) {
  if(!el.className.baseVal)
    el.className += " " + theClass;
  else
    el.className.baseVal += " " + theClass;
};

var classListRemove = function(el, theClass) {
  var className = (!el.className.baseVal) ?
      el.className : el.className.baseVal;
    className = className.replace(" " + theClass, "");
  if(!el.className.baseVal)
    el.className = className;
  else
    el.className.baseVal = className;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
      classListRemove(s, "selected");
    });
    classListAdd(el, "selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
    highlightArrowsForSelectedEvent();
};

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  // key 'j'
  if (event.keyCode == 74) {
    navigateTo(/*up=*/false);
  // key 'k'
  } else if (event.keyCode == 75) {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>

<style type="text/css">
  svg {
      position:absolute;
      top:0;
      left:0;
      height:100%;
      width:100%;
      pointer-events: none;
      overflow: visible
  }
  .arrow {
      stroke-opacity: 0.2;
      stroke-width: 1;
      marker-end: url(#arrowhead);
  }

  .arrow.selected {
      stroke-opacity: 0.6;
      stroke-width: 2;
      marker-end: url(#arrowheadSelected);
  }

  .arrowhead {
      orient: auto;
      stroke: none;
      opacity: 0.6;
      fill: blue;
  }
</style>
<svg xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowheadSelected" class="arrowhead" opacity="0.6"
            viewBox="0 0 10 10" refX="3" refY="5"
            markerWidth="4" markerHeight="4">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>
    <marker id="arrowhead" class="arrowhead" opacity="0.2"
            viewBox="0 0 10 10" refX="3" refY="5"
            markerWidth="4" markerHeight="4">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>
  </defs>
  <g id="arrows" fill="none" stroke="blue" visibility="hidden">
    <path class="arrow" id="arrow0"/>
    <path class="arrow" id="arrow1"/>
    <path class="arrow" id="arrow2"/>
    <path class="arrow" id="arrow3"/>
    <path class="arrow" id="arrow4"/>
    <path class="arrow" id="arrow5"/>
    <path class="arrow" id="arrow6"/>
    <path class="arrow" id="arrow7"/>
    <path class="arrow" id="arrow8"/>
    <path class="arrow" id="arrow9"/>
    <path class="arrow" id="arrow10"/>
    <path class="arrow" id="arrow11"/>
    <path class="arrow" id="arrow12"/>
    <path class="arrow" id="arrow13"/>
    <path class="arrow" id="arrow14"/>
    <path class="arrow" id="arrow15"/>
    <path class="arrow" id="arrow16"/>
    <path class="arrow" id="arrow17"/>
    <path class="arrow" id="arrow18"/>
    <path class="arrow" id="arrow19"/>
    <path class="arrow" id="arrow20"/>
    <path class="arrow" id="arrow21"/>
    <path class="arrow" id="arrow22"/>
    <path class="arrow" id="arrow23"/>
    <path class="arrow" id="arrow24"/>
    <path class="arrow" id="arrow25"/>
    <path class="arrow" id="arrow26"/>
    <path class="arrow" id="arrow27"/>
    <path class="arrow" id="arrow28"/>
    <path class="arrow" id="arrow29"/>
    <path class="arrow" id="arrow30"/>
    <path class="arrow" id="arrow31"/>
    <path class="arrow" id="arrow32"/>
    <path class="arrow" id="arrow33"/>
    <path class="arrow" id="arrow34"/>
    <path class="arrow" id="arrow35"/>
    <path class="arrow" id="arrow36"/>
    <path class="arrow" id="arrow37"/>
    <path class="arrow" id="arrow38"/>
    <path class="arrow" id="arrow39"/>
    <path class="arrow" id="arrow40"/>
    <path class="arrow" id="arrow41"/>
    <path class="arrow" id="arrow42"/>
    <path class="arrow" id="arrow43"/>
    <path class="arrow" id="arrow44"/>
    <path class="arrow" id="arrow45"/>
    <path class="arrow" id="arrow46"/>
    <path class="arrow" id="arrow47"/>
    <path class="arrow" id="arrow48"/>
    <path class="arrow" id="arrow49"/>
    <path class="arrow" id="arrow50"/>
    <path class="arrow" id="arrow51"/>
    <path class="arrow" id="arrow52"/>
    <path class="arrow" id="arrow53"/>
    <path class="arrow" id="arrow54"/>
    <path class="arrow" id="arrow55"/>
    <path class="arrow" id="arrow56"/>
    <path class="arrow" id="arrow57"/>
    <path class="arrow" id="arrow58"/>
    <path class="arrow" id="arrow59"/>
    <path class="arrow" id="arrow60"/>
    <path class="arrow" id="arrow61"/>
    <path class="arrow" id="arrow62"/>
    <path class="arrow" id="arrow63"/>
    <path class="arrow" id="arrow64"/>
    <path class="arrow" id="arrow65"/>
    <path class="arrow" id="arrow66"/>
    <path class="arrow" id="arrow67"/>
    <path class="arrow" id="arrow68"/>
    <path class="arrow" id="arrow69"/>
    <path class="arrow" id="arrow70"/>
    <path class="arrow" id="arrow71"/>
    <path class="arrow" id="arrow72"/>
    <path class="arrow" id="arrow73"/>
    <path class="arrow" id="arrow74"/>
    <path class="arrow" id="arrow75"/>
    <path class="arrow" id="arrow76"/>
    <path class="arrow" id="arrow77"/>
    <path class="arrow" id="arrow78"/>
    <path class="arrow" id="arrow79"/>
    <path class="arrow" id="arrow80"/>
    <path class="arrow" id="arrow81"/>
    <path class="arrow" id="arrow82"/>
    <path class="arrow" id="arrow83"/>
    <path class="arrow" id="arrow84"/>
    <path class="arrow" id="arrow85"/>
    <path class="arrow" id="arrow86"/>
    <path class="arrow" id="arrow87"/>
    <path class="arrow" id="arrow88"/>
    <path class="arrow" id="arrow89"/>
    <path class="arrow" id="arrow90"/>
    <path class="arrow" id="arrow91"/>
    <path class="arrow" id="arrow92"/>
    <path class="arrow" id="arrow93"/>
    <path class="arrow" id="arrow94"/>
    <path class="arrow" id="arrow95"/>
    <path class="arrow" id="arrow96"/>
    <path class="arrow" id="arrow97"/>
    <path class="arrow" id="arrow98"/>
    <path class="arrow" id="arrow99"/>
    <path class="arrow" id="arrow100"/>
    <path class="arrow" id="arrow101"/>
    <path class="arrow" id="arrow102"/>
    <path class="arrow" id="arrow103"/>
    <path class="arrow" id="arrow104"/>
    <path class="arrow" id="arrow105"/>
    <path class="arrow" id="arrow106"/>
    <path class="arrow" id="arrow107"/>
    <path class="arrow" id="arrow108"/>
    <path class="arrow" id="arrow109"/>
    <path class="arrow" id="arrow110"/>
    <path class="arrow" id="arrow111"/>
    <path class="arrow" id="arrow112"/>
    <path class="arrow" id="arrow113"/>
    <path class="arrow" id="arrow114"/>
    <path class="arrow" id="arrow115"/>
    <path class="arrow" id="arrow116"/>
    <path class="arrow" id="arrow117"/>
    <path class="arrow" id="arrow118"/>
    <path class="arrow" id="arrow119"/>
    <path class="arrow" id="arrow120"/>
    <path class="arrow" id="arrow121"/>
    <path class="arrow" id="arrow122"/>
    <path class="arrow" id="arrow123"/>
    <path class="arrow" id="arrow124"/>
    <path class="arrow" id="arrow125"/>
    <path class="arrow" id="arrow126"/>
    <path class="arrow" id="arrow127"/>
    <path class="arrow" id="arrow128"/>
    <path class="arrow" id="arrow129"/>
    <path class="arrow" id="arrow130"/>
    <path class="arrow" id="arrow131"/>
    <path class="arrow" id="arrow132"/>
    <path class="arrow" id="arrow133"/>
    <path class="arrow" id="arrow134"/>
    <path class="arrow" id="arrow135"/>
    <path class="arrow" id="arrow136"/>
    <path class="arrow" id="arrow137"/>
    <path class="arrow" id="arrow138"/>
    <path class="arrow" id="arrow139"/>
    <path class="arrow" id="arrow140"/>
    <path class="arrow" id="arrow141"/>
    <path class="arrow" id="arrow142"/>
    <path class="arrow" id="arrow143"/>
    <path class="arrow" id="arrow144"/>
    <path class="arrow" id="arrow145"/>
    <path class="arrow" id="arrow146"/>
    <path class="arrow" id="arrow147"/>
    <path class="arrow" id="arrow148"/>
    <path class="arrow" id="arrow149"/>
    <path class="arrow" id="arrow150"/>
    <path class="arrow" id="arrow151"/>
    <path class="arrow" id="arrow152"/>
    <path class="arrow" id="arrow153"/>
    <path class="arrow" id="arrow154"/>
    <path class="arrow" id="arrow155"/>
    <path class="arrow" id="arrow156"/>
    <path class="arrow" id="arrow157"/>
    <path class="arrow" id="arrow158"/>
    <path class="arrow" id="arrow159"/>
    <path class="arrow" id="arrow160"/>
    <path class="arrow" id="arrow161"/>

  </g>
</svg>
<script type='text/javascript'>
const arrowIndices = [ 162,161,160,158,156,156,154,151,148,145,142,139,137,136,134,132,127,124,120,118,116,114,110,110,108,103,103,103,99,96,93,87,84,78,76,74,70,67,65,63,60,58,53,49,48,47,46,41,39,38,36,36,34,31,30,28,26,25,23,23,19,14,12,9,8,4,4,1,0 ]
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='directive'>#include "melee.h"</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='directive'>#include &lt;algorithm&gt;</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='directive'>#include &lt;array&gt;</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"><span class='directive'>#include &lt;climits&gt;</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"><span class='directive'>#include &lt;cmath&gt;</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"><span class='directive'>#include &lt;cstdlib&gt;</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"><span class='directive'>#include &lt;iosfwd&gt;</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='directive'>#include &lt;limits&gt;</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='directive'>#include &lt;list&gt;</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#include &lt;map&gt;</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='directive'>#include &lt;memory&gt;</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='directive'>#include &lt;optional&gt;</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include &lt;set&gt;</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include &lt;string&gt;</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include &lt;utility&gt;</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#include &lt;vector&gt;</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include "avatar.h"</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#include "anatomy.h"</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include "bodypart.h"</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include "bionics.h"</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#include "cached_options.h"</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#include "calendar.h"</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#include "cata_utility.h"</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#include "character.h"</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "character_martial_arts.h"</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#include "creature.h"</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include "creature_tracker.h"</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "damage.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "debug.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "effect_on_condition.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "enum_bitset.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include "enums.h"</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include "event.h"</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include "event_bus.h"</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include "flag.h"</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include "game.h"</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include "game_constants.h"</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include "game_inventory.h"</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include "item.h"</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include "item_location.h"</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include "itype.h"</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#include "line.h"</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include "magic_enchantment.h"</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include "make_static.h"</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#include "map.h"</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#include "map_iterator.h"</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#include "mapdata.h"</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#include "martialarts.h"</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#include "memory_fast.h"</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#include "messages.h"</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#include "monattack.h"</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#include "monster.h"</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#include "mtype.h"</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='directive'>#include "mutation.h"</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#include "npc.h"</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#include "output.h"</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#include "pimpl.h"</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#include "point.h"</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#include "popup.h"</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#include "projectile.h"</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#include "rng.h"</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#include "sounds.h"</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"><span class='directive'>#include "string_formatter.h"</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='directive'>#include "translations.h"</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='directive'>#include "type_id.h"</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"><span class='directive'>#include "units.h"</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='directive'>#include "vehicle.h"</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='directive'>#include "vpart_position.h"</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='directive'>#include "weakpoint.h"</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"><span class='directive'>#include "weighted_list.h"</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> anatomy_id anatomy_human_anatomy( <span class='string_literal'>"human_anatomy"</span> );</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> bionic_id bio_cqb( <span class='string_literal'>"bio_cqb"</span> );</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> bionic_id bio_heat_absorb( <span class='string_literal'>"bio_heat_absorb"</span> );</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> bionic_id bio_razors( <span class='string_literal'>"bio_razors"</span> );</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> bionic_id bio_shock( <span class='string_literal'>"bio_shock"</span> );</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> character_modifier_id</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">character_modifier_limb_dodge_mod( <span class='string_literal'>"limb_dodge_mod"</span> );</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> character_modifier_id</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">character_modifier_melee_attack_roll_mod( <span class='string_literal'>"melee_attack_roll_mod"</span> );</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> character_modifier_id</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">character_modifier_melee_thrown_move_balance_mod( <span class='string_literal'>"melee_thrown_move_balance_mod"</span> );</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> character_modifier_id</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">character_modifier_melee_thrown_move_lift_mod( <span class='string_literal'>"melee_thrown_move_lift_mod"</span> );</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> damage_type_id damage_bash( <span class='string_literal'>"bash"</span> );</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> damage_type_id damage_cut( <span class='string_literal'>"cut"</span> );</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> damage_type_id damage_stab( <span class='string_literal'>"stab"</span> );</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_amigara( <span class='string_literal'>"amigara"</span> );</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_beartrap( <span class='string_literal'>"beartrap"</span> );</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_contacts( <span class='string_literal'>"contacts"</span> );</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_downed( <span class='string_literal'>"downed"</span> );</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_drunk( <span class='string_literal'>"drunk"</span> );</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_fearparalyze( <span class='string_literal'>"fearparalyze"</span> );</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_heavysnare( <span class='string_literal'>"heavysnare"</span> );</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_hit_by_player( <span class='string_literal'>"hit_by_player"</span> );</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_incorporeal( <span class='string_literal'>"incorporeal"</span> );</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_lightsnare( <span class='string_literal'>"lightsnare"</span> );</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_narcosis( <span class='string_literal'>"narcosis"</span> );</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_natural_stance( <span class='string_literal'>"natural_stance"</span> );</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_pet( <span class='string_literal'>"pet"</span> );</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_stunned( <span class='string_literal'>"stunned"</span> );</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_transition_contacts( <span class='string_literal'>"transition_contacts"</span> );</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_venom_dmg( <span class='string_literal'>"venom_dmg"</span> );</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_venom_player1( <span class='string_literal'>"venom_player1"</span> );</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_venom_player2( <span class='string_literal'>"venom_player2"</span> );</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_venom_weaken( <span class='string_literal'>"venom_weaken"</span> );</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> efftype_id effect_winded( <span class='string_literal'>"winded"</span> );</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> itype_id itype_fur( <span class='string_literal'>"fur"</span> );</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> itype_id itype_leather( <span class='string_literal'>"leather"</span> );</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> itype_id itype_sheet_cotton( <span class='string_literal'>"sheet_cotton"</span> );</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_CBQ_LEARN_BONUS( <span class='string_literal'>"CBQ_LEARN_BONUS"</span> );</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_GRAB( <span class='string_literal'>"GRAB"</span> );</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_GRAB_FILTER( <span class='string_literal'>"GRAB_FILTER"</span> );</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_HARDTOHIT( <span class='string_literal'>"HARDTOHIT"</span> );</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_HYPEROPIC( <span class='string_literal'>"HYPEROPIC"</span> );</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_NEED_ACTIVE_TO_MELEE( <span class='string_literal'>"NEED_ACTIVE_TO_MELEE"</span> );</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_NULL( <span class='string_literal'>"NULL"</span> );</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_PSEUDOPOD_GRASP( <span class='string_literal'>"PSEUDOPOD_GRASP"</span> );</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> json_character_flag json_flag_UNARMED_BONUS( <span class='string_literal'>"UNARMED_BONUS"</span> );</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> limb_score_id limb_score_block( <span class='string_literal'>"block"</span> );</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> limb_score_id limb_score_grip( <span class='string_literal'>"grip"</span> );</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> limb_score_id limb_score_reaction( <span class='string_literal'>"reaction"</span> );</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> matec_id WBLOCK_1( <span class='string_literal'>"WBLOCK_1"</span> );</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> matec_id WBLOCK_2( <span class='string_literal'>"WBLOCK_2"</span> );</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> matec_id WBLOCK_3( <span class='string_literal'>"WBLOCK_3"</span> );</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> matec_id WHIP_DISARM( <span class='string_literal'>"WHIP_DISARM"</span> );</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> material_id material_glass( <span class='string_literal'>"glass"</span> );</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> material_id material_steel( <span class='string_literal'>"steel"</span> );</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> move_mode_id move_mode_prone( <span class='string_literal'>"prone"</span> );</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> skill_id skill_melee( <span class='string_literal'>"melee"</span> );</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> skill_id skill_spellcraft( <span class='string_literal'>"spellcraft"</span> );</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> skill_id skill_unarmed( <span class='string_literal'>"unarmed"</span> );</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_ARM_TENTACLES( <span class='string_literal'>"ARM_TENTACLES"</span> );</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_ARM_TENTACLES_4( <span class='string_literal'>"ARM_TENTACLES_4"</span> );</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_ARM_TENTACLES_8( <span class='string_literal'>"ARM_TENTACLES_8"</span> );</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_BEAK_PECK( <span class='string_literal'>"BEAK_PECK"</span> );</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_CLAWS_TENTACLE( <span class='string_literal'>"CLAWS_TENTACLE"</span> );</td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_CLUMSY( <span class='string_literal'>"CLUMSY"</span> );</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_DEBUG_NIGHTVISION( <span class='string_literal'>"DEBUG_NIGHTVISION"</span> );</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_DEFT( <span class='string_literal'>"DEFT"</span> );</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_DRUNKEN( <span class='string_literal'>"DRUNKEN"</span> );</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_KI_STRIKE( <span class='string_literal'>"KI_STRIKE"</span> );</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_POISONOUS( <span class='string_literal'>"POISONOUS"</span> );</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_POISONOUS2( <span class='string_literal'>"POISONOUS2"</span> );</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_PROF_SKATER( <span class='string_literal'>"PROF_SKATER"</span> );</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_VINES2( <span class='string_literal'>"VINES2"</span> );</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> trait_id trait_VINES3( <span class='string_literal'>"VINES3"</span> );</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> player_hit_message( Character *attacker, <span class='keyword'>const</span> std::string &amp;message,</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">                                Creature &amp;t, <span class='keyword'>int</span> dam, <span class='keyword'>bool</span> crit = <span class='keyword'>false</span>, <span class='keyword'>bool</span> technique = <span class='keyword'>false</span>, <span class='keyword'>const</span> std::string &amp;wp_hit = {} );</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> stumble( Character &amp;u, <span class='keyword'>const</span> item_location &amp;weap );</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"><span class='keyword'>static</span> std::string melee_message( <span class='keyword'>const</span> ma_technique &amp;tec, Character &amp;p,</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">                                  <span class='keyword'>const</span> dealt_damage_instance &amp;ddi );</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"><span class='comment'>/* Melee Functions!</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> <span class='comment'>* These all belong to class player.</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> <span class='comment'>* STATE QUERIES</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> <span class='comment'>* bool is_armed() - True if we are armed with any item.</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"> <span class='comment'>* bool unarmed_attack() - True if we are attacking with a "fist" weapon</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"> <span class='comment'>* (cestus, bionic claws etc.) or no weapon.</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> <span class='comment'>* HIT DETERMINATION</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> <span class='comment'>* int hit_roll() - The player's hit roll, to be compared to a monster's or</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> <span class='comment'>*   player's dodge_roll().  This handles weapon bonuses, weapon-specific</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> <span class='comment'>*   skills, torso encumbrance penalties and drunken master bonuses.</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">item_location Character::used_weapon() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    <span class='keyword'>return</span> martial_arts_data-&gt;selected_force_unarmed() ? item_location() : get_wielded_item();</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">item_location Character::used_weapon()</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    <span class='keyword'>return</span> <span class='keyword'>const_cast</span>&lt;<span class='keyword'>const</span> Character *&gt;( <span class='keyword'>this</span> )-&gt;used_weapon();</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"><span class='keyword'>bool</span> Character::is_armed() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    <span class='keyword'>return</span> !weapon.is_null();</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line"><span class='keyword'>bool</span> Character::unarmed_attack() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    <span class='keyword'>const</span> item_location weap = used_weapon();</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">    <span class='keyword'>return</span> !weap;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"><span class='keyword'>bool</span> Character::handle_melee_wear( item_location shield, <span class='keyword'>float</span> wear_multiplier )</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">    <span class='keyword'>if</span>( wear_multiplier &lt;= 0.0f ) {</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    <span class='comment'>// Here is where we handle wear and tear on things we use as melee weapons or shields.</span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    <span class='keyword'>if</span>( !shield ) {</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='comment'>// UNBREAKABLE_MELEE and UNBREAKABLE items can't be damaged through melee combat usage.</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">    <span class='keyword'>if</span>( shield-&gt;has_flag( flag_UNBREAKABLE_MELEE ) || shield-&gt;has_flag( flag_UNBREAKABLE ) ) {</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    <span class='comment'>/** @EFFECT_DEX reduces chance of damaging your melee weapon */</span></td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    <span class='comment'>/** @ARM_STR increases chance of damaging your melee weapon (NEGATIVE) */</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE reduces chance of damaging your melee weapon */</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> stat_factor = dex_cur / 2.0f</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">                              + get_skill_level( skill_melee )</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">                              + ( 64.0f / std::max( get_arm_str(), 4 ) );</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='keyword'>float</span> material_factor;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    itype_id weak_comp;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    itype_id big_comp = itype_id::NULL_ID();</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    <span class='comment'>// Fragile items that fall apart easily when used as a weapon due to poor construction quality</span></td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    <span class='keyword'>if</span>( shield-&gt;has_flag( flag_FRAGILE_MELEE ) ) {</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>float</span> fragile_factor = 6.0f;</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">        <span class='keyword'>int</span> weak_chip = <span class='macro'>INT_MAX<span class='macro_popup'>2147483647</span></span>;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">        units::volume big_vol = 0_ml;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">        <span class='comment'>// Items that should have no bearing on durability</span></td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">        <span class='keyword'>const</span> std::set&lt;itype_id&gt; blacklist = { itype_sheet_cotton, itype_leather, itype_fur };</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">        <span class='keyword'>for</span>( item_components::type_vector_pair &amp;tvp : shield-&gt;components ) {</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">            <span class='keyword'>if</span>( blacklist.count( tvp.first ) &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">            <span class='keyword'>for</span>( item &amp;comp : tvp.second ) {</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">                <span class='keyword'>if</span>( weak_chip &gt; comp.chip_resistance() ) {</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">                    weak_chip = comp.chip_resistance();</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">                    weak_comp = comp.typeId();</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">                <span class='keyword'>if</span>( comp.volume() &gt; big_vol ) {</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">                    big_vol = comp.volume();</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">                    big_comp = comp.typeId();</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">        material_factor = ( weak_chip &lt; <span class='macro'>INT_MAX<span class='macro_popup'>2147483647</span></span> ? weak_chip : shield-&gt;chip_resistance() ) / fragile_factor;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">        material_factor = shield-&gt;chip_resistance();</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    <span class='keyword'>int</span> damage_chance = <span class='keyword'>static_cast</span>&lt;<span class='keyword'>int</span>&gt;( stat_factor * material_factor / wear_multiplier );</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    <span class='comment'>// DURABLE_MELEE items are made to hit stuff and they do it well, so they're considered to be a lot tougher</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    <span class='comment'>// than other weapons made of the same materials.</span></td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    <span class='keyword'>if</span>( shield-&gt;has_flag( flag_DURABLE_MELEE ) ) {</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">        damage_chance *= 4;</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">    <span class='keyword'>if</span>( damage_chance &gt; 0 &amp;&amp; !one_in( damage_chance ) ) {</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    std::string str = shield-&gt;tname(); <span class='comment'>// save name before we apply damage</span></td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='keyword'>if</span>( !shield-&gt;inc_damage() ) {</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">        add_msg_player_or_npc( m_bad, <span class='macro'>_( <span class='string_literal'>"Your %s is damaged by the force of the blow!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your %s is damaged by the force of the blow!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">                               <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt;'s %s is damaged by the force of the blow!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt;'s %s is damaged by the force of the blow!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">                               str );</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    <span class='comment'>// Dump its contents on the ground</span></td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">    <span class='comment'>// Destroy irremovable mods, if any</span></td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    <span class='keyword'>for</span>( item *mod : shield-&gt;gunmods() ) {</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">        <span class='keyword'>if</span>( mod-&gt;is_irremovable() ) {</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">            remove_item( *mod );</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    <span class='comment'>// Preserve item temporarily for component breakdown</span></td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    item temp = *shield;</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    shield-&gt;get_contents().spill_contents( pos() );</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    shield.remove_item();</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    <span class='comment'>// Breakdown fragile weapons into components</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">    <span class='keyword'>if</span>( temp.has_flag( flag_FRAGILE_MELEE ) &amp;&amp; !temp.components.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">        add_msg_player_or_npc( m_bad, <span class='macro'>_( <span class='string_literal'>"Your %s breaks apart!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your %s breaks apart!" ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">                               <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt;'s %s breaks apart!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt;'s %s breaks apart!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">                               str );</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">        <span class='keyword'>for</span>( item_components::type_vector_pair &amp;tvp : temp.components ) {</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">            <span class='keyword'>for</span>( item &amp;comp : tvp.second ) {</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">                <span class='keyword'>int</span> break_chance = comp.typeId() == weak_comp ? 2 : 8;</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">                <span class='keyword'>if</span>( one_in( break_chance ) ) {</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">                    add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"The %s is destroyed!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s is destroyed!" ) ) )</span></span>, comp.tname() );</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">                <span class='keyword'>if</span>( comp.typeId() == big_comp &amp;&amp; !has_wield_conflicts( comp ) ) {</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">                    wield( comp );</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">                    get_map().add_item_or_charges( pos(), comp );</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">        add_msg_player_or_npc( m_bad, <span class='macro'>_( <span class='string_literal'>"Your %s is destroyed by the blow!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your %s is destroyed by the blow!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">                               <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt;'s %s is destroyed by the blow!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt;'s %s is destroyed by the blow!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">                               str );</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">    <span class='keyword'>if</span>( is_using_bionic_weapon() &amp;&amp; temp.has_flag( flag_NO_UNWIELD ) ) {</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">        <span class='keyword'>if</span>( std::optional&lt;bionic *&gt; bio_opt = find_bionic_by_uid( get_weapon_bionic_uid() ) ) {</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">            bionic &amp;bio = **bio_opt;</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">            <span class='keyword'>if</span>( bio.get_weapon().typeId() == temp.typeId() ) {</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">                weapon_bionic_uid = 0;</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">                bio.set_weapon( item() );</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">                force_bionic_deactivation( bio );</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line"><span class='keyword'>float</span> Character::get_hit_weapon( <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    <span class='comment'>/** @EFFECT_UNARMED improves hit chance for unarmed weapons */</span></td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    <span class='comment'>/** @EFFECT_BASHING improves hit chance for bashing weapons */</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">    <span class='comment'>/** @EFFECT_CUTTING improves hit chance for cutting weapons */</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='comment'>/** @EFFECT_STABBING improves hit chance for piercing weapons */</span></td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    <span class='keyword'>float</span> skill = get_skill_level( weap.melee_skill() );</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">    <span class='comment'>// CQB bionic acts as a lower bound providing item uses a weapon skill</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">    <span class='keyword'>if</span>( skill &lt; BIO_CQB_LEVEL &amp;&amp; has_active_bionic( bio_cqb ) ) {</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">        skill = BIO_CQB_LEVEL;</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE improves hit chance for all items (including non-weapons) */</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    <span class='keyword'>return</span> ( skill / 3.0f ) + ( get_skill_level( skill_melee ) / 2.0f ) + weap.type-&gt;m_to_hit;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"><span class='keyword'>float</span> Character::get_melee_hit_base() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    <span class='keyword'>float</span> hit_weapon = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    item_location cur_weapon = used_weapon();</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">    item cur_weap = cur_weapon ? *cur_weapon : null_item_reference();</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    hit_weapon = get_hit_weapon( cur_weap );</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">    <span class='comment'>// Character::get_hit_base includes stat calculations already</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">    <span class='keyword'>return</span> Character::get_hit_base() + hit_weapon + mabuff_tohit_bonus();</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line"><span class='keyword'>float</span> Character::hit_roll() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">    <span class='comment'>// Dexterity, skills, weapon and martial arts</span></td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">    <span class='keyword'>float</span> hit = get_melee_hit_base();</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    <span class='comment'>// Farsightedness makes us hit worse</span></td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">    <span class='keyword'>if</span>( has_flag( json_flag_HYPEROPIC ) &amp;&amp; !worn_with_flag( flag_FIX_FARSIGHT ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">        !has_effect( effect_contacts ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">        !has_effect( effect_transition_contacts ) ) {</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">        hit -= 2.0f;</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    <span class='comment'>// Difficult to land a hit while prone</span></td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    <span class='comment'>// Quadrupeds don't mind crouching as long as they're unarmed</span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    <span class='comment'>// Tentacles and goo-limbs care even less</span></td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    item_location cur_weapon = used_weapon();</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    item cur_weap = cur_weapon ? *cur_weapon : null_item_reference();</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    <span class='keyword'>if</span>( is_on_ground() ) {</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">        <span class='keyword'>if</span>( has_flag( json_flag_PSEUDOPOD_GRASP ) ) {</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">            hit -= 2.0f;</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">            hit -= 8.0f;</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( is_crouching() &amp;&amp; ( !has_flag( json_flag_PSEUDOPOD_GRASP ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">                                   ( !has_effect( effect_natural_stance ) ) ) ) {</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">        hit -= 2.0f;</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    hit *= get_modifier( character_modifier_melee_attack_roll_mod );</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">    <span class='keyword'>return</span> melee::melee_hit_range( hit );</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line"><span class='keyword'>bool</span> Character::can_attack_high() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    <span class='keyword'>return</span> !is_on_ground();</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line"><span class='keyword'>void</span> Character::add_miss_reason( <span class='keyword'>const</span> std::string &amp;reason, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> weight )</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    melee_miss_reasons.add( reason, weight );</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"><span class='keyword'>void</span> Character::clear_miss_reasons()</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    melee_miss_reasons.clear();</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">std::string Character::get_miss_reason()</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">    <span class='comment'>// everything that lowers accuracy in player::hit_roll()</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">    <span class='comment'>// adding it in hit_roll() might not be safe if it's called multiple times</span></td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    <span class='comment'>// in one turn</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">    add_miss_reason(</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">        <span class='macro'>_( <span class='string_literal'>"Your torso encumbrance throws you off-balance."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your torso encumbrance throws you off-balance."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">        roll_remainder( avg_encumb_of_limb_type( body_part_type::type::torso ) / 10.0 ) );</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> farsightedness = 2 * ( has_flag( json_flag_HYPEROPIC ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">                                     !worn_with_flag( flag_FIX_FARSIGHT ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">                                     !has_effect( effect_contacts ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">                                     !has_effect( effect_transition_contacts ) );</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">    add_miss_reason(</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">        <span class='macro'>_( <span class='string_literal'>"You can't hit reliably due to your farsightedness."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You can't hit reliably due to your farsightedness."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">        farsightedness );</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    add_miss_reason(</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">        <span class='macro'>_( <span class='string_literal'>"You struggle to hit reliably while on the ground."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You struggle to hit reliably while on the ground."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">        3 * is_on_ground() );</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    <span class='keyword'>const</span> std::string *<span class='keyword'>const</span> reason = melee_miss_reasons.pick();</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='keyword'>if</span>( reason == <span class='keyword'>nullptr</span> ) {</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">        <span class='keyword'>return</span> std::string();</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    <span class='keyword'>return</span> *reason;</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line"><span class='keyword'>void</span> Character::roll_all_damage( <span class='keyword'>bool</span> crit, damage_instance &amp;di, <span class='keyword'>bool</span> average,</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">                                 <span class='keyword'>const</span> item &amp;weap, <span class='keyword'>const</span> std::string &amp;attack_vector, <span class='keyword'>const</span> Creature *target,</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">                                 <span class='keyword'>const</span> bodypart_id &amp;bp ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">    <span class='keyword'>float</span> crit_mod = 1.f;</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    <span class='keyword'>if</span>( target != <span class='keyword'>nullptr</span> ) {</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">        crit_mod = target-&gt;get_crit_factor( bp );</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">        roll_damage( dt.id, crit, di, average, weap, attack_vector, crit_mod );</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> melee_train( Character &amp;you, <span class='keyword'>int</span> lo, <span class='keyword'>int</span> hi, <span class='keyword'>const</span> item &amp;weap,</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">                         <span class='keyword'>const</span> std::string &amp;attack_vector )</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    you.practice( skill_melee, std::ceil( rng( lo, hi ) / 2.0 ), hi );</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">    <span class='keyword'>float</span> total = 0.f;</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    <span class='comment'>// allocate XP proportional to damage stats</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    <span class='comment'>// Pure unarmed needs a special case because it has 0 weapon damage</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    std::map&lt;damage_type_id, <span class='keyword'>int</span>&gt; dmg_vals;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">        <span class='keyword'>if</span>( !dt.melee_only ) {</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">        <span class='keyword'>int</span> dmg = weap.damage_melee( dt.id );</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">        <span class='keyword'>if</span>( weap.is_null() &amp;&amp; dt.id == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">            dmg++;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">        dmg_vals[dt.id] = dmg;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">        total += dmg;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    total = std::max( total, 1.f );</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    <span class='comment'>// Unarmed may deal cut, stab, and bash damage depending on the weapon</span></td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    <span class='keyword'>if</span>( attack_vector != <span class='string_literal'>"WEAPON"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">        you.practice( skill_unarmed, std::ceil( 1 * rng( lo, hi ) ), hi );</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> std::pair&lt;<span class='keyword'>const</span> damage_type_id, <span class='keyword'>int</span>&gt; &amp;dmg : dmg_vals ) {</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">            <span class='keyword'>if</span>( !dmg.first-&gt;skill.is_null() ) {</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">                you.practice( dmg.first-&gt;skill, std::ceil( dmg.second / total * rng( lo, hi ) ), hi );</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"><span class='keyword'>bool</span> Character::melee_attack( Creature &amp;t, <span class='keyword'>bool</span> allow_special )</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> matec_id no_technique_id( <span class='string_literal'>""</span> );</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">    <span class='keyword'>return</span> melee_attack( t, allow_special, no_technique_id );</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">damage_instance Creature::modify_damage_dealt_with_enchantments( <span class='keyword'>const</span> damage_instance &amp;dam ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='keyword'>return</span> dam;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">damage_instance Character::modify_damage_dealt_with_enchantments( <span class='keyword'>const</span> damage_instance &amp;dam ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">    damage_instance modified;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">    std::vector&lt;damage_type_id&gt; types_used;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">    <span class='keyword'>auto</span> dt_to_ench_dt = []( <span class='keyword'>const</span> damage_type_id &amp; dt ) {</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">        <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"acid"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "acid" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "acid" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_ACID;</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"bash"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "bash" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "bash" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_BASH;</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"biological"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "biological"<br> ) ))&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "biological" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_BIO;</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"bullet"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "bullet" )<br> ))&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "bullet" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_BULLET;</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"cold"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "cold" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "cold" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_COLD;</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"cut"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "cut" ) ))<br>&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "cut" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_CUT;</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"electric"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "electric"<br> ) ))&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "electric" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_ELEC;</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"heat"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "heat" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "heat" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_HEAT;</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"stab"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "stab" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "stab" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_STAB;</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"pure"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "pure" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "pure" ) ); return _cached_expr; })())</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">            <span class='keyword'>return</span> enchant_vals::mod::ITEM_DAMAGE_PURE;</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">        <span class='keyword'>return</span> enchant_vals::mod::NUM_MOD;</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">    <span class='keyword'>auto</span> modify_damage_type = [&amp;]( <span class='keyword'>const</span> damage_type_id &amp; dt, <span class='keyword'>double</span> val ) {</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">        <span class='keyword'>const</span> enchant_vals::mod mod_type = dt_to_ench_dt( dt );</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">        <span class='keyword'>if</span>( mod_type == enchant_vals::mod::NUM_MOD ) {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">            <span class='keyword'>return</span> val;</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">            val = enchantment_cache-&gt;modify_value( dt_to_ench_dt( dt ), val );</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">        <span class='keyword'>return</span> enchantment_cache-&gt;modify_value( enchant_vals::mod::MELEE_DAMAGE, val );</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    <span class='keyword'>for</span>( damage_unit du : dam ) {</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">        du.amount = modify_damage_type( du.type, du.amount );</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        modified.add( du );</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">        types_used.emplace_back( du.type );</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">        <span class='keyword'>if</span>( std::find( types_used.begin(), types_used.end(), dt.id ) != types_used.end() ) {</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">        modified.add_damage( dt.id, modify_damage_type( dt.id, 0.0f ) );</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        modified.add_damage( dt.id, enchantment_cache-&gt;modify_value( enchant_vals::mod::MELEE_DAMAGE,</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">                             0.0f ) );</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    <span class='keyword'>return</span> modified;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line"><span class='comment'>// Melee calculation is in parts. This sets up the attack, then in deal_melee_attack,</span></td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line"><span class='comment'>// we calculate if we would hit. In Creature::deal_melee_hit, we calculate if the target dodges.</span></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line"><span class='keyword'>bool</span> Character::melee_attack( Creature &amp;t, <span class='keyword'>bool</span> allow_special, <span class='keyword'>const</span> matec_id &amp;force_technique,</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">                              <span class='keyword'>bool</span> allow_unarmed, <span class='keyword'>int</span> forced_movecost )</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='keyword'>if</span>( has_effect( effect_incorporeal ) ) {</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">        add_msg_if_player( m_info, <span class='macro'>_( <span class='string_literal'>"You lack the substance to affect anything."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You lack the substance to affect anything."<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    <span class='keyword'>if</span>( !is_adjacent( &amp;t, <span class='keyword'>true</span> ) ) {</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">    <span class='comment'>// Max out recoil &amp; reset aim point</span></td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">    recoil = MAX_RECOIL;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    last_target_pos = std::nullopt;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    <span class='keyword'>return</span> melee_attack_abstract( t, allow_special, force_technique, allow_unarmed, forced_movecost );</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line"><span class='keyword'>bool</span> Character::melee_attack_abstract( Creature &amp;t, <span class='keyword'>bool</span> allow_special,</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">                                       <span class='keyword'>const</span> matec_id &amp;force_technique,</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">                                       <span class='keyword'>bool</span> allow_unarmed, <span class='keyword'>int</span> forced_movecost )</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    <span id="start161"><span class='keyword'>if</span></span>( <span id="start160"><span class="mrange"><span id="end161">!</span></span>enough_working_legs()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path1" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">1</div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path2" title="Next event (2)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path2" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">2</div></td><td><div class="PathNav"><a href="#Path1" title="Previous event (1)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path3" title="Next event (3)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">        <span class='keyword'>if</span>( !movement_mode_is( move_mode_prone ) ) {</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">            add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"Your broken legs cannot hold you and you fall down."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your broken legs cannot hold you and you fall down."<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">            set_movement_mode( move_mode_prone );</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">    <span id="start159"><span id="end160">melee</span></span>::melee_stats.attack_count += 1;</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">    <span class='keyword'>int</span> hit_spread = t.deal_melee_attack( <span class='keyword'>this</span>, hit_roll() );</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">    <span id="start158"><span id="end159"><span class='keyword'>if</span></span></span>( <span id="start157"><span class="mrange"><span id="end158">!</span></span>t.is_avatar()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path3" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">3</div></td><td><div class="PathNav"><a href="#Path2" title="Previous event (2)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path4" title="Next event (4)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path4" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">4</div></td><td><div class="PathNav"><a href="#Path3" title="Previous event (3)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path5" title="Next event (5)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">        <span class='comment'>// TODO: Per-NPC tracking? Right now monster hit by either npc or player will draw aggro...</span></td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">        t.add_effect( effect_hit_by_player, 10_minutes ); <span class='comment'>// Flag as attacked by us for AI</span></td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">    <span id="start156"><span id="end157"><span class='keyword'>if</span></span></span>( <span id="start155"><span class="mrange"><span id="end156">is_mounted</span></span>()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path5" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">5</div></td><td><div class="PathNav"><a href="#Path4" title="Previous event (4)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path6" title="Next event (6)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path6" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">6</div></td><td><div class="PathNav"><a href="#Path5" title="Previous event (5)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path7" title="Next event (7)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">        <span class='keyword'>auto</span> *mons = mounted_creature.get();</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">        <span class='keyword'>if</span>( mons-&gt;has_flag( mon_flag_RIDEABLE_MECH ) ) {</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">            <span class='keyword'>if</span>( !mons-&gt;check_mech_powered() ) {</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">                add_msg( m_bad, <span class='macro'>_( <span class='string_literal'>"The %s has dead batteries and will not move its arms."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s has dead batteries and will not move its arms."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">                         mons-&gt;get_name() );</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">                <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">            <span class='keyword'>if</span>( mons-&gt;type-&gt;has_special_attack( <span class='string_literal'>"SMASH"</span> ) &amp;&amp; one_in( 3 ) ) {</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">                add_msg( m_info, <span class='macro'>_( <span class='string_literal'>"The %s hisses as its hydraulic arm pumps forward!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s hisses as its hydraulic arm pumps forward!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">                         mons-&gt;get_name() );</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">                mattack::smash_specific( mons, &amp;t );</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">                mons-&gt;use_mech_power( 2_kJ );</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">                mons-&gt;melee_attack( t );</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">            mod_moves( forced_movecost &gt;= 0 ? -forced_movecost : -mons-&gt;type-&gt;attack_cost );</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">    <span class='comment'>// Fighting is hard work</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    <span id="start152"><span id="end153"><span id="start154"><span id="end155">set_activity_level</span></span></span></span>( <span id="start153"><span id="end154">EXTRA_EXERCISE</span></span> );</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">    <span id="start146"><span id="end147"><span id="start148"><span id="end149"><span id="start151"><span id="end152">item_location</span></span></span></span></span></span> cur_weapon = <span id="end148"><span id="start149"><span id="start150"><span class="mrange"><span id="end151">allow_unarmed</span></span></span></span></span> ? used_weapon() : <span id="start147"><span id="end150">get_wielded_item</span></span>();</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path7" class="msg msgEvent" style="margin-left:32ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">7</div></td><td><div class="PathNav"><a href="#Path6" title="Previous event (6)">&#x2190;</a></div></td><td>Assuming 'allow_unarmed' is false</td><td><div class="PathNav"><a href="#Path8" title="Next event (8)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path8" class="msg msgControl" style="margin-left:32ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">8</div></td><td><div class="PathNav"><a href="#Path7" title="Previous event (7)">&#x2190;</a></div></td><td>'?' condition is false</td><td><div class="PathNav"><a href="#Path9" title="Next event (9)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">    <span id="start140"><span id="end141"><span id="start142"><span id="end143"><span id="start145"><span id="end146">item</span></span></span></span></span></span> cur_weap = <span id="end142"><span id="start143"><span id="start144"><span class="mrange"><span id="end145">cur_weapon</span></span></span></span></span> ? *cur_weapon : <span id="start141"><span id="end144">null_item_reference</span></span>();</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path9" class="msg msgEvent" style="margin-left:21ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">9</div></td><td><div class="PathNav"><a href="#Path8" title="Previous event (8)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path10" title="Next event (10)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path10" class="msg msgControl" style="margin-left:21ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">10</div></td><td><div class="PathNav"><a href="#Path9" title="Previous event (9)">&#x2190;</a></div></td><td>'?' condition is false</td><td><div class="PathNav"><a href="#Path11" title="Next event (11)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">    <span class='keyword'>int</span> move_cost = attack_speed( cur_weap );</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">    <span id="start139"><span id="end140"><span class='keyword'>if</span></span></span>( <span id="start138"><span class="mrange"><span id="end139">cur_weap</span></span>.attack_time( *<span class='keyword'>this</span> ) &gt; move_cost * 20</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path11" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">11</div></td><td><div class="PathNav"><a href="#Path10" title="Previous event (10)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path12" title="Next event (12)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">        add_msg( m_bad, <span class='macro'>_( <span class='string_literal'>"This weapon is too unwieldy to attack with!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "This weapon is too unwieldy to attack with!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">    <span id="start137"><span id="end138"><span class='keyword'>if</span></span></span>( <span id="start136"><span class="mrange"><span id="end137">is_avatar</span></span>()</span> &amp;&amp; move_cost &gt; 1000 &amp;&amp; calendar::turn &gt; melee_warning_turn ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path12" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">12</div></td><td><div class="PathNav"><a href="#Path11" title="Previous event (11)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path13" title="Next event (13)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">        <span class='keyword'>const</span> std::string &amp;action = query_popup()</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">                                    .context( <span class='string_literal'>"CANCEL_ACTIVITY_OR_IGNORE_QUERY"</span> )</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">                                    .message( <span class='macro'>_( <span class='string_literal'>"&lt;color_light_red&gt;Attacking with your %1$s will take a long time.  "<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;color_light_red&gt;Attacking with your %1$s will take a long time.  "<br> "Are you sure you want to continue?&lt;/color&gt;" ) ) )</span></span></span></td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">                                              <span class='string_literal'><span class='macro'>"Are you sure you want to continue?&lt;/color&gt;"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;color_light_red&gt;Attacking with your %1$s will take a long time.  "<br> "Are you sure you want to continue?&lt;/color&gt;" ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">                                              cur_weap.display_name() )</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">                                    .option( <span class='string_literal'>"YES"</span> )</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">                                    .option( <span class='string_literal'>"NO"</span> )</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">                                    .option( <span class='string_literal'>"IGNORE"</span> )</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">                                    .query()</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">                                    .action;</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">        <span class='keyword'>if</span>( action == <span class='string_literal'>"NO"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">        <span class='keyword'>if</span>( action == <span class='string_literal'>"IGNORE"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">            <span class='keyword'>if</span>( melee_warning_turn == calendar::turn_zero || melee_warning_turn &lt;= calendar::turn ) {</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">                melee_warning_turn = calendar::turn + 50_turns;</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    <span id="start135"><span id="end136"><span class='keyword'>const</span></span></span> <span class='keyword'>bool</span> hits = <span class="mrange">hit_spread &gt;= 0</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path13" class="msg msgEvent" style="margin-left:23ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">13</div></td><td><div class="PathNav"><a href="#Path12" title="Previous event (12)">&#x2190;</a></div></td><td>Assuming 'hit_spread' is &gt;= 0</td><td><div class="PathNav"><a href="#Path14" title="Next event (14)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">    <span id="start134"><span id="end135"><span class='keyword'>if</span></span></span>( monster *<span id="start133"><span class="mrange"><span id="end134">m</span></span></span> = t.as_monster() ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path14" class="msg msgEvent" style="margin-left:18ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">14</div></td><td><div class="PathNav"><a href="#Path13" title="Previous event (13)">&#x2190;</a></div></td><td>Assuming 'm' is non-null</td><td><div class="PathNav"><a href="#Path15" title="Next event (15)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path15" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">15</div></td><td><div class="PathNav"><a href="#Path14" title="Previous event (14)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path16" title="Next event (16)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">        <span id="start130"><span id="end131"><span id="start132"><span id="end133">cata</span></span></span></span>::event e = <span id="start131"><span id="end132">cata</span></span>::event::make&lt;event_type::character_melee_attacks_monster&gt;( getID(),</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">                        cur_weap.typeId(), hits, m-&gt;type-&gt;id );</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">        <span id="start129"><span id="end130">get_event_bus</span></span>().send_with_talker( <span class='keyword'>this</span>, m, e );</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    <span id="start128"><span id="end129">}</span></span> <span class='keyword'>else</span> <span class='keyword'>if</span>( Character *c = t.as_character() ) {</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">        cata::event e = cata::event::make&lt;event_type::character_melee_attacks_character&gt;( getID(),</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">                        cur_weap.typeId(), hits, c-&gt;getID(), c-&gt;get_name() );</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">        get_event_bus().send_with_talker( <span class='keyword'>this</span>, c, e );</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">    <span id="start122"><span id="end123"><span id="start124"><span id="end125"><span id="start127"><span id="end128"><span class='keyword'>const</span></span></span></span></span></span></span> <span class='keyword'>int</span> skill_training_cap = <span id="end124"><span id="start125"><span id="start126"><span class="mrange"><span id="end127">t</span></span></span></span>.is_monster()</span> ? <span id="start123"><span id="end126">t</span></span>.as_monster()-&gt;type-&gt;melee_training_cap :</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path16" class="msg msgEvent" style="margin-left:36ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">16</div></td><td><div class="PathNav"><a href="#Path15" title="Previous event (15)">&#x2190;</a></div></td><td>Assuming the condition is true</td><td><div class="PathNav"><a href="#Path17" title="Next event (17)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path17" class="msg msgControl" style="margin-left:36ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">17</div></td><td><div class="PathNav"><a href="#Path16" title="Previous event (16)">&#x2190;</a></div></td><td>'?' condition is true</td><td><div class="PathNav"><a href="#Path18" title="Next event (18)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">                                   MAX_SKILL;</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">    Character &amp;player_character = get_player_character();</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">    <span id="start121"><span id="end122"><span class='keyword'>if</span></span></span>( !<span id="start120"><span id="end121"><span class='variable'>hits<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>17.1</div></td><td>'hits' is true</td></tr></tbody></table></span></span></span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path18" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">18</div></td><td><div class="PathNav"><a href="#Path17" title="Previous event (17)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path19" title="Next event (19)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">        <span class='keyword'>int</span> stumble_pen = stumble( *<span class='keyword'>this</span>, cur_weapon );</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">        sfx::generate_melee_sound( pos(), t.pos(), <span class='keyword'>false</span>, <span class='keyword'>false</span> );</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">        <span class='keyword'>const</span> ma_technique miss_recovery = martial_arts_data-&gt;get_miss_recovery( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">        <span class='keyword'>if</span>( is_avatar() ) { <span class='comment'>// Only display messages if this is the player</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">            <span class='keyword'>if</span>( one_in( 2 ) ) {</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">                <span class='keyword'>const</span> std::string reason_for_miss = get_miss_reason();</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">                <span class='keyword'>if</span>( !reason_for_miss.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">                    add_msg( reason_for_miss );</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">            <span class='keyword'>if</span>( miss_recovery.id != tec_none ) {</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">                add_msg( miss_recovery.avatar_message.translated(), t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span>( stumble_pen &gt;= 60 ) {</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">                add_msg( m_bad, <span class='macro'>_( <span class='string_literal'>"You miss and stumble with the momentum."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You miss and stumble with the momentum."<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span>( stumble_pen &gt;= 10 ) {</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">                add_msg( <span class='macro'>_( <span class='string_literal'>"You swing wildly and miss."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You swing wildly and miss." )<br> ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">                add_msg( <span class='macro'>_( <span class='string_literal'>"You miss."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You miss." ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( player_character.sees( *<span class='keyword'>this</span> ) ) {</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">            <span class='keyword'>if</span>( miss_recovery.id != tec_none ) {</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">                add_msg_if_npc( miss_recovery.npc_message.translated(), t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span>( stumble_pen &gt;= 60 ) {</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">                add_msg( <span class='macro'>_( <span class='string_literal'>"%s misses and stumbles with the momentum."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s misses and stumbles with the momentum."<br> ) ) )</span></span>, get_name() );</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span>( stumble_pen &gt;= 10 ) {</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">                add_msg( <span class='macro'>_( <span class='string_literal'>"%s swings wildly and misses."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s swings wildly and misses."<br> ) ) )</span></span>, get_name() );</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">                add_msg( <span class='macro'>_( <span class='string_literal'>"%s misses."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s misses." ) ) )</span></span>, get_name() );</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">        <span class='comment'>// Practice melee and relevant weapon skill (if any) except when using CQB bionic</span></td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">        <span class='keyword'>if</span>( !has_active_bionic( bio_cqb ) &amp;&amp; !t.is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">            std::string attack_vector = cur_weapon ? <span class='string_literal'>"WEAPON"</span> : <span class='string_literal'>"HAND"</span>;</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">            melee_train( *<span class='keyword'>this</span>, 2, std::min( 5, skill_training_cap ), cur_weap, attack_vector );</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">        <span class='comment'>// Cap stumble penalty, heavy weapons are quite weak already</span></td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">        move_cost += std::min( 60, stumble_pen );</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">        <span class='keyword'>if</span>( miss_recovery.id != tec_none ) {</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">            move_cost /= 2;</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">        <span class='comment'>// trigger martial arts on-miss effects</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">        martial_arts_data-&gt;ma_onmiss_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">        <span id="start119"><span id="end120">melee</span></span>::melee_stats.hit_count += 1;</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">        <span class='comment'>// Remember if we see the monster at start - it may change</span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>bool</span> seen = player_character.sees( t );</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">        <span class='comment'>// Start of attacks.</span></td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>bool</span> critical_hit = scored_crit( t.dodge_roll(), cur_weap );</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">        <span id="start118"><span id="end119"><span class='keyword'>if</span></span></span>( <span id="start117"><span class="mrange"><span id="end118">critical_hit</span></span></span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path19" class="msg msgEvent" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">19</div></td><td><div class="PathNav"><a href="#Path18" title="Previous event (18)">&#x2190;</a></div></td><td>Assuming 'critical_hit' is false</td><td><div class="PathNav"><a href="#Path20" title="Next event (20)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path20" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">20</div></td><td><div class="PathNav"><a href="#Path19" title="Previous event (19)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path21" title="Next event (21)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">            melee::melee_stats.actual_crit_count += 1;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">        <span class='comment'>// select target body part</span></td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">        <span id="start114"><span id="end115"><span id="start116"><span id="end117"><span class='keyword'>const</span></span></span></span></span> bodypart_id &amp;target_bp = <span id="start115"><span id="end116">t</span></span>.select_body_part( -1, -1, can_attack_high(),</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">                                       hit_spread );</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">        <span id="start113"><span id="end114"><span class='keyword'>const</span></span></span> <span class='keyword'>bool</span> has_force_technique = <span class="mrange">!force_technique.str().empty()</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path21" class="msg msgEvent" style="margin-left:42ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">21</div></td><td><div class="PathNav"><a href="#Path20" title="Previous event (20)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path22" title="Next event (22)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">        <span class='comment'>// Pick one or more special attacks</span></td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">        matec_id technique_id;</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">        <span id="start112"><span id="end113"><span class='keyword'>if</span></span></span>( <span id="start111"><span id="end112"><span class='variable'>has_force_technique<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>21.1</div></td><td>'has_force_technique' is false</td></tr></tbody></table></span></span></span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path22" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">22</div></td><td><div class="PathNav"><a href="#Path21" title="Previous event (21)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path23" title="Next event (23)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">            technique_id = force_technique;</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">        } <span class='keyword'>else</span> <span id="start110"><span id="end111"><span class='keyword'>if</span></span></span>( <span id="start109"><span class="mrange"><span id="end110">allow_special</span></span></span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path23" class="msg msgEvent" style="margin-left:20ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">23</div></td><td><div class="PathNav"><a href="#Path22" title="Previous event (22)">&#x2190;</a></div></td><td>Assuming 'allow_special' is false</td><td><div class="PathNav"><a href="#Path24" title="Next event (24)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path24" class="msg msgControl" style="margin-left:16ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">24</div></td><td><div class="PathNav"><a href="#Path23" title="Previous event (23)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path25" title="Next event (25)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">            technique_id = pick_technique( t, cur_weapon, critical_hit, <span class='keyword'>false</span>, <span class='keyword'>false</span> );</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">            <span class='keyword'>if</span>( critical_hit &amp;&amp; technique_id.obj().crit_tec_id != tec_none ) {</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">                technique_id = technique_id.obj().crit_tec_id;</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">            <span id="start106"><span id="end107"><span id="start108"><span id="end109">technique_id</span></span></span></span> <span id="start107"><span id="end108">=</span></span> tec_none;</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">        <span id="start105"><span id="end106">std</span></span>::string attack_vector;</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">        <span class='comment'>// Failsafe for tec_none</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">        <span id="start104"><span id="end105"><span class='keyword'>if</span></span></span>( technique_id == tec_none ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path25" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">25</div></td><td><div class="PathNav"><a href="#Path24" title="Previous event (24)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path26" title="Next event (26)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">            <span id="start101"><span id="end102"><span id="start103"><span id="end104">attack_vector</span></span></span></span> <span id="end103">=</span> <span id="start102"><span class="mrange">cur_weapon</span></span> ? <span class='string_literal'>"WEAPON"</span> : <span class='string_literal'>"HAND"</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path26" class="msg msgEvent" style="margin-left:29ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">26</div></td><td><div class="PathNav"><a href="#Path25" title="Previous event (25)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path27" title="Next event (27)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path27" class="msg msgControl" style="margin-left:29ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">27</div></td><td><div class="PathNav"><a href="#Path26" title="Previous event (26)">&#x2190;</a></div></td><td>'?' condition is false</td><td><div class="PathNav"><a href="#Path28" title="Next event (28)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">            attack_vector = martial_arts_data-&gt;get_valid_attack_vector( *<span class='keyword'>this</span>,</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">                            technique_id.obj().attack_vectors );</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">            <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"NONE"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">                std::vector&lt;std::string&gt; shuffled_attack_vectors = technique_id.obj().attack_vectors_random;</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">                std::shuffle( shuffled_attack_vectors.begin(), shuffled_attack_vectors.end(), rng_get_engine() );</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">                attack_vector = martial_arts_data-&gt;get_valid_attack_vector( *<span class='keyword'>this</span>, shuffled_attack_vectors );</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">        <span class='comment'>// If no weapon is selected, use highest layer of clothing for attack vector instead.</span></td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">        <span id="start100"><span id="end101"><span class='keyword'>if</span></span></span>( attack_vector != <span class='string_literal'>"WEAPON"</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path28" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">28</div></td><td><div class="PathNav"><a href="#Path27" title="Previous event (27)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path29" title="Next event (29)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">            <span class='comment'>// todo: simplify this by using item_location everywhere</span></td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">            <span class='comment'>// so only cur_weapon = worn.current_unarmed_weapon remains</span></td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">            <span id="start97"><span id="end98"><span id="start99"><span id="end100">item</span></span></span></span> *worn_weap = <span id="start98"><span id="end99">worn</span></span>.current_unarmed_weapon( attack_vector );</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">            <span id="start91"><span id="end92"><span id="start93"><span id="end94"><span id="start96"><span id="end97">cur_weapon</span></span></span></span></span></span> = <span id="start90"><span id="end91"><span id="end93"><span id="start94"><span id="start95"><span class="mrange"><span id="end96">worn_weap</span></span></span></span></span></span></span> ? item_location( *<span class='keyword'>this</span>, worn_weap ) : <span id="start89"><span id="end90"><span id="start92"><span id="end95">item_location</span></span></span></span>(<span id="start88"><span id="end89">)</span></span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path29" class="msg msgEvent" style="margin-left:26ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">29</div></td><td><div class="PathNav"><a href="#Path28" title="Previous event (28)">&#x2190;</a></div></td><td>Assuming 'worn_weap' is null</td><td><div class="PathNav"><a href="#Path30" title="Next event (30)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path30" class="msg msgControl" style="margin-left:26ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">30</div></td><td><div class="PathNav"><a href="#Path29" title="Previous event (29)">&#x2190;</a></div></td><td>'?' condition is false</td><td><div class="PathNav"><a href="#Path31" title="Next event (31)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">            <span id="start82"><span id="end83"><span id="start84"><span id="end85"><span id="start87"><span id="end88">cur_weap</span></span></span></span></span></span> = <span id="end84"><span id="start85"><span id="start86"><span class="mrange"><span id="end87">cur_weapon</span></span></span></span></span> ? *cur_weapon : <span id="start83"><span id="end86">null_item_reference</span></span>();</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path31" class="msg msgEvent" style="margin-left:24ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">31</div></td><td><div class="PathNav"><a href="#Path30" title="Previous event (30)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path32" title="Next event (32)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path32" class="msg msgControl" style="margin-left:24ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">32</div></td><td><div class="PathNav"><a href="#Path31" title="Previous event (31)">&#x2190;</a></div></td><td>'?' condition is false</td><td><div class="PathNav"><a href="#Path33" title="Next event (33)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">        <span id="start81"><span id="end82">damage_instance</span></span> d;</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">        roll_all_damage( critical_hit, d, <span class='keyword'>false</span>, cur_weap, attack_vector, &amp;t, target_bp );</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">        <span class='comment'>// your hits are not going to hurt very much if you can't use martial arts due to broken limbs</span></td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">        <span id="start80"><span id="end81"><span class='keyword'>if</span></span></span>( <span id="start79"><span id="end80">attack_vector</span></span> == <span class='string_literal'>"HAND"</span> &amp;&amp; get_working_arm_count() &lt; 1 ) {</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">            technique_id = tec_none;</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">            d.mult_damage( 0.1 );</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">            add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"Your arms are too damaged or encumbered to fight effectively!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your arms are too damaged or encumbered to fight effectively!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">        <span class='comment'>// polearms and pikes (but not spears) do less damage to adjacent targets</span></td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">        <span class='comment'>// In the case of a weapon like a glaive or a naginata, the wielder</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">        <span class='comment'>// lacks the room to build up momentum on a slash.</span></td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">        <span class='comment'>// In the case of a pike, the mass of the pole behind the wielder</span></td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">        <span class='comment'>// should they choose to employ it up close will unbalance them.</span></td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">        <span id="start78"><span id="end79"><span class='keyword'>if</span></span></span>( <span id="start77"><span class="mrange"><span id="end78">cur_weap</span></span>.reach_range( *<span class='keyword'>this</span> ) &gt; 1</span> &amp;&amp; !reach_attacking &amp;&amp;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path33" class="msg msgEvent" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">33</div></td><td><div class="PathNav"><a href="#Path32" title="Previous event (32)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path34" title="Next event (34)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">            cur_weap.has_flag( flag_POLEARM ) ) {</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">            d.mult_damage( 0.7 );</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">        <span class='comment'>// being prone affects how much leverage you can use to deal damage</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">        <span class='comment'>// quadrupeds don't mind as much, tentacles and goo-limbs even less</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">        <span id="start76"><span id="end77"><span class='keyword'>if</span></span></span>( <span id="start75"><span class="mrange"><span id="end76">is_on_ground</span></span>()</span> )  {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path34" class="msg msgEvent" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">34</div></td><td><div class="PathNav"><a href="#Path33" title="Previous event (33)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path35" title="Next event (35)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">            <span class='keyword'>if</span>( has_flag( json_flag_PSEUDOPOD_GRASP ) ) {</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">                d.mult_damage( 0.8 );</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">            d.mult_damage( 0.3 );</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">        } <span class='keyword'>else</span> <span id="start74"><span id="end75"><span class='keyword'>if</span></span></span>( <span id="start73"><span class="mrange"><span id="end74">is_crouching</span></span>()</span> &amp;&amp; ( !has_effect( effect_natural_stance ) &amp;&amp; !unarmed_attack() ) &amp;&amp;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path35" class="msg msgEvent" style="margin-left:20ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">35</div></td><td><div class="PathNav"><a href="#Path34" title="Previous event (34)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path36" title="Next event (36)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">                   !has_flag( json_flag_PSEUDOPOD_GRASP ) ) {</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">            d.mult_damage( 0.8 );</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">        <span id="start72"><span id="end73"><span class='keyword'>const</span></span></span> ma_technique &amp;technique = technique_id.obj();</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">        <span class='comment'>// Handles effects as well; not done in melee_affect_*</span></td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">        <span id="start71"><span id="end72"><span class='keyword'>if</span></span></span>( technique.id != tec_none ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path36" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">36</div></td><td><div class="PathNav"><a href="#Path35" title="Previous event (35)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path37" title="Next event (37)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">            <span id="start68"><span id="end69"><span id="start70"><span id="end71">perform_technique</span></span></span></span>( <span id="start69"><span id="end70">technique</span></span>, t, d, move_cost, cur_weapon );</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">        <span class='comment'>//player has a very small chance, based on their intelligence, to learn a style whilst using the CQB bionic</span></td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">        <span id="start67"><span id="end68"><span class='keyword'>if</span></span></span>( <span id="start66"><span class="mrange"><span id="end67">has_active_bionic</span></span>( bio_cqb )</span> &amp;&amp; !martial_arts_data-&gt;knows_selected_style() ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path37" class="msg msgEvent" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">37</div></td><td><div class="PathNav"><a href="#Path36" title="Previous event (36)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path38" title="Next event (38)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">            <span class='comment'>/** @EFFECT_INT slightly increases chance to learn techniques when using CQB bionic */</span></td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">            <span class='comment'>// Enhanced Memory Banks bionic doubles chance to learn martial art</span></td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>int</span> learn_boost = has_flag( json_flag_CBQ_LEARN_BONUS ) ? 2 : 1;</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">            <span class='keyword'>if</span>( one_in( ( 1400 - ( get_int() * 50 ) ) / learn_boost ) ) {</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">                martial_arts_data-&gt;learn_current_style_CQB( is_avatar() );</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">        <span class='comment'>// Proceed with melee attack.</span></td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">        <span id="start65"><span id="end66"><span class='keyword'>if</span></span></span>( <span id="start64"><span class="mrange"><span id="end65">!</span></span>t.is_dead_state()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path38" class="msg msgEvent" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">38</div></td><td><div class="PathNav"><a href="#Path37" title="Previous event (37)">&#x2190;</a></div></td><td>Assuming the condition is true</td><td><div class="PathNav"><a href="#Path39" title="Next event (39)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path39" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">39</div></td><td><div class="PathNav"><a href="#Path38" title="Previous event (38)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path40" title="Next event (40)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">            <span id="start61"><span id="end62"><span id="start63"><span id="end64">std</span></span></span></span>::string <span id="start62"><span id="end63">specialmsg</span></span>;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">            <span class='comment'>// Handles speed penalties to monster &amp; us, etc</span></td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">            <span id="start60"><span id="end61"><span class='keyword'>if</span></span></span>( <span id="start59"><span class="mrange"><span id="end60">!</span></span>t.is_hallucination()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path40" class="msg msgEvent" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">40</div></td><td><div class="PathNav"><a href="#Path39" title="Previous event (39)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path41" title="Next event (41)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path41" class="msg msgControl" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">41</div></td><td><div class="PathNav"><a href="#Path40" title="Previous event (40)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path42" title="Next event (42)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">                <span class='keyword'>if</span>( technique.attack_override ) {</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">                    specialmsg = melee_special_effects( t, d, null_item_reference() );</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">                    specialmsg = melee_special_effects( t, d, cur_weap );</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">            <span class='comment'>// gets overwritten with the dealt damage values</span></td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">            <span id="start56"><span id="end57"><span id="start58"><span id="end59">dealt_damage_instance</span></span></span></span> <span id="start57"><span id="end58">dealt_dam</span></span>;</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">            dealt_damage_instance dealt_special_dam;</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">            <span id="start55"><span id="end56"><span class='keyword'>if</span></span></span>( <span id="start54"><span id="end55"><span class='variable'>allow_special<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>41.1</div></td><td>'allow_special' is false</td></tr></tbody></table></span></span></span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path42" class="msg msgControl" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">42</div></td><td><div class="PathNav"><a href="#Path41" title="Previous event (41)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path43" title="Next event (43)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">                perform_special_attacks( t, dealt_special_dam );</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">            <span id="start51"><span id="end52"><span id="start53"><span id="end54">weakpoint_attack</span></span></span></span> <span id="start52"><span id="end53">attack</span></span>;</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">            attack.weapon = &amp;cur_weap;</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">            t.deal_melee_hit( <span class='keyword'>this</span>, hit_spread, critical_hit, d, dealt_dam, attack, &amp;target_bp );</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">            <span id="start50"><span id="end51"><span class='keyword'>bool</span></span></span> has_edged_damage = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">            <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">                <span id="start49"><span id="end50"><span class='keyword'>if</span></span></span>( <span id="start48"><span class="mrange"><span id="end49">dt</span></span>.melee_only</span> &amp;&amp; <span id="start47"><span class="mrange"><span id="end48">dt</span></span>.edged</span> &amp;&amp; <span id="start46"><span class="mrange"><span id="end47">dealt_special_dam</span></span>.type_damage( dt.id ) &gt; 0</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path43" class="msg msgEvent" style="margin-left:21ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">43</div></td><td><div class="PathNav"><a href="#Path42" title="Previous event (42)">&#x2190;</a></div></td><td>Assuming field 'melee_only' is true</td><td><div class="PathNav"><a href="#Path44" title="Next event (44)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path44" class="msg msgEvent" style="margin-left:38ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">44</div></td><td><div class="PathNav"><a href="#Path43" title="Previous event (43)">&#x2190;</a></div></td><td>Assuming field 'edged' is true</td><td><div class="PathNav"><a href="#Path45" title="Next event (45)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path45" class="msg msgEvent" style="margin-left:50ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">45</div></td><td><div class="PathNav"><a href="#Path44" title="Previous event (44)">&#x2190;</a></div></td><td>Assuming the condition is true</td><td><div class="PathNav"><a href="#Path46" title="Next event (46)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path46" class="msg msgControl" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">46</div></td><td><div class="PathNav"><a href="#Path45" title="Previous event (45)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path47" title="Next event (47)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">                    <span id="start45"><span id="end46">has_edged_damage</span></span> = <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">                    <span id="start44"><span id="end45"><span class='keyword'>break</span></span></span>;</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">            <span id="start43"><span id="end44"><span class='keyword'>if</span></span></span>( <span id="start42"><span id="end43"><span class='variable'>has_edged_damage<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>46.1</div></td><td>'has_edged_damage' is true</td></tr></tbody></table></span></span></span> || ( !cur_weapon &amp;&amp; has_edged_damage ) ) {</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">                <span id="start41"><span id="end42"><span class='keyword'>if</span></span></span>( <span id="start40"><span class="mrange"><span id="end41">has_trait</span></span>( trait_POISONOUS )</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path47" class="msg msgEvent" style="margin-left:21ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">47</div></td><td><div class="PathNav"><a href="#Path46" title="Previous event (46)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path48" title="Next event (48)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path48" class="msg msgControl" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">48</div></td><td><div class="PathNav"><a href="#Path47" title="Previous event (47)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path49" title="Next event (49)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">                    <span class='keyword'>if</span>( t.is_monster() ) {</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">                        t.add_effect( effect_venom_player1, 1_minutes );</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">                        t.add_effect( effect_venom_dmg, 10_minutes );</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">                    <span class='keyword'>if</span>( t.is_immune_effect( effect_venom_player1 ) ) {</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">                        add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"The %s is not affected by your venom"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s is not affected by your venom"<br> ) ) )</span></span>, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">                        add_msg_if_player( m_good, <span class='macro'>_( <span class='string_literal'>"You poison %s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You poison %s!" ) ) )</span></span>, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">                        <span class='keyword'>if</span>( x_in_y( 1, 10 ) ) {</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">                            t.add_effect( effect_stunned, 1_turns );</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">                } <span class='keyword'>else</span> <span id="start39"><span id="end40"><span class='keyword'>if</span></span></span>( <span id="start37"><span class="mrange"><span id="end38">has_trait</span></span>( <span id="start38"><span id="end39">trait_POISONOUS2</span></span> )</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path49" class="msg msgEvent" style="margin-left:28ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">49</div></td><td><div class="PathNav"><a href="#Path48" title="Previous event (48)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path50" title="Next event (50)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path50" class="msg msgControl" style="margin-left:24ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">50</div></td><td><div class="PathNav"><a href="#Path49" title="Previous event (49)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path51" title="Next event (51)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">                    <span class='keyword'>if</span>( t.is_monster() ) {</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">                        t.add_effect( effect_venom_player2, 1_minutes );</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">                        t.add_effect( effect_venom_dmg, 15_minutes );</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">                        t.add_effect( effect_venom_weaken, 5_minutes );</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">                    <span class='keyword'>if</span>( t.is_immune_effect( effect_venom_player2 ) ) {</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">                        add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"The %s is not affected by your venom"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s is not affected by your venom"<br> ) ) )</span></span>, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">                        add_msg_if_player( m_good, <span class='macro'>_( <span class='string_literal'>"You inject your venom into %s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You inject your venom into %s!"<br> ) ) )</span></span>, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">                        <span class='keyword'>if</span>( x_in_y( 1, 4 ) ) {</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">                            t.add_effect( effect_stunned, 1_turns );</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">            <span class='comment'>// Make a rather quiet sound, to alert any nearby monsters</span></td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">            <span id="start36"><span id="end37"><span class='keyword'>if</span></span></span>( <span id="start35"><span class="mrange">!</span><span id="end36">is_quiet</span>()</span> ) { <span class='comment'>// check martial arts silence</span></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path51" class="msg msgEvent" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">51</div></td><td><div class="PathNav"><a href="#Path50" title="Previous event (50)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path52" title="Next event (52)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path52" class="msg msgControl" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">52</div></td><td><div class="PathNav"><a href="#Path51" title="Previous event (51)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path53" title="Next event (53)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">                <span class='comment'>//sound generated later</span></td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">                <span class='keyword'>int</span> volume = enchantment_cache-&gt;modify_value( enchant_vals::mod::ATTACK_NOISE, 8 );</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">                sounds::sound( pos(), volume, sounds::sound_t::combat, <span class='macro'>_( <span class='string_literal'>"whack!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "whack!" ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">            <span id="start32"><span id="end33"><span id="start34"><span id="end35">std</span></span></span></span>::string material = <span id="start33"><span id="end34"><span class='string_literal'>"flesh"</span>;</td></tr></span></span>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">            <span id="start31"><span id="end32"><span class='keyword'>if</span></span></span>( <span id="start30"><span class="mrange"><span id="end31">t</span></span>.is_monster()</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path53" class="msg msgEvent" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">53</div></td><td><div class="PathNav"><a href="#Path52" title="Previous event (52)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path54" title="Next event (54)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path54" class="msg msgControl" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">54</div></td><td><div class="PathNav"><a href="#Path53" title="Previous event (53)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path55" title="Next event (55)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">                <span class='keyword'>const</span> monster *m = <span class='keyword'>dynamic_cast</span>&lt;<span class='keyword'>const</span> monster *&gt;( &amp;t );</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">                <span class='keyword'>if</span>( m-&gt;made_of( material_steel ) ) {</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">                    material = <span class='string_literal'>"steel"</span>;</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">            <span id="start29"><span id="end30">sfx</span></span>::generate_melee_sound( pos(), t.pos(), <span class='keyword'>true</span>, t.is_monster(), material );</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">            <span class='keyword'>int</span> dam = dealt_dam.total_damage();</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">            melee::melee_stats.damage_amount += dam;</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">            <span class='comment'>// Practice melee and relevant weapon skill (if any) except when using CQB bionic</span></td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">            <span id="start28"><span id="end29"><span class='keyword'>if</span></span></span>( <span id="start27"><span class="mrange"><span id="end28">!</span></span>has_active_bionic( bio_cqb )</span> &amp;&amp; !t.is_hallucination() ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path55" class="msg msgEvent" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">55</div></td><td><div class="PathNav"><a href="#Path54" title="Previous event (54)">&#x2190;</a></div></td><td>Assuming the condition is false</td><td><div class="PathNav"><a href="#Path56" title="Next event (56)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">                melee_train( *<span class='keyword'>this</span>, 5, std::min( 10, skill_training_cap ), cur_weap, attack_vector );</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">            <span class='comment'>// Treat monster as seen if we see it before or after the attack</span></td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">            <span id="start26"><span id="end27"><span class='keyword'>if</span></span></span>( <span id="start25"><span class="mrange"><span id="end26">seen</span></span></span> || <span id="start24"><span class="mrange"><span id="end25">player_character</span></span>.sees( t )</span> ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path56" class="msg msgEvent" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">56</div></td><td><div class="PathNav"><a href="#Path55" title="Previous event (55)">&#x2190;</a></div></td><td>Assuming 'seen' is false</td><td><div class="PathNav"><a href="#Path57" title="Next event (57)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path57" class="msg msgEvent" style="margin-left:25ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">57</div></td><td><div class="PathNav"><a href="#Path56" title="Previous event (56)">&#x2190;</a></div></td><td>Assuming the condition is true</td><td><div class="PathNav"><a href="#Path58" title="Next event (58)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path58" class="msg msgControl" style="margin-left:13ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">58</div></td><td><div class="PathNav"><a href="#Path57" title="Previous event (57)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path59" title="Next event (59)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">                <span id="start23"><span id="end24">std</span></span>::string message = <span class="mrange"><span id="end23">melee_message</span>( technique, *<span class='keyword'>this</span>, dealt_dam )</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path59" class="msg msgEvent" style="margin-left:39ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">59</div></td><td><div class="PathNav"><a href="#Path58" title="Previous event (58)">&#x2190;</a></div></td><td>Calling 'melee_message'</td><td><div class="PathNav"><a href="#Path60" title="Next event (60)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">                player_hit_message( <span class='keyword'>this</span>, message, t, dam, critical_hit, technique.id != tec_none,</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">                                    dealt_dam.wp_hit );</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">                add_msg_player_or_npc( m_good, <span class='macro'>_( <span class='string_literal'>"You hit something."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You hit something." ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">                                       <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; hits something."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; hits something."<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">            <span class='keyword'>if</span>( !specialmsg.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">                add_msg_if_player( m_neutral, specialmsg );</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">            <span class='keyword'>if</span>( critical_hit ) {</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">                <span class='comment'>// trigger martial arts on-crit effects</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">                martial_arts_data-&gt;ma_oncrit_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">        t.check_dead_state();</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">        <span class='keyword'>if</span>( t.is_dead_state() ) {</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">            <span class='comment'>// trigger martial arts on-kill effects</span></td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">            martial_arts_data-&gt;ma_onkill_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    <span class='keyword'>if</span>( !t.is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">        handle_melee_wear( cur_weapon );</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE reduces stamina cost of melee attacks */</span></td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> deft_bonus = !hits &amp;&amp; has_trait( trait_DEFT ) ? 50 : 0;</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> base_stam = get_base_melee_stamina_cost();</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> total_stam = enchantment_cache-&gt;modify_value(</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">                               enchant_vals::mod::MELEE_STAMINA_CONSUMPTION,</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">                               get_total_melee_stamina_cost() );</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    burn_energy_arms( std::min( -50, total_stam + deft_bonus ) );</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Stamina burn base/total (capped at -50): %d/%d"</span>, base_stam,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Stamina burn base/total (capped at -50): %d/%d"<br>, base_stam, total_stam + deft_bonus ) ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">                   <span class='macro'>total_stam + deft_bonus )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Stamina burn base/total (capped at -50): %d/%d"<br>, base_stam, total_stam + deft_bonus ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">    <span class='comment'>// Weariness handling - 1 / the value, because it returns what % of the normal speed</span></td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> weary_mult = exertion_adjusted_move_multiplier( EXTRA_EXERCISE );</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">    mod_moves( forced_movecost &gt;= 0 ? -forced_movecost : -move_cost * ( 1 / weary_mult ) );</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">    <span class='comment'>// trigger martial arts on-attack effects</span></td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    martial_arts_data-&gt;ma_onattack_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">    <span class='comment'>// some things (shattering weapons) can harm the attacking creature.</span></td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">    check_dead_state();</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    did_hit( t );</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">    <span class='keyword'>if</span>( t.as_character() ) {</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">        dealt_projectile_attack dp = dealt_projectile_attack();</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">        t.as_character()-&gt;on_hit( <span class='keyword'>this</span>, bodypart_id( <span class='string_literal'>"bp_null"</span> ), 0.0f, &amp;dp );</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">    <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line"><span class='keyword'>int</span> Character::get_base_melee_stamina_cost( <span class='keyword'>const</span> item *weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    <span class='keyword'>return</span> std::min( -50, get_standard_stamina_cost( weap ) );</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line"><span class='keyword'>int</span> Character::get_total_melee_stamina_cost( <span class='keyword'>const</span> item *weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> mod_sta = get_standard_stamina_cost( weap );</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> melee = round( get_skill_level( skill_melee ) );</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">    <span class='comment'>// Quadrupeds don't mind crouching, squids and slimes hardly care about even being prone</span></td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> stance_malus = ( is_on_ground() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">                               !has_flag( json_flag_PSEUDOPOD_GRASP ) ) ? 50 : ( !has_flag( json_flag_PSEUDOPOD_GRASP ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">                                       ( !has_effect( effect_natural_stance ) &amp;&amp; ( !unarmed_attack() ) ) &amp;&amp; is_crouching() ? 20 : 0 );</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">    <span class='keyword'>return</span> std::min( -50, mod_sta + melee - stance_malus );</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line"><span class='keyword'>void</span> Character::reach_attack( <span class='keyword'>const</span> tripoint &amp;p, <span class='keyword'>int</span> forced_movecost )</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> matec_id no_technique_id( <span class='string_literal'>""</span> );</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">    matec_id force_technique = no_technique_id;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE &gt;5 allows WHIP_DISARM technique */</span></td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">    <span class='keyword'>if</span>( weapon.has_flag( flag_WHIP ) &amp;&amp; ( get_skill_level( skill_melee ) &gt; 5 ) &amp;&amp; one_in( 3 ) ) {</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">        force_technique = WHIP_DISARM;</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    <span class='comment'>// Fighting is hard work</span></td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">    set_activity_level( EXTRA_EXERCISE );</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">    creature_tracker &amp;creatures = get_creature_tracker();</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">    Creature *critter = creatures.creature_at( p );</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">    <span class='comment'>// Original target size, used when there are monsters in front of our target</span></td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> target_size = critter != <span class='keyword'>nullptr</span> ? <span class='keyword'>static_cast</span>&lt;<span class='keyword'>int</span>&gt;( critter-&gt;get_size() ) : 2;</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">    <span class='comment'>// Reset last target pos</span></td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">    last_target_pos = std::nullopt;</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">    <span class='comment'>// Max out recoil</span></td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">    recoil = MAX_RECOIL;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">    <span class='comment'>// Weariness handling</span></td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    <span class='comment'>// 1 / mult because mult is the percent penalty, in the form 1.0 == 100%</span></td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> weary_mult = 1.0f / exertion_adjusted_move_multiplier( EXTRA_EXERCISE );</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">    <span class='keyword'>int</span> move_cost = attack_speed( weapon ) * weary_mult;</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">    <span class='keyword'>float</span> skill = std::min( 10.0f, get_skill_level( skill_melee ) );</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">    <span class='keyword'>int</span> t = 0;</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    map &amp;here = get_map();</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">    std::vector&lt;tripoint&gt; path = line_to( pos(), p, t, 0 );</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">    path.pop_back(); <span class='comment'>// Last point is our critter</span></td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> tripoint &amp;path_point : path ) {</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">        <span class='comment'>// Possibly hit some unintended target instead</span></td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">        Creature *inter = creatures.creature_at( path_point );</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">        <span class='comment'>/** @EFFECT_MELEE decreases chance of hitting intervening target on reach attack */</span></td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">        <span class='keyword'>if</span>( inter != <span class='keyword'>nullptr</span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">            !x_in_y( ( target_size * target_size + 1 ) * skill,</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">                     ( inter-&gt;get_size() * inter-&gt;get_size() + 1 ) * 10 ) ) {</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">            <span class='comment'>// Even if we miss here, low roll means weapon is pushed away or something like that</span></td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">            <span class='keyword'>if</span>( inter-&gt;has_effect( effect_pet ) || ( inter-&gt;is_npc() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">                    inter-&gt;as_npc()-&gt;is_friendly( get_player_character() ) ) ) {</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">                <span class='keyword'>if</span>( query_yn( <span class='macro'>_( <span class='string_literal'>"Your attack may cause accidental injury, continue?"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your attack may cause accidental injury, continue?"<br> ) ) )</span></span> ) ) {</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">                    critter = inter;</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">                    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">            critter = inter;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( here.impassable( path_point ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">                   <span class='comment'>// Fences etc. Spears can stab through those</span></td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">                   !( weapon.has_flag( flag_SPEAR ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">                      here.has_flag( ter_furn_flag::TFLAG_THIN_OBSTACLE, path_point ) ) ) {</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">            <span class='comment'>/** @ARM_STR increases bash effects when reach attacking past something */</span></td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">            here.bash( path_point, get_arm_str() + weapon.damage_melee( damage_bash ) );</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">            handle_melee_wear( get_wielded_item() );</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">            mod_moves( forced_movecost &gt;= 0 ? -forced_movecost : -move_cost );</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">    <span class='keyword'>if</span>( critter == <span class='keyword'>nullptr</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        add_msg_if_player( <span class='macro'>_( <span class='string_literal'>"You swing at the air."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You swing at the air." ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">        <span class='keyword'>const</span> ma_technique miss_recovery = martial_arts_data-&gt;get_miss_recovery( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">        <span class='keyword'>if</span>( miss_recovery.id != tec_none ) {</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">            move_cost /= 3; <span class='comment'>// "Probing" is faster than a regular miss</span></td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">            <span class='comment'>// Communicate this with a different message?</span></td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">        mod_moves( forced_movecost &gt;= 0 ? -forced_movecost : -move_cost );</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">    reach_attacking = <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">    melee_attack_abstract( *critter, <span class='keyword'>true</span>, force_technique, <span class='keyword'>false</span>, forced_movecost );</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">    reach_attacking = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line"><span class='keyword'>int</span> stumble( Character &amp;u, <span class='keyword'>const</span> item_location &amp;weap )</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">    <span class='keyword'>if</span>( !weap || u.has_trait( trait_DEFT ) ) {</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">    item cur_weap = weap ? *weap : null_item_reference();</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    units::mass str_mod = u.get_arm_str() * 10_gram;</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">    <span class='comment'>// Ceph and Slime mutants still need good posture to prevent stumbling</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    <span class='keyword'>if</span>( u.is_on_ground() ) {</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">        str_mod /= 4;</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">        <span class='comment'>// but quadrupeds fight naturally on all fours</span></td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( u.is_crouching() &amp;&amp; ( !u.has_effect( effect_natural_stance ) &amp;&amp; !u.unarmed_attack() ) ) {</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">        str_mod /= 2;</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">    <span class='comment'>// Examples:</span></td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    <span class='comment'>// 10 str with a hatchet: 4 + 8 = 12</span></td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">    <span class='comment'>// 5 str with a battle axe: 26 + 49 = 75</span></td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">    <span class='comment'>// Fist: 0</span></td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">    <span class='comment'>/** @EFFECT_STR reduces chance of stumbling with heavier weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">    <span class='keyword'>return</span> ( weap-&gt;volume() / 125_ml ) +</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">           ( weap-&gt;weight() / ( str_mod + 13.0_gram ) );</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"><span class='keyword'>bool</span> Character::scored_crit( <span class='keyword'>float</span> target_dodge, <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">    <span class='keyword'>return</span> rng_float( 0, 1.0 ) &lt; crit_chance( hit_roll(), target_dodge, weap );</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line"><span class='comment'>/**</span></td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line"> <span class='comment'>* Limits a probability to be between 0.0 and 1.0</span></td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>double</span> limit_probability( <span class='keyword'>double</span> unbounded_probability )</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">    <span class='keyword'>return</span> std::max( std::min( unbounded_probability, 1.0 ), 0.0 );</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line"><span class='keyword'>double</span> Character::crit_chance( <span class='keyword'>float</span> roll_hit, <span class='keyword'>float</span> target_dodge, <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    <span class='comment'>// Martial arts buff bonuses</span></td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    <span class='keyword'>double</span> ma_buff_crit_chance = mabuff_critical_hit_chance_bonus() / 100;</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    <span class='comment'>// Weapon to-hit roll</span></td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">    <span class='keyword'>double</span> weapon_crit_chance = 0.5;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">    <span class='keyword'>if</span>( weap.is_null() ) {</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">        <span class='comment'>// Unarmed attack: 1/2 of unarmed skill is to-hit</span></td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">        <span class='comment'>/** @EFFECT_UNARMED increases critical chance */</span></td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">        weapon_crit_chance = 0.5 + 0.05 * get_skill_level( skill_unarmed );</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">    <span class='keyword'>if</span>( weap.type-&gt;m_to_hit &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">        weapon_crit_chance = std::max( weapon_crit_chance, 0.5 + 0.1 * weap.type-&gt;m_to_hit );</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( weap.type-&gt;m_to_hit &lt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">        weapon_crit_chance += 0.1 * weap.type-&gt;m_to_hit;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    weapon_crit_chance = limit_probability( weapon_crit_chance );</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">    <span class='comment'>// Dexterity and perception</span></td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    <span class='comment'>/** @EFFECT_DEX increases chance for critical hits */</span></td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    <span class='comment'>/** @EFFECT_PER increases chance for critical hits */</span></td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> stat_crit_chance = limit_probability( 0.25 + 0.01 * dex_cur + ( 0.02 * per_cur ) );</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    <span class='comment'>/** @EFFECT_BASHING increases critical chance with bashing weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">    <span class='comment'>/** @EFFECT_CUTTING increases critical chance with cutting weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">    <span class='comment'>/** @EFFECT_STABBING increases critical chance with piercing weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    <span class='comment'>/** @EFFECT_UNARMED increases critical chance with unarmed weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    <span class='keyword'>float</span> sk = get_skill_level( weap.melee_skill() );</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    <span class='keyword'>if</span>( has_active_bionic( bio_cqb ) ) {</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">        sk = std::max( sk, <span class='keyword'>static_cast</span>&lt;<span class='keyword'>float</span>&gt;( BIO_CQB_LEVEL ) );</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE slightly increases critical chance with any item */</span></td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">    sk += get_skill_level( skill_melee ) / 2.5;</td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> skill_crit_chance = limit_probability( 0.25 + sk * 0.025 );</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">    <span class='comment'>// Examples (survivor stats/chances of each critical):</span></td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">    <span class='comment'>// Fresh (skill-less) 8/8/8/8, unarmed:</span></td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">    <span class='comment'>//  50%, 49%, 25%; ~1/16 guaranteed critical + ~1/8 if roll&gt;dodge*1.5</span></td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">    <span class='comment'>// Expert (skills 10) 10/10/10/10, unarmed:</span></td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">    <span class='comment'>//  100%, 55%, 60%; ~1/3 guaranteed critical + ~4/10 if roll&gt;dodge*1.5</span></td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">    <span class='comment'>// Godlike with combat CBM 20/20/20/20, pipe (+1 accuracy):</span></td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">    <span class='comment'>//  60%, 100%, 42%; ~1/4 guaranteed critical + ~3/8 if roll&gt;dodge*1.5</span></td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    <span class='comment'>// Note: the formulas below are only valid if none of the 3 critical chance values go above 1.0</span></td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">    <span class='comment'>// It is therefore important to limit them to between 0.0 and 1.0</span></td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    <span class='comment'>// Chance to get all 3 criticals (a guaranteed critical regardless of hit/dodge)</span></td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> chance_triple = weapon_crit_chance * stat_crit_chance * skill_crit_chance;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">    <span class='comment'>// Only check double critical (one that requires hit/dodge comparison) if we have good</span></td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">    <span class='comment'>// hit vs dodge</span></td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">    <span class='keyword'>if</span>( roll_hit &gt; target_dodge * 3 / 2 ) {</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>double</span> chance_double = 0.5 * (</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">                                         weapon_crit_chance * stat_crit_chance +</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">                                         stat_crit_chance * skill_crit_chance +</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">                                         weapon_crit_chance * skill_crit_chance -</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">                                         ( 3 * chance_triple ) );</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">        <span class='comment'>// Because chance_double already removed the triples with -( 3 * chance_triple ),</span></td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">        <span class='comment'>// chance_triple and chance_double are mutually exclusive probabilities and can just</span></td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">        <span class='comment'>// be added together.</span></td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">        melee::melee_stats.double_crit_count += 1;</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">        melee::melee_stats.double_crit_chance += chance_double + chance_triple + ma_buff_crit_chance;</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">        <span class='keyword'>return</span> chance_triple + chance_double + ma_buff_crit_chance;</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    melee::melee_stats.crit_count += 1;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">    melee::melee_stats.crit_chance += chance_triple + ma_buff_crit_chance;</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    <span class='keyword'>return</span> chance_triple + ma_buff_crit_chance;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line"><span class='keyword'>int</span> Character::get_spell_resist() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">    <span class='keyword'>return</span> round( get_skill_level( skill_spellcraft ) );</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line"><span class='keyword'>float</span> Character::get_dodge() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">    <span class='keyword'>if</span>( !can_try_doge().success() ) {</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">        <span class='keyword'>return</span> 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    <span class='keyword'>float</span> ret = Creature::get_dodge();</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Base dodge %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Base dodge %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">    <span class='comment'>// Chop in half if we are unable to move</span></td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    <span class='keyword'>if</span>( has_effect( effect_beartrap ) || has_effect( effect_lightsnare ) ||</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">        has_effect( effect_heavysnare ) ) {</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">        ret /= 2;</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after trapped penalty %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after trapped penalty %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    <span class='keyword'>if</span>( worn_with_flag( flag_ROLLER_INLINE ) ||</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">        worn_with_flag( flag_ROLLER_QUAD ) ||</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">        worn_with_flag( flag_ROLLER_ONE ) ) {</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">        ret /= has_trait( trait_PROF_SKATER ) ? 2 : 5;</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after skate penalty %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after skate penalty %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">    <span class='comment'>// Speed below 100 linearly decreases dodge effectiveness</span></td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">    <span class='keyword'>int</span> speed_stat = get_speed();</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">    <span class='keyword'>if</span>( speed_stat &lt; 100 ) {</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">        ret *= speed_stat / 100.0f;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after speed penalty %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after speed penalty %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">    <span class='comment'>//Dodge decreases logisticaly with stamina.</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> stamina_logistic = get_stamina_dodge_modifier();</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">    ret *= stamina_logistic;</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after stamina penalty %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after stamina penalty %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">    <span class='comment'>// Reaction score of limbs influences dodge chances</span></td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">    ret *= get_limb_score( limb_score_reaction );</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after reaction score %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after reaction score %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">    <span class='comment'>// Somatic limb dodge multiplier is applied after reaction score</span></td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">    ret *= get_modifier( character_modifier_limb_dodge_mod );</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after limb score modifier %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after limb score modifier %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">    <span class='comment'>// Modify by how much bigger/smaller we got from our limbs</span></td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">    ret /= anatomy( get_all_body_parts() ).get_size_ratio( anatomy_human_anatomy );</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dodge after bodysize modifier %.1f"</span>, ret )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dodge after bodysize modifier %.1f"<br>, ret ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">    <span class='keyword'>return</span> std::max( 0.0f, ret );</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line"><span class='keyword'>float</span> Character::dodge_roll() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">    <span class='comment'>// if your character has evasion then try rolling that first</span></td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">    <span class='keyword'>double</span> evasion = enchantment_cache-&gt;modify_value( enchant_vals::mod::EVASION, 0.0 );</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">    <span class='keyword'>if</span>( rng( 0, 99 ) &lt; evasion * 100.0 ) {</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">        <span class='comment'>// arbitrarily high number without being max float</span></td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">        <span class='keyword'>return</span> 999999.0f;</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">    <span class='keyword'>if</span>( has_flag( json_flag_HARDTOHIT ) ) {</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">        <span class='comment'>// two chances at rng!</span></td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">        <span class='keyword'>return</span> std::max( get_dodge(), get_dodge() ) * 5;</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">    <span class='keyword'>return</span> get_dodge() * 5;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line"><span class='keyword'>float</span> Character::bonus_damage( <span class='keyword'>bool</span> random ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">    <span class='comment'>/** @ARM_STR increases bashing damage */</span></td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">    <span class='keyword'>if</span>( random ) {</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">        <span class='keyword'>return</span> rng_float( get_arm_str() / 2.0f, get_arm_str() );</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">    <span class='keyword'>return</span> get_arm_str() * 0.75f;</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> roll_melee_damage_internal( <span class='keyword'>const</span> Character &amp;u, <span class='keyword'>const</span> damage_type_id &amp;dt, <span class='keyword'>bool</span> crit,</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">                                        damage_instance &amp;di, <span class='keyword'>bool</span> average, <span class='keyword'>const</span> item &amp;weap,</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">                                        <span class='keyword'>const</span> std::string &amp;attack_vector, <span class='keyword'>float</span> crit_mod )</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type</span></td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">    <span class='keyword'>float</span> dmg = dt == damage_bash ? 0.f : u.mabuff_damage_bonus( dt ) + weap.damage_melee( dt );</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    <span class='keyword'>bool</span> unarmed = attack_vector != <span class='string_literal'>"WEAPON"</span>;</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">    <span class='keyword'>int</span> arpen = 0;</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    <span class='keyword'>float</span> skill = u.get_skill_level( unarmed ? skill_unarmed : dt-&gt;skill );</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">    <span class='keyword'>if</span>( u.has_active_bionic( bio_cqb ) ) {</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">        skill = BIO_CQB_LEVEL;</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type effects (bash)</span></td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">    <span class='keyword'>if</span>( dt == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">        <span class='keyword'>if</span>( u.has_trait( trait_KI_STRIKE ) &amp;&amp; unarmed ) {</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">            <span class='comment'>// Pure unarmed doubles the bonuses from unarmed skill</span></td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">            skill *= 2;</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">        <span class='comment'>// Drunken Master damage bonuses</span></td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">        <span class='keyword'>if</span>( u.has_trait( trait_DRUNKEN ) &amp;&amp; u.has_effect( effect_drunk ) ) {</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">            <span class='comment'>// Remember, a single drink gives 600 levels of "drunk"</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">            <span class='keyword'>int</span> mindrunk = 0;</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">            <span class='keyword'>int</span> maxdrunk = 0;</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">            <span class='keyword'>const</span> time_duration drunk_dur = u.get_effect_dur( effect_drunk );</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">            <span class='keyword'>if</span>( unarmed ) {</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">                mindrunk = drunk_dur / 1_hours;</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">                maxdrunk = drunk_dur / 25_minutes;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">                mindrunk = drunk_dur / 90_minutes;</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                maxdrunk = drunk_dur / 40_minutes;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">            dmg += average ? ( mindrunk + maxdrunk ) * 0.5f : rng( mindrunk, maxdrunk );</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">    <span class='keyword'>if</span>( unarmed ) {</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">        <span class='keyword'>bool</span> bp_unrestricted;</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">        <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"ARM"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"arm_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">                              ( !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"arm_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"ELBOW"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"arm_elbow_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"arm_elbow_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"WRIST"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"hand_wrist_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"hand_wrist_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"SHOULDER"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"arm_shoulder_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"arm_shoulder_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"FOOT"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"foot_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">                              ( !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"foot_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"LOWER_LEG"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_lower_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_lower_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"KNEE"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_knee_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_knee_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"HIP"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_hip_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">                              ( !u.natural_attack_restricted_on( sub_bodypart_id( <span class='string_literal'>"leg_hip_r"</span> ) ) );</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"HEAD"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"head"</span> ) );</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"MOUTH"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"mouth"</span> ) );</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"TORSO"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"torso"</span> ) );</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">            bp_unrestricted = !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"hand_l"</span> ) ) ||</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">                              ( !u.natural_attack_restricted_on( bodypart_id( <span class='string_literal'>"hand_r"</span> ) ) &amp;&amp; weap.is_null() );</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">        <span class='keyword'>if</span>( bp_unrestricted ) {</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">            <span class='keyword'>float</span> extra_damage = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">            <span class='keyword'>for</span>( <span class='keyword'>const</span> trait_id &amp;mut : u.get_mutations() ) {</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">                <span class='keyword'>if</span>( mut-&gt;flags.count( json_flag_NEED_ACTIVE_TO_MELEE ) &gt; 0 &amp;&amp; !u.has_active_mutation( mut ) ) {</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">                <span class='keyword'>float</span> unarmed_bonus = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">                <span class='keyword'>int</span> bonus_dmg = 0;</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">                std::pair&lt;<span class='keyword'>int</span>, <span class='keyword'>int</span>&gt; bonus_rand = { 0, 0 };</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">                <span class='keyword'>if</span>( mut-&gt;flags.count( json_flag_UNARMED_BONUS ) &gt; 0 &amp;&amp; bonus_dmg &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">                    unarmed_bonus += std::min( u.get_skill_level( skill_unarmed ) / 2, 4.0f );</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">                extra_damage += bonus_dmg + unarmed_bonus;</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">                extra_damage += average ? ( bonus_rand.first + bonus_rand.second ) / 2.0f :</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">                                rng( bonus_rand.first, bonus_rand.second );</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">            <span class='comment'>// FIXME: Hardcoded damage type effect (stab)</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">            <span class='keyword'>if</span>( attack_vector == <span class='string_literal'>"HAND"</span> &amp;&amp; dt == damage_stab &amp;&amp; u.has_bionic( bio_razors ) ) {</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">                extra_damage += 2;</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">            dmg += extra_damage;</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">        <span class='keyword'>float</span> dam = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">        <span class='keyword'>float</span> ap = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> bodypart_id &amp;bp : u.get_all_body_parts() ) {</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">            <span class='keyword'>if</span>( bp-&gt;unarmed_bonus &amp;&amp; !u.natural_attack_restricted_on( bp ) ) {</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">                dam += bp-&gt;unarmed_damage( dt );</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">                ap += bp-&gt;unarmed_arpen( dt );</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">        dmg += dam;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">        arpen += ap;</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">    <span class='comment'>/** @ARM_STR increases bashing damage */</span></td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">    <span class='keyword'>float</span> stat_bonus = u.bonus_damage( !average );</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">    stat_bonus += u.mabuff_damage_bonus( dt );</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">    <span class='comment'>/** @EFFECT_STR increases bashing damage */</span></td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">    <span class='keyword'>float</span> weap_dam = weap.damage_melee( dt ) + stat_bonus;</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">    <span class='comment'>/** @EFFECT_BASHING caps bash damage with bashing weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">    <span class='keyword'>float</span> bash_cap = 2 * u.get_arm_str() + 2 * skill;</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type effects (bash)</span></td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    <span class='keyword'>if</span>( dt != damage_bash &amp;&amp; dmg &lt;= 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">        <span class='keyword'>return</span>; <span class='comment'>// No negative damage!</span></td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">        <span class='keyword'>float</span> melee_bonus = u.get_skill_level( skill_melee );</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">        <span class='comment'>/** @EFFECT_UNARMED caps bash damage with unarmed weapons */</span></td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">        <span class='keyword'>if</span>( u.is_melee_bash_damage_cap_bonus() ) {</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">            bash_cap += melee_bonus;</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">        <span class='keyword'>if</span>( u.has_trait( trait_KI_STRIKE ) &amp;&amp; unarmed ) {</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">            <span class='comment'>/** @EFFECT_UNARMED increases bashing damage with unarmed weapons when paired with the Ki Strike trait */</span></td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">            weap_dam += skill;</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">    <span class='keyword'>float</span> dmg_mul = 1.0f;</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type effects (stab)</span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">    <span class='keyword'>if</span>( dt == damage_stab ) {</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">        <span class='comment'>// 66%, 76%, 86%, 96%, 106%, 116%, 122%, 128%, 134%, 140%</span></td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">        <span class='comment'>/** @EFFECT_STABBING increases stabbing damage multiplier */</span></td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">        <span class='keyword'>if</span>( skill &lt;= 5 ) {</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">            dmg_mul = 0.66 + 0.1 * skill;</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">            dmg_mul = 0.86 + 0.06 * skill;</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">        <span class='comment'>// 80%, 88%, 96%, 104%, 112%, 116%, 120%, 124%, 128%, 132%</span></td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">        <span class='keyword'>if</span>( skill &lt; 5 ) {</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">            dmg_mul *= 0.8 + 0.08 * skill;</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">            dmg_mul *= 0.96 + 0.04 * skill;</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type effects (bash)</span></td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">    <span class='keyword'>if</span>( dt == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        <span class='keyword'>if</span>( bash_cap &lt; weap_dam &amp;&amp; !weap.is_null() ) {</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">            <span class='comment'>// If damage goes over cap due to low stats/skills,</span></td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">            <span class='comment'>// scale the post-armor damage down halfway between damage and cap</span></td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">            dmg_mul *= ( 1.0f + ( bash_cap / weap_dam ) ) / 2.0f;</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">        <span class='comment'>/** @ARM_STR boosts low cap on bashing damage */</span></td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>float</span> low_cap = std::min( 1.0f, u.get_arm_str() / 20.0f );</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>float</span> bash_min = low_cap * weap_dam;</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">        weap_dam = average ? ( bash_min + weap_dam ) * 0.5f : rng_float( bash_min, weap_dam );</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">        dmg += weap_dam;</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">    dmg_mul *= u.mabuff_damage_mult( dt );</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    arpen += u.mabuff_arpen_bonus( dt );</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    <span class='keyword'>float</span> armor_mult = 1.0f;</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    <span class='keyword'>if</span>( crit ) {</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">        <span class='comment'>// FIXME: Hardcoded damage type effects (stab, cut, bash)</span></td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">        <span class='keyword'>if</span>( dt == damage_stab ) {</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">            <span class='comment'>// Critical damage bonus for stabbing scales with skill</span></td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">            dmg_mul *= 1.0 + ( skill / 10.0 ) * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">            <span class='comment'>// Stab criticals have extra %arpen</span></td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">            armor_mult = 1.f - 0.34f * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == damage_cut ) {</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">            dmg_mul *= 1.f + 0.25f * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">            arpen += <span class='keyword'>static_cast</span>&lt;<span class='keyword'>int</span>&gt;( 5.f * crit_mod );</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">            <span class='comment'>// 25% armor penetration</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">            armor_mult = 1.f - 0.25f * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( dt == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">            dmg_mul *= 1.f + 0.5f * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">            <span class='comment'>// 50% armor penetration</span></td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">            armor_mult = 0.5f * crit_mod;</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">    di.add_damage( dt, dmg, arpen, armor_mult, dmg_mul );</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line"><span class='keyword'>void</span> Character::roll_damage( <span class='keyword'>const</span> damage_type_id &amp;dt, <span class='keyword'>bool</span> crit, damage_instance &amp;di, <span class='keyword'>bool</span> average,</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">                             <span class='keyword'>const</span> item &amp;weap, <span class='keyword'>const</span> std::string &amp;attack_vector, <span class='keyword'>float</span> crit_mod ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">    <span class='comment'>// For handling typical melee damage types (bash, cut, stab)</span></td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line">    <span class='keyword'>if</span>( dt-&gt;melee_only ) {</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">        roll_melee_damage_internal( *<span class='keyword'>this</span>, dt, crit, di, average, weap, attack_vector, crit_mod );</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">    <span class='keyword'>bool</span> unarmed = attack_vector != <span class='string_literal'>"WEAPON"</span>;</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">    <span class='keyword'>float</span> other_dam = mabuff_damage_bonus( dt ) + weap.damage_melee( dt );</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">    <span class='keyword'>float</span> arpen = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">    <span class='keyword'>if</span>( unarmed ) {</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">        <span class='keyword'>float</span> dam = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">        <span class='keyword'>float</span> ap = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> bodypart_id &amp;bp : get_all_body_parts() ) {</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">            <span class='keyword'>if</span>( bp-&gt;unarmed_bonus &amp;&amp; !natural_attack_restricted_on( bp ) ) {</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">                dam += bp-&gt;unarmed_damage( dt );</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">                arpen += bp-&gt;unarmed_arpen( dt );</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">        other_dam += dam;</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">        arpen += ap;</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">    <span class='comment'>// No negative damage!</span></td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">    <span class='keyword'>if</span>( other_dam &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">        <span class='keyword'>float</span> other_mul = 1.0f * mabuff_damage_mult( dt );</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">        <span class='keyword'>float</span> armor_mult = 1.0f;</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">        di.add_damage( dt, other_dam, arpen, armor_mult, other_mul );</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">matec_id Character::pick_technique( Creature &amp;t, <span class='keyword'>const</span> item_location &amp;weap, <span class='keyword'>bool</span> crit,</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">                                    <span class='keyword'>bool</span> dodge_counter, <span class='keyword'>bool</span> block_counter, <span class='keyword'>const</span> std::vector&lt;matec_id&gt; &amp;blacklist )</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">    std::vector&lt;matec_id&gt; possible = evaluate_techniques( t, weap, crit,</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">                                     dodge_counter,  block_counter, blacklist );</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">    <span class='keyword'>return</span> random_entry( possible, tec_none );</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">std::vector&lt;matec_id&gt; Character::evaluate_techniques( Creature &amp;t, <span class='keyword'>const</span> item_location &amp;weap,</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">        <span class='keyword'>bool</span> crit, <span class='keyword'>bool</span> dodge_counter, <span class='keyword'>bool</span> block_counter, <span class='keyword'>const</span> std::vector&lt;matec_id&gt; &amp;blacklist )</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">    <span class='keyword'>const</span> std::vector&lt;matec_id&gt; all = martial_arts_data-&gt;get_all_techniques( weap, *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">    std::vector&lt;matec_id&gt; possible;</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">    <span class='keyword'>bool</span> wall_adjacent = get_map().is_wall_adjacent( pos() );</td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">    <span class='comment'>// this could be more robust but for now it should work fine</span></td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">    <span class='keyword'>bool</span> is_loaded = weap &amp;&amp; weap-&gt;is_magazine_full();</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">    <span class='comment'>// first add non-aoe tecs</span></td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> matec_id &amp;tec_id : all ) {</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">        <span class='keyword'>const</span> ma_technique &amp;tec = tec_id.obj();</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Evaluating technique %s"</span>, tec.name )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Evaluating technique %s"<br>, tec.name ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">        <span class='comment'>// skip techniques on the blacklist</span></td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">        <span class='keyword'>if</span>( find( blacklist.begin(), blacklist.end(), tec_id ) != blacklist.end() ) {</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Technique is on the blacklist, discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Technique is on the blacklist, discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">        <span class='comment'>// ignore "dummy" techniques like WBLOCK_1</span></td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">        <span class='keyword'>if</span>( tec.dummy ) {</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Dummy technique, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Dummy technique, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">        <span class='comment'>// skip defensive techniques</span></td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">        <span class='keyword'>if</span>( tec.defensive ) {</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Defensive technique, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Defensive technique, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">        <span class='comment'>// Ignore this technique if we fail the doalog conditions</span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">        <span class='keyword'>if</span>( tec.has_condition ) {</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">            dialogue d( get_talker_for( <span class='keyword'>this</span> ), get_talker_for( t ) );</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">            <span class='keyword'>if</span>( !tec.condition( d ) ) {</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">                <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Conditionas failed, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Conditionas failed, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">        <span class='comment'>// skip wall adjacent techniques if not next to a wall</span></td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">        <span class='keyword'>if</span>( tec.wall_adjacent &amp;&amp; !wall_adjacent ) {</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"No adjacent walls found, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "No adjacent walls found, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">        <span class='comment'>// skip non reach ok techniques if reach attacking</span></td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">        <span class='keyword'>if</span>( !( tec.reach_ok || tec.reach_tec ) &amp;&amp; reach_attacking ) {</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Not usable with reach attack, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Not usable with reach attack, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">        <span class='comment'>// skip reach techniques if not reach attacking</span></td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">        <span class='keyword'>if</span>( tec.reach_tec &amp;&amp; !reach_attacking ) {</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Only usable with reach attack, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Only usable with reach attack, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">        <span class='comment'>// skip dodge counter techniques if it's not a dodge count, and vice versa</span></td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        <span class='keyword'>if</span>( dodge_counter != tec.dodge_counter ) {</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Not a dodge counter, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Not a dodge counter, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">        <span class='comment'>// likewise for block counters</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">        <span class='keyword'>if</span>( block_counter != tec.block_counter ) {</td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Not a block counter, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Not a block counter, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">        <span class='comment'>// Don't counter if it would exhaust moves.</span></td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">        <span class='keyword'>if</span>( tec.block_counter || tec.dodge_counter ) {</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">            item &amp;used_weap = used_weapon() ? *used_weapon() : null_item_reference();</td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">            <span class='keyword'>float</span> move_cost = attack_speed( used_weap );</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">            move_cost *= tec.move_cost_multiplier( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">            move_cost += tec.move_cost_penalty( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">            <span class='keyword'>float</span> move_mult = exertion_adjusted_move_multiplier( EXTRA_EXERCISE );</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">            move_cost *= ( 1.0f / move_mult );</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">            <span class='keyword'>if</span>( get_moves() + get_speed() - move_cost &lt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">                <span class='macro'>add_msg_debug( debugmode::DF_MELEE,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Counter technique would exhaust remaining moves, attack discarded"<br> ) ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">                               <span class='string_literal'><span class='macro'>"Counter technique would exhaust remaining moves, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Counter technique would exhaust remaining moves, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">        <span class='comment'>// if critical then select only from critical tecs</span></td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">        <span class='comment'>// but allow the technique if its crit ok</span></td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">        <span class='keyword'>if</span>( !tec.crit_ok &amp;&amp; ( crit != tec.crit_tec ) ) {</td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Attack is%s critical, attack discarded"</span>, crit ? <span class='string_literal'>""</span> : <span class='string_literal'>"n't"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Attack is%s critical, attack discarded"<br>, crit ? "" : "n't" ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">        <span class='comment'>// if the technique needs a loaded weapon and it isn't loaded skip it</span></td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">        <span class='keyword'>if</span>( tec.needs_ammo &amp;&amp; !is_loaded ) {</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"No ammo, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "No ammo, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">        <span class='comment'>// don't apply disarming techniques to someone without a weapon</span></td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">        <span class='comment'>// TODO: these are the stat requirements for tec_disarm</span></td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">        <span class='comment'>// dice(   dex_cur +    get_skill_level("unarmed"),  8) &gt;</span></td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">        <span class='comment'>// dice(p-&gt;dex_cur + p-&gt;get_skill_level("melee"),   10))</span></td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">        <span class='keyword'>if</span>( tec.disarms &amp;&amp; !t.has_weapon() ) {</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Disarming technique against unarmed opponent, attack discarded"<br> ) ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">                           <span class='string_literal'><span class='macro'>"Disarming technique against unarmed opponent, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Disarming technique against unarmed opponent, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">        <span class='keyword'>if</span>( tec.take_weapon &amp;&amp; ( has_weapon() || !t.has_weapon() ) ) {</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Weapon-taking technique %s, attack discarded"</span>,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Weapon-taking technique %s, attack discarded"<br>, has_weapon() ? "while armed" : "against an unarmed opponent"<br> ) ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">                           <span class='macro'>has_weapon() ? <span class='string_literal'>"while armed"</span> : <span class='string_literal'>"against an unarmed opponent"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Weapon-taking technique %s, attack discarded"<br>, has_weapon() ? "while armed" : "against an unarmed opponent"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">        <span class='comment'>// if aoe, check if there are valid targets</span></td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">        <span class='keyword'>if</span>( !tec.aoe.empty() &amp;&amp; !valid_aoe_technique( t, tec ) ) {</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"AoE technique witout valid AoE targets, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "AoE technique witout valid AoE targets, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        <span class='comment'>// If we have negative weighting then roll to see if it's valid this time</span></td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">        <span class='keyword'>if</span>( tec.weighting &lt; 0 &amp;&amp; !one_in( std::abs( tec.weighting ) ) ) {</td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Negative technique weighting failed weight roll, attack discarded"<br> ) ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">                           <span class='string_literal'><span class='macro'>"Negative technique weighting failed weight roll, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Negative technique weighting failed weight roll, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">        <span class='comment'>// Does the player have a functional attack vector to deliver the technique?</span></td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">        std::vector&lt;std::string&gt; shuffled_attack_vectors = tec.attack_vectors_random;</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">        std::shuffle( shuffled_attack_vectors.begin(), shuffled_attack_vectors.end(), rng_get_engine() );</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">        <span class='keyword'>if</span>( martial_arts_data-&gt;get_valid_attack_vector( *<span class='keyword'>this</span>, tec.attack_vectors ) == <span class='string_literal'>"NONE"</span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">            martial_arts_data-&gt;get_valid_attack_vector( *<span class='keyword'>this</span>, shuffled_attack_vectors ) == <span class='string_literal'>"NONE"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"No valid attack vector found, attack discarded"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "No valid attack vector found, attack discarded"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">        <span class='keyword'>if</span>( tec.is_valid_character( *<span class='keyword'>this</span> ) ) {</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">            possible.push_back( tec.id );</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">            <span class='comment'>//add weighted options into the list extra times, to increase their chance of being selected</span></td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">            <span class='keyword'>if</span>( tec.weighting &gt; 1 ) {</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">                <span class='keyword'>for</span>( <span class='keyword'>int</span> i = 1; i &lt; tec.weighting; i++ ) {</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">                    possible.push_back( tec.id );</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">    <span class='keyword'>return</span> possible;</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line"><span class='keyword'>bool</span> Character::valid_aoe_technique( Creature &amp;t, <span class='keyword'>const</span> ma_technique &amp;technique )</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">    std::vector&lt;Creature *&gt; dummy_targets;</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">    <span class='keyword'>return</span> valid_aoe_technique( t, technique, dummy_targets );</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line"><span class='keyword'>bool</span> Character::valid_aoe_technique( Creature &amp;t, <span class='keyword'>const</span> ma_technique &amp;technique,</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">                                     std::vector&lt;Creature *&gt; &amp;targets )</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">    <span class='keyword'>if</span>( technique.aoe.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">    <span class='comment'>// pre-computed matrix of adjacent squares</span></td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">    std::array&lt;<span class='keyword'>int</span>, 9&gt; offset_a = {{0, -1, -1, 1, 0, -1, 1, 1, 0 }};</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">    std::array&lt;<span class='keyword'>int</span>, 9&gt; offset_b = {{-1, -1, 0, -1, 0, 1, 0, 1, 1 }};</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">    <span class='comment'>// filter the values to be between -1 and 1 to avoid indexing the array out of bounds</span></td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">    <span class='keyword'>int</span> dy = std::max( -1, std::min( 1, t.posy() - posy() ) );</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    <span class='keyword'>int</span> dx = std::max( -1, std::min( 1, t.posx() - posx() ) );</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">    <span class='keyword'>int</span> lookup = dy + 1 + 3 * ( dx + 1 );</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">    creature_tracker &amp;creatures = get_creature_tracker();</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">    <span class='comment'>//wide hits all targets adjacent to the attacker and the target</span></td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">    <span class='keyword'>if</span>( technique.aoe == <span class='string_literal'>"wide"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">        <span class='comment'>//check if either (or both) of the squares next to our target contain a possible victim</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">        <span class='comment'>//offsets are a pre-computed matrix allowing us to quickly lookup adjacent squares</span></td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">        tripoint left = pos() + tripoint( offset_a[lookup], offset_b[lookup], 0 );</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">        tripoint right = pos() + tripoint( offset_b[lookup], -offset_a[lookup], 0 );</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">        monster *<span class='keyword'>const</span> mon_l = creatures.creature_at&lt;monster&gt;( left );</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">        <span class='keyword'>if</span>( mon_l &amp;&amp; mon_l-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">            targets.push_back( mon_l );</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">        monster *<span class='keyword'>const</span> mon_r = creatures.creature_at&lt;monster&gt;( right );</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">        <span class='keyword'>if</span>( mon_r &amp;&amp; mon_r-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">            targets.push_back( mon_r );</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">        npc *<span class='keyword'>const</span> npc_l = creatures.creature_at&lt;npc&gt;( left );</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">        npc *<span class='keyword'>const</span> npc_r = creatures.creature_at&lt;npc&gt;( right );</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">        <span class='keyword'>if</span>( npc_l &amp;&amp; npc_l-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">            targets.push_back( npc_l );</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">        <span class='keyword'>if</span>( npc_r &amp;&amp; npc_r-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">            targets.push_back( npc_r );</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">        <span class='keyword'>if</span>( !targets.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">    <span class='keyword'>if</span>( technique.aoe == <span class='string_literal'>"impale"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">        <span class='comment'>// Impale hits the target and a single target behind them</span></td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">        <span class='comment'>// Check if the square cardinally behind our target, or to the left / right,</span></td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">        <span class='comment'>// contains a possible target.</span></td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">        tripoint left = t.pos() + tripoint( offset_a[lookup], offset_b[lookup], 0 );</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        tripoint target_pos = t.pos() + ( t.pos() - pos() );</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">        tripoint right = t.pos() + tripoint( offset_b[lookup], -offset_b[lookup], 0 );</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">        monster *<span class='keyword'>const</span> mon_l = creatures.creature_at&lt;monster&gt;( left );</td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">        monster *<span class='keyword'>const</span> mon_t = creatures.creature_at&lt;monster&gt;( target_pos );</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">        monster *<span class='keyword'>const</span> mon_r = creatures.creature_at&lt;monster&gt;( right );</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">        <span class='keyword'>if</span>( mon_l &amp;&amp; mon_l-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">            targets.push_back( mon_l );</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        <span class='keyword'>if</span>( mon_t &amp;&amp; mon_t-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">            targets.push_back( mon_t );</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        <span class='keyword'>if</span>( mon_r &amp;&amp; mon_r-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">            targets.push_back( mon_r );</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">        npc *<span class='keyword'>const</span> npc_l = creatures.creature_at&lt;npc&gt;( left );</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">        npc *<span class='keyword'>const</span> npc_t = creatures.creature_at&lt;npc&gt;( target_pos );</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">        npc *<span class='keyword'>const</span> npc_r = creatures.creature_at&lt;npc&gt;( right );</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        <span class='keyword'>if</span>( npc_l &amp;&amp; npc_l-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">            targets.push_back( npc_l );</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">        <span class='keyword'>if</span>( npc_t &amp;&amp; npc_t-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">            targets.push_back( npc_t );</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">        <span class='keyword'>if</span>( npc_r &amp;&amp; npc_r-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">            targets.push_back( npc_r );</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">        <span class='keyword'>if</span>( !targets.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">    <span class='keyword'>if</span>( targets.empty() &amp;&amp; technique.aoe == <span class='string_literal'>"spin"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> tripoint &amp;tmp : get_map().points_in_radius( pos(), 1 ) ) {</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">            <span class='keyword'>if</span>( tmp == t.pos() ) {</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">            monster *<span class='keyword'>const</span> mon = creatures.creature_at&lt;monster&gt;( tmp );</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">            <span class='keyword'>if</span>( mon &amp;&amp; mon-&gt;friendly == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">                targets.push_back( mon );</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">            npc *<span class='keyword'>const</span> np = creatures.creature_at&lt;npc&gt;( tmp );</td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">            <span class='keyword'>if</span>( np &amp;&amp; np-&gt;is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">                targets.push_back( np );</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">        <span class='comment'>//don't trigger circle for fewer than 2 targets</span></td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">        <span class='keyword'>if</span>( targets.size() &lt; 2 ) {</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">            targets.clear();</td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line"><span class='keyword'>bool</span> character_martial_arts::has_technique( <span class='keyword'>const</span> Character &amp;guy, <span class='keyword'>const</span> matec_id &amp;id,</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">        <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">    <span class='keyword'>return</span> weap.has_technique( id ) ||</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">           style_selected-&gt;has_technique( guy, id );</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line"><span class='keyword'>static</span> damage_unit &amp;get_damage_unit( std::vector&lt;damage_unit&gt; &amp;di, <span class='keyword'>const</span> damage_type_id &amp;dt )</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    <span class='keyword'>static</span> damage_unit nullunit( damage_type_id::NULL_ID(), 0, 0, 0, 0 );</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">    <span class='keyword'>for</span>( damage_unit &amp;du : di ) {</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">        <span class='keyword'>if</span>( du.type == dt &amp;&amp; du.amount &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">            <span class='keyword'>return</span> du;</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">    <span class='keyword'>return</span> nullunit;</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> print_damage_info( <span class='keyword'>const</span> damage_instance &amp;di )</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">    <span class='keyword'>if</span>( !debug_mode ) {</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">    <span class='keyword'>int</span> total = 0;</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">    std::string ss;</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_unit &amp;du : di.damage_units ) {</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">        <span class='keyword'>int</span> amount = di.type_damage( du.type );</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">        total += amount;</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">        ss += du.type-&gt;name.translated() + <span class='string_literal'>":"</span> + std::to_string( amount ) + <span class='string_literal'>","</span>;</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%stotal: %d"</span>, ss, total )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%stotal: %d", ss<br>, total ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line"><span class='keyword'>void</span> Character::perform_technique( <span class='keyword'>const</span> ma_technique &amp;technique, Creature &amp;t,</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">                                   damage_instance &amp;di,</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">                                   <span class='keyword'>int</span> &amp;move_cost, item_location &amp;cur_weapon )</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Chose technique %s\ndmg before tec:"</span>, technique.name )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Chose technique %s\ndmg before tec:"<br>, technique.name ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">    print_damage_info( di );</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">    <span class='keyword'>int</span> rep = rng( technique.repeat_min, technique.repeat_max );</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Tech repeats %d times"</span>, rep )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Tech repeats %d times"<br>, rep ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">    <span class='comment'>// Keep the technique definitions shorter</span></td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">    <span class='keyword'>if</span>( technique.attack_override ) {</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">        move_cost = 0;</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        di.clear();</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">        <span class='keyword'>float</span> dam = technique.damage_bonus( *<span class='keyword'>this</span>, dt.id );</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">        <span class='keyword'>float</span> arpen = technique.armor_penetration( *<span class='keyword'>this</span>, dt.id );</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">        <span class='keyword'>float</span> mult = technique.damage_multiplier( *<span class='keyword'>this</span>, dt.id );</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">        <span class='keyword'>if</span>( mult != 1 ) {</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">            di.mult_type_damage( technique.damage_multiplier( *<span class='keyword'>this</span>, dt.id ), dt.id );</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">        <span class='keyword'>if</span>( dam != 0 || arpen != 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">            di.add_damage( dt.id, dam, arpen, 1.0f, rep );</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"dmg after attack"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "dmg after attack"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">    print_damage_info( di );</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">    move_cost *= technique.move_cost_multiplier( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">    <span class='comment'>// Flat movecosts scale with repeating techs</span></td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">    move_cost += technique.move_cost_penalty( *<span class='keyword'>this</span> ) * rep;</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">    <span class='comment'>// Add effects for each repeat of the tech</span></td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>int</span> i = 0; i &lt; rep; i++ ) {</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> tech_effect_data &amp;eff : technique.tech_effects ) {</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">            <span class='comment'>// Add the tech's effects if it rolls the chance and either did damage or ignores it</span></td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">            <span class='keyword'>if</span>( x_in_y( eff.chance, 100 ) &amp;&amp; ( di.total_damage() != 0 || !eff.on_damage ) ) {</td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">                <span class='keyword'>if</span>( eff.req_flag == json_flag_NULL || has_flag( eff.req_flag ) ) {</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">                    t.add_effect( eff.id, time_duration::from_turns( eff.duration ), eff.permanent );</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">                    add_msg_if_player( m_good, <span class='macro'>_( eff.message )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( eff.message ) ) )</span></span>, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">        <span class='keyword'>if</span>( technique.down_dur &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">            <span class='keyword'>if</span>( t.get_throw_resist() == 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">                t.add_effect( effect_downed, rng( 1_turns, time_duration::from_turns( technique.down_dur ) ) );</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">                damage_unit &amp;bash = get_damage_unit( di.damage_units, damage_bash );</td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">                <span class='keyword'>if</span>( bash.amount &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">                    bash.amount += 3;</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">        <span class='keyword'>if</span>( technique.stun_dur &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">            t.add_effect( effect_stunned, rng( 1_turns, time_duration::from_turns( technique.stun_dur ) ) );</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> effect_on_condition_id &amp;eoc : technique.eocs ) {</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">            dialogue d( get_talker_for( *<span class='keyword'>this</span> ), get_talker_for( t ) );</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">            <span class='keyword'>if</span>( eoc-&gt;type == eoc_type::ACTIVATION ) {</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">                eoc-&gt;activate( d );</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">                <span class='macro'>debugmsg( <span class='string_literal'>"Must use an activation eoc for a technique activation.  If you don't want the effect_on_condition to happen on its own (without the technique being activated), remove the recurrence min and max.  Otherwise, create a non-recurring effect_on_condition for this technique with its condition and effects, then have a recurring one queue it."</span> )<span class='macro_popup'>realDebugmsg("/usr/STLcheck/sekitest/Cataclysm-DDA/src/melee.cpp"<br>, "1865", __PRETTY_FUNCTION__, "Must use an activation eoc for a technique activation.  If you don't want the effect_on_condition to happen on its own (without the technique being activated), remove the recurrence min and max.  Otherwise, create a non-recurring effect_on_condition for this technique with its condition and effects, then have a recurring one queue it."<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">    <span class='keyword'>if</span>( technique.needs_ammo ) {</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">        <span class='keyword'>const</span> itype_id current_ammo = cur_weapon.get_item()-&gt;ammo_current();</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">        <span class='comment'>// if the weapon needs ammo we now expend it</span></td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">        cur_weapon.get_item()-&gt;ammo_consume( 1, pos(), <span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">        <span class='comment'>// thing going off should be as loud as the ammo</span></td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">        sounds::sound( pos(), current_ammo-&gt;ammo-&gt;loudness, sounds::sound_t::combat, <span class='macro'>_( <span class='string_literal'>"Crack!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Crack!" ) ) )</span></span>, <span class='keyword'>true</span> );</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">        <span class='keyword'>const</span> itype_id casing = *current_ammo-&gt;ammo-&gt;casing;</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">        <span class='keyword'>if</span>( cur_weapon.get_item()-&gt;has_flag( flag_RELOAD_EJECT ) ) {</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">            cur_weapon.get_item()-&gt;force_insert_item( item( casing ).set_flag( flag_CASING ),</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">                    pocket_type::MAGAZINE );</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">            cur_weapon.get_item()-&gt;on_contents_changed();</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">    <span class='keyword'>if</span>( technique.side_switch &amp;&amp; !t.has_flag( mon_flag_IMMOBILE ) ) {</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">        <span class='keyword'>const</span> tripoint b = t.pos();</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">        point new_;</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">        <span class='keyword'>if</span>( b.x &gt; posx() ) {</td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">            new_.x = posx() - 1;</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( b.x &lt; posx() ) {</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">            new_.x = posx() + 1;</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">            new_.x = b.x;</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">        <span class='keyword'>if</span>( b.y &gt; posy() ) {</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">            new_.y = posy() - 1;</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( b.y &lt; posy() ) {</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">            new_.y = posy() + 1;</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">            new_.y = b.y;</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">        <span class='keyword'>const</span> tripoint &amp;dest = tripoint( new_, b.z );</td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">        <span class='keyword'>if</span>( g-&gt;is_empty( dest ) ) {</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">            t.setpos( dest );</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">    map &amp;here = get_map();</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">    <span class='keyword'>if</span>( technique.knockback_dist &amp;&amp; !t.has_flag( mon_flag_IMMOBILE ) ) {</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">        <span class='keyword'>const</span> tripoint prev_pos = t.pos(); <span class='comment'>// track target startpoint for knockback_follow</span></td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">        <span class='keyword'>const</span> point kb_offset( rng( -technique.knockback_spread, technique.knockback_spread ),</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">                               rng( -technique.knockback_spread, technique.knockback_spread ) );</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">        tripoint kb_point( posx() + kb_offset.x, posy() + kb_offset.y, posz() );</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>int</span> dist = rng( 1, technique.knockback_dist ); dist &gt; 0; dist-- ) {</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">            t.knock_back_from( kb_point );</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">        Character *passenger = t.as_character();</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">        <span class='keyword'>if</span>( passenger &amp;&amp; passenger-&gt;in_vehicle ) {</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">            here.unboard_vehicle( prev_pos );</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">        <span class='comment'>// This technique makes the player follow into the tile the target was knocked from</span></td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">        <span class='keyword'>if</span>( technique.knockback_follow ) {</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">            <span class='keyword'>const</span> optional_vpart_position vp0 = here.veh_at( pos() );</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">            vehicle *<span class='keyword'>const</span> veh0 = veh_pointer_or_null( vp0 );</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">            <span class='keyword'>bool</span> to_swimmable = here.has_flag( ter_furn_flag::TFLAG_SWIMMABLE, prev_pos );</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line">            <span class='keyword'>bool</span> to_deepwater = here.has_flag( ter_furn_flag::TFLAG_DEEP_WATER, prev_pos );</td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">            <span class='comment'>// Check if it's possible to move to the new tile</span></td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">            <span class='keyword'>bool</span> move_issue =</td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">                g-&gt;is_dangerous_tile( prev_pos ) || <span class='comment'>// Tile contains fire, etc</span></td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">                ( to_swimmable &amp;&amp; to_deepwater ) || <span class='comment'>// Dive into deep water</span></td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">                is_mounted() ||</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">                ( veh0 != <span class='keyword'>nullptr</span> &amp;&amp; std::abs( veh0-&gt;velocity ) &gt; 100 ) || <span class='comment'>// Diving from moving vehicle</span></td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line">                ( veh0 != <span class='keyword'>nullptr</span> &amp;&amp; veh0-&gt;player_in_control( get_avatar() ) ) || <span class='comment'>// Player is driving</span></td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line">                has_effect( effect_amigara ) ||</td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">                has_flag( json_flag_GRAB );</td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line">            <span class='keyword'>if</span>( !move_issue ) {</td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">                <span class='keyword'>if</span>( t.pos() != prev_pos ) {</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">                    g-&gt;place_player( prev_pos );</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">                    g-&gt;on_move_effects();</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">        <span class='comment'>// Remove our grab if we knocked back our grabber (if we can do so is handled by tech conditions)</span></td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">        <span class='keyword'>if</span>( has_flag( json_flag_GRAB ) &amp;&amp; t.has_effect_with_flag( json_flag_GRAB_FILTER ) ) {</td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">            <span class='keyword'>for</span>( <span class='keyword'>const</span> effect &amp;eff : get_effects_with_flag( json_flag_GRAB ) ) {</td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">                <span class='keyword'>if</span>( t.is_monster() ) {</td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">                    monster *m = t.as_monster();</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">                    <span class='keyword'>if</span>( m-&gt;is_grabbing( eff.get_bp().id() ) ) {</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">                        m-&gt;remove_grab( eff.get_bp().id() );</td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">                        remove_effect( eff.get_id(), eff.get_bp() );</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">                        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Grabber %s knocked back, grab on %s removed"</span>, t.get_name(),<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Grabber %s knocked back, grab on %s removed"<br>, t.get_name(), eff.get_bp()-&gt;name ) ) ); } } while( false<br> )</span></span></td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line">                                       <span class='macro'>eff.get_bp()-&gt;name )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Grabber %s knocked back, grab on %s removed"<br>, t.get_name(), eff.get_bp()-&gt;name ) ) ); } } while( false<br> )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">    Character *you = <span class='keyword'>dynamic_cast</span>&lt;Character *&gt;( &amp;t );</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">    <span class='keyword'>if</span>( technique.take_weapon &amp;&amp; !has_weapon() &amp;&amp; you != <span class='keyword'>nullptr</span> &amp;&amp; you-&gt;is_armed() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">        !you-&gt;is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">        <span class='keyword'>if</span>( you-&gt;is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">            add_msg_if_npc( <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; disarms you and takes your weapon!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; disarms you and takes your weapon!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">            add_msg_player_or_npc( <span class='macro'>_( <span class='string_literal'>"You disarm %s and take their weapon!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You disarm %s and take their weapon!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">                                   <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; disarms %s and takes their weapon!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; disarms %s and takes their weapon!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">                                   you-&gt;get_name() );</td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">        item it = you-&gt;remove_weapon();</td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        wield( it );</td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">    <span class='keyword'>if</span>( technique.disarms &amp;&amp; you != <span class='keyword'>nullptr</span> &amp;&amp; you-&gt;is_armed() &amp;&amp; !you-&gt;is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">        item weap = you-&gt;remove_weapon();</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">        here.add_item_or_charges( you-&gt;pos(), weap );</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">        <span class='keyword'>if</span>( you-&gt;is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">            add_msg_if_npc( <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; disarms you!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; disarms you!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">            add_msg_player_or_npc( <span class='macro'>_( <span class='string_literal'>"You disarm %s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You disarm %s!" ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">                                   <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; disarms %s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; disarms %s!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">                                   you-&gt;get_name() );</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">    <span class='comment'>//AOE attacks, feel free to skip over this lump</span></td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">    <span class='keyword'>if</span>( !technique.aoe.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">        <span class='comment'>// Remember out moves and stamina</span></td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">        <span class='comment'>// We don't want to consume them for every attack!</span></td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>int</span> temp_moves = moves;</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>int</span> temp_stamina = get_stamina();</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">        std::vector&lt;Creature *&gt; targets;</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">        valid_aoe_technique( t, technique, targets );</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">        <span class='comment'>//hit only one valid target (pierce through doesn't spread out)</span></td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">        <span class='keyword'>if</span>( technique.aoe == <span class='string_literal'>"impale"</span> ) {</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">            <span class='comment'>// TODO: what if targets is empty</span></td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">            Creature *<span class='keyword'>const</span> v = random_entry( targets );</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">            targets.clear();</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">            targets.push_back( v );</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">        <span class='comment'>//hit the targets in the lists (all candidates if wide or burst, or just the unlucky sod if deep)</span></td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">        <span class='keyword'>int</span> count_hit = 0;</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">        <span class='keyword'>for</span>( Creature *<span class='keyword'>const</span> c : targets ) {</td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">            melee_attack( *c, <span class='keyword'>false</span> );</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line">        t.add_msg_if_player( m_good, n_gettext( <span class='string_literal'>"%d enemy hit!"</span>, <span class='string_literal'>"%d enemies hit!"</span>, count_hit ),</td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">                             count_hit );</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">        <span class='comment'>// Extra attacks are free of charge (otherwise AoE attacks would SUCK)</span></td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">        moves = temp_moves;</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">        set_stamina( temp_stamina );</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line"><span class='keyword'>int</span> melee::blocking_ability( <span class='keyword'>const</span> item &amp;shield )</td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">    <span class='keyword'>int</span> block_bonus = 0;</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">    <span class='keyword'>if</span>( shield.has_technique( WBLOCK_3 ) ) {</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">        block_bonus = 10;</td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( shield.has_technique( WBLOCK_2 ) ) {</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">        block_bonus = 6;</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( shield.has_technique( WBLOCK_1 ) ) {</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">        block_bonus = 4;</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( shield.has_flag( flag_BLOCK_WHILE_WORN ) ) {</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">        block_bonus = 2;</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">    <span class='keyword'>return</span> block_bonus;</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">item_location Character::best_shield()</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">    <span class='comment'>// Note: wielded weapon, not one used for attacks</span></td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">    <span class='keyword'>int</span> best_value = melee::blocking_ability( weapon );</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">    <span class='comment'>// "BLOCK_WHILE_WORN" without a blocking tech need to be worn for the bonus</span></td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">    best_value = best_value == 2 ? 0 : best_value;</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">    item_location best = best_value &gt; 0 ? get_wielded_item() : item_location();</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">    item *best_worn = worn.best_shield();</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">    <span class='keyword'>if</span>( best_worn &amp;&amp; melee::blocking_ability( *best_worn ) &gt;= best_value ) {</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">        best = item_location( *<span class='keyword'>this</span>, best_worn );</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">    <span class='keyword'>return</span> best;</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line"><span class='keyword'>bool</span> Character::block_hit( Creature *source, bodypart_id &amp;bp_hit, damage_instance &amp;dam )</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">    <span class='comment'>// Shouldn't block if player is asleep or winded</span></td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">    <span class='keyword'>if</span>( in_sleep_state() || has_effect( effect_narcosis ) ||</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">        has_effect( effect_winded ) || has_effect( effect_fearparalyze ) || is_driving() ) {</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">    <span class='comment'>// fire martial arts on-getting-hit-triggered effects</span></td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">    <span class='comment'>// these fire even if the attack is blocked (you still got hit)</span></td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">    martial_arts_data-&gt;ma_ongethit_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">    <span class='keyword'>if</span>( blocks_left &lt; 1 ) {</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">    <span class='comment'>// Melee skill and reaction score governs if you can react in time</span></td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">    <span class='comment'>// Skill of 5 without relevant encumbrance guarantees a block attempt</span></td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">    <span class='keyword'>float</span> melee_skill = has_active_bionic( bio_cqb ) ? 5 : get_skill_level( skill_melee );</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">    <span class='keyword'>if</span>( !x_in_y( melee_skill * 20.0 * get_limb_score( limb_score_reaction ), 100 ) ) {</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Block roll failed"</span> )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Block roll failed"<br> ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">    blocks_left--;</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">    <span class='comment'>// This bonus absorbs damage from incoming attacks before they land,</span></td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">    <span class='comment'>// but it still counts as a block even if it absorbs all the damage.</span></td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">    <span class='keyword'>float</span> total_phys_block = mabuff_block_bonus();</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">    <span class='comment'>// Extract this to make it easier to implement shields/multiwield later</span></td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">    item_location shield = best_shield();</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">    <span class='comment'>// Check if we are going to block with an item. This could</span></td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">    <span class='comment'>// be worn equipment with the BLOCK_WHILE_WORN flag.</span></td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>bool</span> has_shield = !!shield;</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">    <span class='keyword'>bool</span> worn_shield = has_shield &amp;&amp; shield-&gt;has_flag( flag_BLOCK_WHILE_WORN );</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">    <span class='keyword'>bool</span> conductive_shield = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line">    <span class='keyword'>bool</span> unarmed = !is_armed();</td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line">    <span class='keyword'>bool</span> force_unarmed = martial_arts_data-&gt;is_force_unarmed();</td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">    <span class='keyword'>bool</span> allow_weapon_blocking = martial_arts_data-&gt;can_weapon_block();</td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">    <span class='keyword'>bool</span> armed_body_block = weapon.has_flag( flag_ALLOWS_BODY_BLOCK );</td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">    <span class='comment'>// boolean check if blocking is being done with unarmed or not</span></td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>bool</span> item_blocking = allow_weapon_blocking &amp;&amp; has_shield &amp;&amp; !unarmed &amp;&amp; !armed_body_block;</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">    <span class='keyword'>bool</span> arm_block = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">    <span class='keyword'>bool</span> leg_block = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">    <span class='keyword'>bool</span> nonstandard_block = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">    <span class='keyword'>int</span> unarmed_skill = round( get_skill_level( skill_unarmed ) );</td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">    <span class='keyword'>int</span> block_score = 1;</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">    <span class='keyword'>if</span>( has_shield ) {</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line">        block_bonus = melee::blocking_ability( *shield );</td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">        conductive_shield = shield-&gt;conductive();</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">    <span class='comment'>/** @ARM_STR increases attack blocking effectiveness with a limb or worn/wielded item */</span></td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">    <span class='comment'>/** @EFFECT_UNARMED increases attack blocking effectiveness with a limb or worn item */</span></td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">    <span class='keyword'>if</span>( unarmed || force_unarmed || worn_shield || armed_body_block || ( has_shield &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">            !allow_weapon_blocking ) ) {</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">        arm_block = martial_arts_data-&gt;can_arm_block( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">        leg_block = martial_arts_data-&gt;can_leg_block( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">        nonstandard_block = martial_arts_data-&gt;can_nonstandard_block( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">        <span class='keyword'>if</span>( arm_block || leg_block || nonstandard_block ) {</td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">            <span class='comment'>// block_bonus for limb blocks will be added when the limb is decided</span></td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">            block_score = get_arm_str() + unarmed_skill;</td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">            <span class='comment'>// We don't have a shield or a technique. How are we blocking?</span></td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">            <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">        <span class='comment'>// Do we block with a weapon? Worn shields are already filtered out</span></td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">        <span class='comment'>// And weapon blocks are preferred by best_shield</span></td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( has_shield ) {</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">        block_score = get_arm_str() + block_bonus + melee_skill;</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">        <span class='comment'>// Can't block with limbs or items (do not block)</span></td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">    <span class='comment'>// add martial arts block effectiveness bonus</span></td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">    block_score += mabuff_block_effectiveness_bonus();</td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">    <span class='comment'>// weapon blocks are preferred to limb blocks</span></td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">    std::string thing_blocked_with;</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">    <span class='comment'>// Do we block with a weapon? Handle melee wear but leave bp the same</span></td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">    <span class='keyword'>if</span>( !( unarmed || force_unarmed || worn_shield || armed_body_block ) &amp;&amp; allow_weapon_blocking ) {</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">        thing_blocked_with = shield-&gt;tname();</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">        <span class='comment'>// TODO: Change this depending on damage blocked</span></td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">        <span class='keyword'>float</span> wear_modifier = 1.0f;</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">        <span class='keyword'>if</span>( source != <span class='keyword'>nullptr</span> &amp;&amp; source-&gt;is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">            wear_modifier = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">        handle_melee_wear( shield, wear_modifier );</td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">    }  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">        <span class='comment'>// Select part to block with, preferring worn blocking armor if applicable</span></td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">        bp_hit = select_blocking_part( arm_block, leg_block, nonstandard_block );</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">        block_score *= get_part( bp_hit )-&gt;get_limb_score( limb_score_block );</td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">        <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Block score after multiplier %d"</span>, block_score )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Block score after multiplier %d"<br>, block_score ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">        <span class='keyword'>if</span>( worn_shield &amp;&amp; shield-&gt;covers( bp_hit ) ) {</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">            thing_blocked_with = shield-&gt;tname();</td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">            <span class='keyword'>if</span>( source != <span class='keyword'>nullptr</span> &amp;&amp; !source-&gt;is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">                <span class='keyword'>for</span>( damage_unit &amp;du : dam.damage_units ) {</td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">                    shield-&gt;damage_armor_durability( du, bp_hit );</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">            block_score += block_bonus;</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">            thing_blocked_with = body_part_name( bp_hit );</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">    <span class='comment'>// Map block_score to the logistic curve for a number between 1 and 0.</span></td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">    <span class='comment'>// Basic beginner character (str 8, skill 0, basic weapon)</span></td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">    <span class='comment'>// Will have a score around 10 and block about %15 of incoming damage.</span></td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">    <span class='comment'>// More proficient melee character (str 10, skill 4, wbock_2 weapon)</span></td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">    <span class='comment'>// will have a score of 20 and block about 45% of damage.</span></td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">    <span class='comment'>// A highly expert character (str 14, skill 8 wblock_2)</span></td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">    <span class='comment'>// will have a score in the high 20s and will block about 80% of damage.</span></td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">    <span class='comment'>// As the block score approaches 40, damage making it through will dwindle</span></td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">    <span class='comment'>// to nothing, at which point we're relying on attackers hitting enough to drain blocks.</span></td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> physical_block_multiplier = logarithmic_range( 0, 40, block_score );</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Physical block multiplier %.1f"</span>, physical_block_multiplier )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Physical block multiplier %.1f"<br>, physical_block_multiplier ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">    <span class='keyword'>float</span> total_damage = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">    <span class='keyword'>float</span> damage_blocked = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">    <span class='keyword'>for</span>( damage_unit &amp;elem : dam.damage_units ) {</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">        total_damage += elem.amount;</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">        <span class='comment'>// block physical damage "normally"</span></td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">        <span class='keyword'>if</span>( elem.type-&gt;physical &amp;&amp; elem.type-&gt;melee_only ) {</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">            <span class='comment'>// use up our flat block bonus first</span></td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">            <span class='keyword'>float</span> block_amount = std::min( total_phys_block, elem.amount );</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">            total_phys_block -= block_amount;</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">            elem.amount -= block_amount;</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">            damage_blocked += block_amount;</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">            <span class='keyword'>if</span>( elem.amount &lt;= std::numeric_limits&lt;<span class='keyword'>float</span>&gt;::epsilon() ) {</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">            <span class='keyword'>float</span> previous_amount = elem.amount;</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line">            elem.amount *= physical_block_multiplier;</td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">            damage_blocked += previous_amount - elem.amount;</td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span>( !elem.type-&gt;physical &amp;&amp; !elem.type-&gt;no_resist ) {</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">            <span class='comment'>// electrical damage deals full damage if unarmed OR wielding a conductive weapon</span></td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">            <span class='comment'>// non-electrical "elemental" damage types do their full damage if unarmed,</span></td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">            <span class='comment'>// but severely mitigated damage if not</span></td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">            <span class='keyword'>bool</span> can_block = elem.type == <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"electric"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "electric"<br> ) ))&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "electric" ) ); return _cached_expr; })())</span></span> ? !conductive_shield : <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">            <span class='comment'>// Unarmed weapons won't block those</span></td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">            <span class='keyword'>if</span>( item_blocking &amp;&amp; can_block ) {</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">                <span class='keyword'>float</span> previous_amount = elem.amount;</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line">                elem.amount /= 5;</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">                damage_blocked += previous_amount - elem.amount;</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line">    std::string damage_blocked_description;</td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line">    <span class='comment'>// good/bad/ugly add_msg color code?</span></td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">    <span class='comment'>// none, hardly any, a little, some, most, all</span></td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">    <span class='keyword'>float</span> blocked_ratio = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">    <span class='keyword'>if</span>( total_damage &gt; std::numeric_limits&lt;<span class='keyword'>float</span>&gt;::epsilon() ) {</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">        blocked_ratio = ( total_damage - damage_blocked ) / total_damage;</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">    <span class='keyword'>if</span>( blocked_ratio &lt; std::numeric_limits&lt;<span class='keyword'>float</span>&gt;::epsilon() ) {</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"all"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "all" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( blocked_ratio &lt; 0.2 ) {</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"nearly all"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "nearly all" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( blocked_ratio &lt; 0.4 ) {</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"most"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "most" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( blocked_ratio &lt; 0.6 ) {</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"a lot"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "a lot" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( blocked_ratio &lt; 0.8 ) {</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"some"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "some" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( blocked_ratio &gt; std::numeric_limits&lt;<span class='keyword'>float</span>&gt;::epsilon() ) {</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"a little"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "a little" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">        <span class='comment'>//~ Adjective in "You block &lt;adjective&gt; of the damage with your &lt;weapon&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">        damage_blocked_description = <span class='macro'>_( <span class='string_literal'>"none"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "none" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">    add_msg_player_or_npc( <span class='macro'>_( <span class='string_literal'>"You block %1$s of the damage with your %2$s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You block %1$s of the damage with your %2$s!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">                           <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; blocks %1$s of the damage with their %2$s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; blocks %1$s of the damage with their %2$s!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">                           damage_blocked_description, thing_blocked_with );</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"Blocked damage %.1f / %.1f"</span>, total_damage, damage_blocked )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "Blocked damage %.1f / %.1f"<br>, total_damage, damage_blocked ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">    <span class='comment'>// fire martial arts block-triggered effects</span></td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">    martial_arts_data-&gt;ma_onblock_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">    <span class='comment'>// Check if we have any block counters</span></td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">    matec_id tec = pick_technique( *source, shield, <span class='keyword'>false</span>, <span class='keyword'>false</span>, <span class='keyword'>true</span> );</td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">    <span class='keyword'>if</span>( tec != tec_none &amp;&amp; !is_dead_state() ) {</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">        <span class='keyword'>int</span> twenty_percent = std::round( ( 20 * weapon.type-&gt;mat_portion_total ) / 100.0f );</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">        <span class='keyword'>if</span>( get_stamina() &lt; get_stamina_max() / 3 ) {</td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">            add_msg( m_bad, <span class='macro'>_( <span class='string_literal'>"You try to counterattack but you are too exhausted!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You try to counterattack but you are too exhausted!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( weapon.made_of( material_glass ) &gt; twenty_percent ) {</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">            add_msg( m_bad, <span class='macro'>_( <span class='string_literal'>"The item you are wielding is too fragile to counterattack with!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The item you are wielding is too fragile to counterattack with!"<br> ) ) )</span></span> );</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">            melee_attack( *source, <span class='keyword'>false</span>, tec );</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">    <span class='keyword'>return</span> <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line"><span class='keyword'>void</span> Character::perform_special_attacks( Creature &amp;t, dealt_damage_instance &amp;dealt_dam )</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    std::vector&lt;special_attack&gt; special_attacks = mutation_attacks( t );</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">    <span class='keyword'>bool</span> practiced = <span class='keyword'>false</span>;</td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> special_attack &amp;att : special_attacks ) {</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">        <span class='keyword'>if</span>( t.is_dead_state() ) {</td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">        <span class='comment'>// TODO: Make this hit roll use unarmed skill, not weapon skill + weapon to_hit</span></td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">        <span class='keyword'>int</span> hit_spread = t.deal_melee_attack( <span class='keyword'>this</span>, hit_roll() * 0.8 );</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">        <span class='keyword'>if</span>( hit_spread &gt;= 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">            weakpoint_attack attack;</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">            t.deal_melee_hit( <span class='keyword'>this</span>, hit_spread, <span class='keyword'>false</span>, att.damage, dealt_dam, attack );</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">            <span class='keyword'>if</span>( !practiced ) {</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line">                <span class='comment'>// Practice unarmed, at most once per combo</span></td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">                practiced = <span class='keyword'>true</span>;</td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">                practice( skill_unarmed, rng( 0, 10 ) );</td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">        <span class='keyword'>int</span> dam = dealt_dam.total_damage();</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">        <span class='keyword'>if</span>( dam &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">            player_hit_message( <span class='keyword'>this</span>, att.text, t, dam );</td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">std::string Character::melee_special_effects( Creature &amp;t, damage_instance &amp;d, item &amp;weap )</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">    std::string dump;</td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">    std::string target = t.disp_name();</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">    <span class='keyword'>if</span>( has_active_bionic( bio_shock ) &amp;&amp; get_power_level() &gt;= bio_shock-&gt;power_trigger &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">        ( weap.is_null() || weapon.conductive() ) ) {</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">        mod_power_level( -bio_shock-&gt;power_trigger );</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">        d.add_damage( <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"electric"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "electric"<br> ) ))&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "electric" ) ); return _cached_expr; })())</span></span>, rng( 2, 10 ) );</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">        <span class='keyword'>if</span>( is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">            dump += string_format( <span class='macro'>_( <span class='string_literal'>"You shock %s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You shock %s." ) ) )</span></span>, target ) + <span class='string_literal'>"\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line">            add_msg_if_npc( <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; shocks %s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; shocks %s." )<br> ) )</span></span>, target );</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">    <span class='keyword'>if</span>( has_active_bionic( bio_heat_absorb ) &amp;&amp; weap.is_null() &amp;&amp; t.is_warm() ) {</td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">        mod_power_level( bio_heat_absorb-&gt;power_trigger );</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">        d.add_damage( <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"cold"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "cold" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "cold" ) ); return _cached_expr; })())</span></span>, 3 );</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">        <span class='keyword'>if</span>( is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">            dump += string_format( <span class='macro'>_( <span class='string_literal'>"You drain %s's body heat."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You drain %s's body heat." )<br> ) )</span></span>, target ) + <span class='string_literal'>"\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">            add_msg_if_npc( <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; drains %s's body heat!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; drains %s's body heat!"<br> ) ) )</span></span>, target );</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">    <span class='keyword'>if</span>( weap.has_flag( flag_FLAMING ) ) {</td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">        d.add_damage( <span class='macro'>STATIC( damage_type_id( <span class='string_literal'>"heat"</span> ) )<span class='macro_popup'>(([]()-&gt; const auto &amp;{ using ExprType = std::decay_t&lt;<br>decltype(static_argument_identity( damage_type_id( "heat" ) )<br>)&gt;; using CachedType = std::conditional_t&lt;std::is_same_v<br>&lt;ExprType, const char*&gt;, std::string, ExprType&gt;; static<br> const CachedType _cached_expr = static_argument_identity( damage_type_id<br>( "heat" ) ); return _cached_expr; })())</span></span>, rng( 1, 8 ) );</td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">        <span class='keyword'>if</span>( is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">            dump += string_format( <span class='macro'>_( <span class='string_literal'>"You burn %s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You burn %s." ) ) )</span></span>, target ) + <span class='string_literal'>"\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">            add_msg_player_or_npc( <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt; burns %s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt; burns %s." )<br> ) )</span></span>, target );</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">    <span class='comment'>//Hurting the wielder from poorly-chosen weapons</span></td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">    <span class='keyword'>if</span>( weap.has_flag( flag_HURT_WHEN_WIELDED ) &amp;&amp; x_in_y( 2, 3 ) ) {</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">        add_msg_if_player( m_bad, <span class='macro'>_( <span class='string_literal'>"The %s cuts your hand!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The %s cuts your hand!" ) ) )</span></span>, weap.tname() );</td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">        damage_instance di = damage_instance();</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">        di.add_damage( damage_cut, weap.damage_melee( damage_cut ) );</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">        deal_damage( <span class='keyword'>nullptr</span>, bodypart_id( <span class='string_literal'>"hand_r"</span> ), di );</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">        <span class='keyword'>if</span>( weap.is_two_handed( *<span class='keyword'>this</span> ) ) { <span class='comment'>// Hurt left hand too, if it was big</span></td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">            deal_damage( <span class='keyword'>nullptr</span>, bodypart_id( <span class='string_literal'>"hand_l"</span> ), di );</td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">    <span class='comment'>// Glass weapons shatter sometimes</span></td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> glass_portion = weap.made_of( material_glass );</td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line">    <span class='keyword'>float</span> glass_fraction = glass_portion / <span class='keyword'>static_cast</span>&lt;<span class='keyword'>float</span>&gt;( weap.type-&gt;mat_portion_total );</td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">    <span class='keyword'>if</span>( std::isnan( glass_fraction ) || glass_fraction &gt; 1.f ) {</td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line">        glass_fraction = 0.f;</td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line">    <span class='comment'>// only consider portion of weapon made of glass</span></td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> vol = weap.volume() * glass_fraction / 250_ml;</td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line">    <span class='keyword'>if</span>( glass_portion &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">        <span class='comment'>/** @ARM_STR increases chance of breaking glass weapons (NEGATIVE) */</span></td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">        rng_float( 0.0f, vol + 8 ) &lt; vol + get_arm_str() ) {</td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line">        <span class='keyword'>if</span>( is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">            dump += string_format( <span class='macro'>_( <span class='string_literal'>"Your %s shatters!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your %s shatters!" ) ) )</span></span>, weap.tname() ) + <span class='string_literal'>"\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">            add_msg_player_or_npc( m_bad, <span class='macro'>_( <span class='string_literal'>"Your %s shatters!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Your %s shatters!" ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">                                   <span class='macro'>_( <span class='string_literal'>"&lt;npcname&gt;'s %s shatters!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "&lt;npcname&gt;'s %s shatters!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">                                   weap.tname() );</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">        sounds::sound( pos(), 16, sounds::sound_t::combat, <span class='string_literal'>"Crack!"</span>, <span class='keyword'>true</span>, <span class='string_literal'>"smash_success"</span>,</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">                       <span class='string_literal'>"smash_glass_contents"</span> );</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">        <span class='comment'>// Dump its contents on the ground</span></td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">        weap.spill_contents( pos() );</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">        <span class='comment'>// Take damage</span></td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">        damage_instance di = damage_instance();</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">        di.add_damage( damage_cut, rng( 0, vol * 2 ) );</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">        deal_damage( <span class='keyword'>nullptr</span>, bodypart_id( <span class='string_literal'>"arm_r"</span> ), di );</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">        <span class='keyword'>if</span>( weap.is_two_handed( *<span class='keyword'>this</span> ) ) { <span class='comment'>// Hurt left arm too, if it was big</span></td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line">            <span class='comment'>//redeclare shatter_dam because deal_damage mutates it</span></td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">            deal_damage( <span class='keyword'>nullptr</span>, bodypart_id( <span class='string_literal'>"arm_l"</span> ), di );</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">        d.add_damage( damage_cut, rng( 0, 5 + <span class='keyword'>static_cast</span>&lt;<span class='keyword'>int</span>&gt;( vol * 1.5 ) ) ); <span class='comment'>// Hurt the monster extra</span></td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">        remove_weapon();</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">    <span class='comment'>// on-hit effects for martial arts</span></td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">    martial_arts_data-&gt;ma_onhit_effects( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">    <span class='keyword'>return</span> dump;</td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line"><span class='keyword'>static</span> damage_instance hardcoded_mutation_attack( <span class='keyword'>const</span> Character &amp;u, <span class='keyword'>const</span> trait_id &amp;id )</td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line">    <span class='keyword'>if</span>( id == trait_BEAK_PECK ) {</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">        <span class='comment'>// method open to improvement, please feel free to suggest</span></td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">        <span class='comment'>// a better way to simulate target's anti-peck efforts</span></td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">        <span class='comment'>/** @EFFECT_DEX increases number of hits with BEAK_PECK */</span></td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">        <span class='comment'>/** @EFFECT_UNARMED increases number of hits with BEAK_PECK */</span></td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line">        <span class='keyword'>int</span> num_hits = std::max( 1, std::min&lt;<span class='keyword'>int</span>&gt;( 6,</td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">                                 u.get_dex() + u.get_skill_level( skill_unarmed ) - rng( 4, 10 ) ) );</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">        damage_instance di = damage_instance();</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">        di.add_damage( damage_stab, num_hits * 10 );</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">        <span class='keyword'>return</span> di;</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">    <span class='keyword'>if</span>( id == trait_ARM_TENTACLES || id == trait_ARM_TENTACLES_4 || id == trait_ARM_TENTACLES_8 ) {</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">        <span class='keyword'>int</span> num_attacks = 1;</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">        <span class='keyword'>if</span>( id == trait_ARM_TENTACLES_4 ) {</td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">            num_attacks = 3;</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( id == trait_ARM_TENTACLES_8 ) {</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">            num_attacks = 7;</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">        <span class='comment'>// Note: we're counting arms, so we want wielded item here, not weapon used for attack</span></td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line">        <span class='keyword'>if</span>( ( u.get_wielded_item() &amp;&amp; u.get_wielded_item()-&gt;is_two_handed( u ) ) ||</td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">            !u.has_two_arms_lifting() || u.worn_with_flag( flag_RESTRICT_HANDS ) ) {</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line">            num_attacks--;</td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">        <span class='keyword'>if</span>( num_attacks &lt;= 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">            <span class='keyword'>return</span> damage_instance();</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>bool</span> rake = u.has_trait( trait_CLAWS_TENTACLE );</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">        <span class='comment'>/** @EFFECT_STR increases damage with ARM_TENTACLES* */</span></td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">        damage_instance ret;</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">        <span class='keyword'>if</span>( rake ) {</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">            ret.add_damage( damage_cut, u.get_str() / 2.0f + 1.0f, 0, 1.0f, num_attacks );</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">            ret.add_damage( damage_bash, u.get_str() / 3.0f + 1.0f, 0, 1.0f, num_attacks );</td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">        <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line">    <span class='keyword'>if</span>( id == trait_VINES2 || id == trait_VINES3 ) {</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>int</span> num_attacks = id == trait_VINES2 ? 2 : 3;</td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">        <span class='comment'>/** @EFFECT_STR increases damage with VINES* */</span></td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">        damage_instance ret;</td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">        ret.add_damage( damage_bash, u.get_str() / 2.0f, 0, 1.0f, num_attacks );</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">        <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">    <span class='macro'>debugmsg( <span class='string_literal'>"Invalid hardcoded mutation id: %s"</span>, id.c_str() )<span class='macro_popup'>realDebugmsg("/usr/STLcheck/sekitest/Cataclysm-DDA/src/melee.cpp"<br>, "2447", __PRETTY_FUNCTION__, "Invalid hardcoded mutation id: %s"<br>, id.c_str())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">    <span class='keyword'>return</span> damage_instance();</td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">std::vector&lt;special_attack&gt; Character::mutation_attacks( Creature &amp;t ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">    std::vector&lt;special_attack&gt; ret;</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">    std::string target = t.disp_name();</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">    <span class='keyword'>const</span> body_part_set usable_body_parts = exclusive_flag_coverage( flag_ALLOWS_NATURAL_ATTACKS );</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> unarmed = get_skill_level( skill_unarmed );</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> trait_id &amp;pr : get_mutations() ) {</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">        <span class='keyword'>const</span> mutation_branch &amp;branch = pr.obj();</td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">        <span class='keyword'>for</span>( <span class='keyword'>const</span> mut_attack &amp;mut_atk : branch.attacks_granted ) {</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">            <span class='comment'>// Covered body part</span></td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">            <span class='keyword'>if</span>( !mut_atk.bp.is_empty() &amp;&amp; !usable_body_parts.test( mut_atk.bp ) ) {</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">            <span class='comment'>/** @EFFECT_UNARMED increases chance of attacking with mutated body parts */</span></td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">            <span class='comment'>/** @EFFECT_DEX increases chance of attacking with mutated body parts */</span></td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">            <span class='comment'>// Calculate actor ability value to be compared against mutation attack difficulty and add debug message</span></td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>int</span> proc_value = get_dex() + unarmed;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">            <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s proc chance: %d in %d"</span>, pr.c_str(), proc_value,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s proc chance: %d in %d"<br>, pr.c_str(), proc_value, mut_atk.chance ) ) ); } } while( false<br> )</span></span></td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">                           <span class='macro'>mut_atk.chance )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s proc chance: %d in %d"<br>, pr.c_str(), proc_value, mut_atk.chance ) ) ); } } while( false<br> )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">            <span class='comment'>// If the mutation attack fails to proc, bail out</span></td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">            <span class='keyword'>if</span>( !x_in_y( proc_value, mut_atk.chance ) ) {</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">            <span class='comment'>// If player has any blocker, bail out</span></td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">            <span class='keyword'>if</span>( std::any_of( mut_atk.blocker_mutations.begin(), mut_atk.blocker_mutations.end(),</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">            [<span class='keyword'>this</span>]( <span class='keyword'>const</span> trait_id &amp; blocker ) {</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line">            <span class='keyword'>return</span> has_trait( blocker );</td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">            } ) ) {</td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">                <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s not procing: blocked"</span>, pr.c_str() )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s not procing: blocked"<br>, pr.c_str() ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">            <span class='comment'>// Player must have all needed traits</span></td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">            <span class='keyword'>if</span>( !std::all_of( mut_atk.required_mutations.begin(), mut_atk.required_mutations.end(),</td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">            [<span class='keyword'>this</span>]( <span class='keyword'>const</span> trait_id &amp; need ) {</td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">            <span class='keyword'>return</span> has_trait( need );</td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">            } ) ) {</td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">                <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s not procing: unmet req"</span>, pr.c_str() )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s not procing: unmet req"<br>, pr.c_str() ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">            special_attack tmp;</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">            <span class='comment'>// Ugly special case: player's strings have only 1 variable, NPC have 2</span></td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">            <span class='comment'>// Can't use &lt;npcname&gt; here</span></td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">            <span class='comment'>// TODO: Fix</span></td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">            <span class='keyword'>if</span>( is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">                tmp.text = string_format( mut_atk.attack_text_u.translated(), target );</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">                tmp.text = string_format( mut_atk.attack_text_npc.translated(), get_name(), target );</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">            <span class='comment'>// Attack starts here</span></td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">            <span class='keyword'>if</span>( mut_atk.hardcoded_effect ) {</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">                tmp.damage = hardcoded_mutation_attack( *<span class='keyword'>this</span>, pr );</td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">                damage_instance dam = mut_atk.base_damage;</td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">                damage_instance scaled = mut_atk.strength_damage;</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">                scaled.mult_damage( std::min&lt;<span class='keyword'>float</span>&gt;( 15.0f, get_str() ), <span class='keyword'>true</span> );</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">                dam.add( scaled );</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">                tmp.damage = dam;</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">            <span class='keyword'>if</span>( tmp.damage.total_damage() &gt; 0.0f ) {</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">                ret.emplace_back( tmp );</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">                <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s not procing: zero damage"</span>, pr.c_str() )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s not procing: zero damage"<br>, pr.c_str() ) ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line"><span id="start22">std</span>::string melee_message( <span class='keyword'>const</span> ma_technique &amp;tec, Character &amp;p,</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">                           <span class='keyword'>const</span> dealt_damage_instance &amp;ddi )</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">    <span class='comment'>// Those could be extracted to a json</span></td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">    <span class='comment'>// Three last values are for low damage</span></td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">    <span id="start21"><span id="end22"><span class='keyword'>static</span></span></span> <span class='keyword'>const</span> std::array&lt;std::string, 6&gt; player_stab = {{</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You impale %s"</span> )<span class='macro_popup'>"You impale %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You gouge %s"</span> )<span class='macro_popup'>"You gouge %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You run %s through"</span> )<span class='macro_popup'>"You run %s through"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You puncture %s"</span> )<span class='macro_popup'>"You puncture %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You pierce %s"</span> )<span class='macro_popup'>"You pierce %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You poke %s"</span> )<span class='macro_popup'>"You poke %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> std::array&lt;std::string, 6&gt; npc_stab = {{</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; impales %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; impales %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; gouges %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; gouges %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; runs %s through"</span> )<span class='macro_popup'>"&lt;npcname&gt; runs %s through"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; punctures %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; punctures %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; pierces %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; pierces %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; pokes %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; pokes %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">    <span class='comment'>// First 5 are for high damage, next 2 for medium, then for low and then for v. low</span></td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> std::array&lt;std::string, 9&gt; player_cut = {{</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You gut %s"</span> )<span class='macro_popup'>"You gut %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You chop %s"</span> )<span class='macro_popup'>"You chop %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You slash %s"</span> )<span class='macro_popup'>"You slash %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You mutilate %s"</span> )<span class='macro_popup'>"You mutilate %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You maim %s"</span> )<span class='macro_popup'>"You maim %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You stab %s"</span> )<span class='macro_popup'>"You stab %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You slice %s"</span> )<span class='macro_popup'>"You slice %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You cut %s"</span> )<span class='macro_popup'>"You cut %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You nick %s"</span> )<span class='macro_popup'>"You nick %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> std::array&lt;std::string, 9&gt; npc_cut = {{</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; guts %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; guts %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; chops %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; chops %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; slashes %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; slashes %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; mutilates %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; mutilates %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; maims %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; maims %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; stabs %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; stabs %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; slices %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; slices %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; cuts %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; cuts %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; nicks %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; nicks %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">    <span class='comment'>// Three last values are for low damage</span></td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> std::array&lt;std::string, 6&gt; player_bash = {{</td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You clobber %s"</span> )<span class='macro_popup'>"You clobber %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You smash %s"</span> )<span class='macro_popup'>"You smash %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You thrash %s"</span> )<span class='macro_popup'>"You thrash %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You batter %s"</span> )<span class='macro_popup'>"You batter %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You whack %s"</span> )<span class='macro_popup'>"You whack %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"You hit %s"</span> )<span class='macro_popup'>"You hit %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> std::array&lt;std::string, 6&gt; npc_bash = {{</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; clobbers %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; clobbers %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; smashes %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; smashes %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; thrashes %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; thrashes %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; batters %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; batters %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; whacks %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; whacks %s"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">            <span class='macro'>translate_marker( <span class='string_literal'>"&lt;npcname&gt; hits %s"</span> )<span class='macro_popup'>"&lt;npcname&gt; hits %s"</span></span></td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">    <span class='keyword'>int</span> total_dam = 0;</td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">    std::pair&lt;damage_type_id, <span class='keyword'>int</span>&gt; dominant_type = { damage_bash, 0 };</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">    <span class='keyword'>for</span>( <span class='keyword'>const</span> damage_type &amp;dt : damage_type::get_all() ) {</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">        <span class='keyword'>if</span>( dt.melee_only ) {</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">            <span class='keyword'>int</span> dmg = ddi.type_damage( dt.id );</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">            total_dam += dmg;</td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">            <span class='keyword'>if</span>( dominant_type.second &lt; dmg ) {</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">                dominant_type = { dt.id, dmg };</td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">    <span id="start20"><span id="end21"><span class='keyword'>if</span></span></span>( tec.id != tec_none ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path60" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">60</div></td><td><div class="PathNav"><a href="#Path59" title="Previous event (59)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path61" title="Next event (61)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">        std::string message;</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">        <span class='keyword'>if</span>( p.is_npc() ) {</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">            message = tec.npc_message.translated();</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">            message = tec.avatar_message.translated();</td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">        <span class='keyword'>if</span>( !message.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">            <span class='keyword'>return</span> message;</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">    <span id="start17"><span id="end18"><span id="start19"><span id="end20"><span class='keyword'>const</span></span></span></span></span> <span class='keyword'>bool</span> npc = <span id="start18"><span id="end19">p</span></span>.is_npc();</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">    <span class='comment'>// Cutting has more messages and so needs different handling</span></td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>bool</span> cutting = dominant_type.first == damage_cut;</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">    size_t index;</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">    <span id="start16"><span id="end17"><span class='keyword'>if</span></span></span>( <span id="start15"><span id="end16"><span class='variable'>total_dam<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>60.1</div></td><td>'total_dam' is <= 30</td></tr></tbody></table></span></span></span> &gt; 30 ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path61" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">61</div></td><td><div class="PathNav"><a href="#Path60" title="Previous event (60)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path62" title="Next event (62)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">        index = cutting ? rng( 0, 4 ) : rng( 0, 2 );</td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">    } <span class='keyword'>else</span> <span id="start14"><span id="end15"><span class='keyword'>if</span></span></span>( <span id="start13"><span id="end14"><span class='variable'>total_dam<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>61.1</div></td><td>'total_dam' is <= 20</td></tr></tbody></table></span></span></span> &gt; 20 ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path62" class="msg msgControl" style="margin-left:12ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">62</div></td><td><div class="PathNav"><a href="#Path61" title="Previous event (61)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path63" title="Next event (63)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line">        index = cutting ? rng( 5, 6 ) : 3;</td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">    } <span class='keyword'>else</span> <span id="start9"><span id="start12"><span id="end13"><span class='keyword'>if</span></span></span></span>( <span id="start11"><span id="end12"><span class='variable'>total_dam<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>62.1</div></td><td>'total_dam' is <= 10</td></tr></tbody></table></span></span></span> &gt; 10 ) {</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">        index = cutting ? 7 : 4;</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">        <span id="start7"><span id="end8"><span id="end9"><span id="start10"><span id="end11">index</span></span></span></span></span> = <span id="start8"><span id="end10"><span class='variable'>cutting<table class='variable_popup'><tbody><tr><td valign='top'><div class='PathIndex PathIndexPopUp'>63.1</div></td><td>'cutting' is true</td></tr></tbody></table></span></span></span> ? 8 : 5;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path63" class="msg msgControl" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">63</div></td><td><div class="PathNav"><a href="#Path62" title="Previous event (62)">&#x2190;</a></div></td><td>Taking false branch</td><td><div class="PathNav"><a href="#Path64" title="Next event (64)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path64" class="msg msgControl" style="margin-left:17ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">64</div></td><td><div class="PathNav"><a href="#Path63" title="Previous event (63)">&#x2190;</a></div></td><td>'?' condition is true</td><td><div class="PathNav"><a href="#Path65" title="Next event (65)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">    <span id="start6"><span id="end7">std</span></span>::string message;</td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">    <span class='comment'>// FIXME: Hardcoded damage type messages</span></td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">    <span id="start5"><span id="end6"><span class='keyword'>if</span></span></span>( dominant_type.first == damage_stab ) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path65" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">65</div></td><td><div class="PathNav"><a href="#Path64" title="Previous event (64)">&#x2190;</a></div></td><td>Taking true branch</td><td><div class="PathNav"><a href="#Path66" title="Next event (66)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">        <span id="start1"><span id="end2"><span id="start4"><span id="end5">message</span></span></span></span> <span id="end4">=</span> <span id="end1"><span id="start2"><span id="start3"><span class="mrange">npc</span></span></span></span> ? <span class="mrange"><span id="start0"><span id="end0"><span id="end3"><span class='macro'>_</span></span></span></span>( npc_stab[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( npc_stab[index] ) ) )</span></span> : <span class='macro'>_( player_stab[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( player_stab[index] ) ) )</span></span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path66" class="msg msgEvent" style="margin-left:19ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">66</div></td><td><div class="PathNav"><a href="#Path65" title="Previous event (65)">&#x2190;</a></div></td><td>Assuming 'npc' is true</td><td><div class="PathNav"><a href="#Path67" title="Next event (67)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path67" class="msg msgControl" style="margin-left:19ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">67</div></td><td><div class="PathNav"><a href="#Path66" title="Previous event (66)">&#x2190;</a></div></td><td>'?' condition is true</td><td><div class="PathNav"><a href="#EndPath" title="Next event (68)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:25ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">68</div></td><td><div class="PathNav"><a href="#Path67" title="Previous event (67)">&#x2190;</a></div></td><td>Wrong iterator dereferenced</td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( dominant_type.first == damage_cut ) {</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">        message = npc ? <span class='macro'>_( npc_cut[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( npc_cut[index] ) ) )</span></span> : <span class='macro'>_( player_cut[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( player_cut[index] ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( dominant_type.first == damage_bash ) {</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">        message = npc ? <span class='macro'>_( npc_bash[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( npc_bash[index] ) ) )</span></span> : <span class='macro'>_( player_bash[index] )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( player_bash[index] ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">    <span class='keyword'>if</span>( ddi.wp_hit.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">        <span class='keyword'>return</span> message;</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">        <span class='comment'>//~ %1$s: "Somone hit something", %2$s: the weakpoint that was hit</span></td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">        <span class='keyword'>return</span> string_format( <span class='macro'>_( <span class='string_literal'>"%1$s in %2$s"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%1$s in %2$s" ) ) )</span></span>, message, ddi.wp_hit );</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>_( <span class='string_literal'>"The bugs attack %s"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "The bugs attack %s" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line"><span class='comment'>// display the hit message for an attack</span></td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line"><span class='keyword'>void</span> player_hit_message( Character *attacker, <span class='keyword'>const</span> std::string &amp;message,</td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">                         Creature &amp;t, <span class='keyword'>int</span> dam, <span class='keyword'>bool</span> crit, <span class='keyword'>bool</span> technique, <span class='keyword'>const</span> std::string &amp;wp_hit )</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">    std::string msg;</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">    game_message_type msgtype = m_good;</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">    std::string sSCTmod;</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">    game_message_type gmtSCTcolor = m_good;</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">    Character &amp;player_character = get_player_character();</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">    <span class='keyword'>if</span>( dam &lt;= 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line">        <span class='keyword'>if</span>( attacker-&gt;is_npc() ) {</td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">            <span class='comment'>//~ NPC hits something but does no damage</span></td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s but does no damage."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s but does no damage." ) ) )</span></span>, message );</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">            <span class='comment'>//~ someone hits something but do no damage</span></td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s but do no damage."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s but do no damage." ) ) )</span></span>, message );</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">        msgtype = m_neutral;</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( crit ) {</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">        <span class='comment'>//Player won't see exact numbers of damage dealt by NPC unless player has DEBUG_NIGHTVISION trait</span></td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">        <span class='keyword'>if</span>( attacker-&gt;is_npc() &amp;&amp; !player_character.has_trait( trait_DEBUG_NIGHTVISION ) ) {</td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">            <span class='comment'>//~ NPC hits something (critical)</span></td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s.  Critical!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s.  Critical!" ) ) )</span></span>, message );</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( technique &amp;&amp; !wp_hit.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">            <span class='comment'>//~ %1$s: "someone hits something", %2$d: damage dealt, %3$s: the weakpoint hit</span></td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%1$s for %2$d damage, and hit it in %3$s.  Critical!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%1$s for %2$d damage, and hit it in %3$s.  Critical!"<br> ) ) )</span></span>, message, dam,</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">                                 wp_hit );</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">            <span class='comment'>//~ someone hits something for %d damage (critical)</span></td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s for %d damage.  Critical!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s for %d damage.  Critical!"<br> ) ) )</span></span>, message, dam );</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">        sSCTmod = <span class='macro'>_( <span class='string_literal'>"Critical!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "Critical!" ) ) )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">        gmtSCTcolor = m_critical;</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">        <span class='keyword'>if</span>( attacker-&gt;is_npc() &amp;&amp; !player_character.has_trait( trait_DEBUG_NIGHTVISION ) ) {</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">            <span class='comment'>//~ NPC hits something</span></td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s." ) ) )</span></span>, message );</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( technique &amp;&amp; !wp_hit.empty() ) {</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">            <span class='comment'>//~ %1$s: "someone hits something", %2$d: damage dealt, %3$s: the weakpoint hit</span></td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%1$s for %2$d damage, and hit it in %3$s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%1$s for %2$d damage, and hit it in %3$s."<br> ) ) )</span></span>, message, dam, wp_hit );</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">            <span class='comment'>//~ someone hits something for %d damage</span></td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">            msg = string_format( <span class='macro'>_( <span class='string_literal'>"%s for %d damage."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s for %d damage." ) ) )</span></span>, message, dam );</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">    <span class='keyword'>if</span>( dam &gt; 0 &amp;&amp; attacker-&gt;is_avatar() ) {</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">        <span class='comment'>//player hits monster melee</span></td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">        SCT.add( point( t.posx(), t.posy() ),</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">                 direction_from( point_zero, point( t.posx() - attacker-&gt;posx(), t.posy() - attacker-&gt;posy() ) ),</td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">                 get_hp_bar( dam, t.get_hp_max(), <span class='keyword'>true</span> ).first, m_good,</td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line">                 sSCTmod, gmtSCTcolor );</td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">        <span class='keyword'>if</span>( t.get_hp() &gt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">            SCT.add( point( t.posx(), t.posy() ),</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">                     direction_from( point_zero, point( t.posx() - attacker-&gt;posx(), t.posy() - attacker-&gt;posy() ) ),</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">                     get_hp_bar( t.get_hp(), t.get_hp_max(), <span class='keyword'>true</span> ).first, m_good,</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">                     <span class='comment'>//~ "hit points", used in scrolling combat text</span></td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">                     <span class='macro'>_( <span class='string_literal'>"hp"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "hp" ) ) )</span></span>, m_neutral,</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">                     <span class='string_literal'>"hp"</span> );</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">            SCT.removeCreatureHP();</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">    <span class='comment'>// same message is used for player and npc,</span></td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line">    <span class='comment'>// just using this for the &lt;npcname&gt; substitution.</span></td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line">    attacker-&gt;add_msg_player_or_npc( msgtype, msg, msg, t.disp_name() );</td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line"><span class='keyword'>int</span> Character::attack_speed( <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> base_move_cost = weap.attack_time( *<span class='keyword'>this</span> ) / 2;</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> melee_skill = has_active_bionic( bionic_id( bio_cqb ) ) ? BIO_CQB_LEVEL :</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">                              get_skill_level( skill_melee );</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE increases melee attack speed */</span></td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> skill_cost = <span class='keyword'>static_cast</span>&lt;<span class='keyword'>int</span>&gt;( ( base_move_cost * ( 15 - melee_skill ) / 15 ) );</td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line">    <span class='comment'>/** @EFFECT_DEX increases attack speed */</span></td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> dexbonus = dex_cur / 2;</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> ma_move_cost = mabuff_attack_cost_penalty();</td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> stamina_ratio = <span class='keyword'>static_cast</span>&lt;<span class='keyword'>float</span>&gt;( get_stamina() ) / <span class='keyword'>static_cast</span>&lt;<span class='keyword'>float</span>&gt;</td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">                                ( get_stamina_max() );</td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line">    <span class='comment'>// Increase cost multiplier linearly from 1.0 to 2.0 as stamina goes from 25% to 0%.</span></td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> stamina_penalty = 1.0 + std::max( ( 0.25f - stamina_ratio ) * 4.0f, 0.0f );</td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>float</span> ma_mult = mabuff_attack_cost_mult();</td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">    <span class='keyword'>double</span> move_cost = base_move_cost;</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">    move_cost *= get_modifier( character_modifier_melee_thrown_move_lift_mod );</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">    move_cost *= get_modifier( character_modifier_melee_thrown_move_balance_mod );</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line">    move_cost *= stamina_penalty;</td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">    move_cost += skill_cost;</td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">    move_cost -= dexbonus;</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">    move_cost = calculate_by_enchantment( move_cost, enchant_vals::mod::ATTACK_SPEED, <span class='keyword'>true</span> );</td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">    <span class='comment'>// Martial arts last. Flat has to be after mult, because comments say so.</span></td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">    move_cost *= ma_mult;</td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">    move_cost += ma_move_cost;</td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">    move_cost *= mutation_value( <span class='string_literal'>"attackcost_modifier"</span> );</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">    <span class='keyword'>if</span>( is_on_ground() ) {</td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line">        <span class='keyword'>if</span>( has_flag( json_flag_PSEUDOPOD_GRASP ) ) {</td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">            move_cost *= 1.5;</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">            move_cost *= 4.0;</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( is_crouching() &amp;&amp; ( !has_flag( json_flag_PSEUDOPOD_GRASP ) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">                                   ( !has_effect( effect_natural_stance ) &amp;&amp; !unarmed_attack() ) ) ) {</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">        move_cost *= 1.5;</td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line">    <span class='keyword'>if</span>( move_cost &lt; 25.0 ) {</td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">        <span class='keyword'>return</span> 25;</td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line">    <span class='keyword'>return</span> std::round( move_cost );</td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line"><span class='keyword'>double</span> Character::weapon_value( <span class='keyword'>const</span> item &amp;weap, <span class='keyword'>int</span> ammo ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">    <span class='keyword'>if</span>( is_wielding( weap ) || ( !get_wielded_item() &amp;&amp; weap.is_null() ) ) {</td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">        <span class='keyword'>auto</span> cached_value = cached_info.find( <span class='string_literal'>"weapon_value"</span> );</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">        <span class='keyword'>if</span>( cached_value != cached_info.end() ) {</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line">            <span class='keyword'>return</span> cached_value-&gt;second;</td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line">    <span class='keyword'>double</span> val_gun = gun_value( weap, ammo );</td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">    val_gun = val_gun /</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">              5.0f; <span class='comment'>// This is an emergency patch to get melee and ranged in approximate parity, if you're looking at it in 2025 or later and it's still here... I'm sorry.  Kill it with fire.  Tear it all down, and rebuild a glorious castle from the ashes.</span></td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_NPC_ITEMAI,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "&lt;color_magenta&gt;weapon_value&lt;/color&gt;%s %s valued at &lt;color_light_cyan&gt;%1.2f as a ranged weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_gun ) )<br> ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">                   <span class='string_literal'><span class='macro'>"&lt;color_magenta&gt;weapon_value&lt;/color&gt;%s %s valued at &lt;color_light_cyan&gt;%1.2f as a ranged weapon&lt;/color&gt;."</span>,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "&lt;color_magenta&gt;weapon_value&lt;/color&gt;%s %s valued at &lt;color_light_cyan&gt;%1.2f as a ranged weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_gun ) )<br> ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">                   <span class='macro'>disp_name( <span class='keyword'>true</span> ), weap.type-&gt;get_id().str(), val_gun )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "&lt;color_magenta&gt;weapon_value&lt;/color&gt;%s %s valued at &lt;color_light_cyan&gt;%1.2f as a ranged weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_gun ) )<br> ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">    <span class='keyword'>double</span> val_melee = melee_value( weap );</td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">    val_melee *=</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">        val_melee; <span class='comment'>// Same emergency patch.  Same purple prose descriptors, you already saw them above.</span></td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_NPC_ITEMAI,<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s %s valued at &lt;color_light_cyan&gt;%1.2f as a melee weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_melee )<br> ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">                   <span class='string_literal'><span class='macro'>"%s %s valued at &lt;color_light_cyan&gt;%1.2f as a melee weapon&lt;/color&gt;."</span>, disp_name( <span class='keyword'>true</span> ),<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s %s valued at &lt;color_light_cyan&gt;%1.2f as a melee weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_melee )<br> ) ); } } while( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">                   <span class='macro'>weap.type-&gt;get_id().str(), val_melee )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_NPC_ITEMAI ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s %s valued at &lt;color_light_cyan&gt;%1.2f as a melee weapon&lt;/color&gt;."<br>, disp_name( true ), weap.type-&gt;get_id().str(), val_melee )<br> ) ); } } while( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> more = std::max( val_gun, val_melee );</td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> less = std::min( val_gun, val_melee );</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">    <span class='comment'>// A small bonus for guns you can also use to hit stuff with (bayonets etc.)</span></td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>double</span> my_val = more + ( less / 2.0 );</td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s (%ld ammo) sum value: %.1f"</span>, weap.type-&gt;get_id().str(),<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s (%ld ammo) sum value: %.1f"<br>, weap.type-&gt;get_id().str(), ammo, my_val ) ) ); } } while<br>( false )</span></span></td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">                   <span class='macro'>ammo, my_val )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s (%ld ammo) sum value: %.1f"<br>, weap.type-&gt;get_id().str(), ammo, my_val ) ) ); } } while<br>( false )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">    <span class='keyword'>if</span>( is_wielding( weap ) || ( !get_wielded_item() &amp;&amp; weap.is_null() ) ) {</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">        cached_info.emplace( <span class='string_literal'>"weapon_value"</span>, my_val );</td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">    <span class='keyword'>return</span> my_val;</td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line"><span class='keyword'>double</span> Character::melee_value( <span class='keyword'>const</span> item &amp;weap ) <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">    <span class='comment'>// start with average effective dps against a range of enemies</span></td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">    <span class='keyword'>double</span> my_value = weap.average_dps( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">    <span class='keyword'>float</span> reach = weap.reach_range( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">    <span class='comment'>// value reach weapons more</span></td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">    <span class='keyword'>if</span>( reach &gt; 1.0f ) {</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">        my_value *= 1.0f + 0.5f * ( std::sqrt( reach ) - 1.0f );</td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">    <span class='comment'>// value polearms less to account for the trickiness of keeping the right range</span></td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">    <span class='keyword'>if</span>( weapon.has_flag( flag_POLEARM ) ) {</td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">        my_value *= 0.8;</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">    <span class='comment'>// value style weapons more</span></td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">    <span class='keyword'>if</span>( !martial_arts_data-&gt;enumerate_known_styles( weap.type-&gt;get_id() ).empty() ) {</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line">        my_value *= 1.5;</td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">    <span class='macro'>add_msg_debug( debugmode::DF_MELEE, <span class='string_literal'>"%s as melee: %.1f"</span>, weap.type-&gt;get_id().str(), my_value )<span class='macro_popup'>do { if( debug_mode &amp;&amp; Messages::has_debug_filter( debugmode<br>::DF_MELEE ) &amp;&amp; ( true ) ) { Messages::add_msg( m_debug<br>, clang_tidy_no_translations( string_format( "%s as melee: %.1f"<br>, weap.type-&gt;get_id().str(), my_value ) ) ); } } while( false<br> )</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">    <span class='keyword'>return</span> std::max( 0.0, my_value );</td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line"><span class='keyword'>double</span> Character::unarmed_value() <span class='keyword'>const</span></td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">    <span class='comment'>// TODO: Martial arts</span></td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">    <span class='keyword'>return</span> melee_value( item() );</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line"><span class='keyword'>void</span> avatar::disarm( npc &amp;target )</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">    <span class='keyword'>if</span>( !target.is_armed() ) {</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">    <span class='keyword'>if</span>( target.is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">        target.on_attacked( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">    <span class='comment'>/** @ARM_STR increases chance to disarm, primary stat */</span></td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">    <span class='comment'>/** @EFFECT_DEX increases chance to disarm, secondary stat */</span></td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">    <span class='comment'>/** Grip strength modifies all disarm rolls */</span></td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">    <span class='keyword'>int</span> my_roll = dice( 3, get_limb_score( limb_score_grip ) * get_arm_str() + get_dex() );</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">    <span class='comment'>/** @EFFECT_MELEE increases chance to disarm */</span></td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">    my_roll += dice( 3, round( get_skill_level( skill_melee ) ) );</td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">    <span class='keyword'>int</span> their_roll = dice( 3, target.get_limb_score( limb_score_grip ) * target.get_arm_str() +</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">                           target.get_dex() );</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">    their_roll *= target.get_limb_score( limb_score_reaction );</td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">    their_roll += dice( 3, round( target.get_skill_level( skill_melee ) ) );</td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">    item_location it = target.get_wielded_item();</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">    <span class='keyword'>const</span> item_location weapon = get_wielded_item();</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">    <span class='comment'>// roll your melee and target's dodge skills to check if grab/smash attack succeeds</span></td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">    <span class='keyword'>int</span> hitspread = target.deal_melee_attack( <span class='keyword'>this</span>, hit_roll() );</td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">    <span class='keyword'>if</span>( hitspread &lt; 0 ) {</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">        add_msg( <span class='macro'>_( <span class='string_literal'>"You lunge for the %s, but miss!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You lunge for the %s, but miss!"<br> ) ) )</span></span>, it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line">        item weap = get_wielded_item() ? *get_wielded_item() : null_item_reference();</td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">        mod_moves( -100 - stumble( *<span class='keyword'>this</span>, weapon ) - attack_speed( weap ) );</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">        target.on_attacked( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">    map &amp;here = get_map();</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">    <span class='comment'>// hitspread &gt;= 0, which means we are going to disarm by grabbing target by their weapon</span></td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">    <span class='keyword'>if</span>( !is_armed() ) {</td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">        <span class='comment'>/** @EFFECT_UNARMED increases chance to disarm, bonus when nothing wielded */</span></td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">        my_roll += dice( 3, round( get_skill_level( skill_unarmed ) ) );</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">        <span class='keyword'>if</span>( my_roll &gt;= their_roll ) {</td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line">            <span class='comment'>//~ %s: weapon name</span></td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You grab at %s and pull with all your force!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You grab at %s and pull with all your force!"<br> ) ) )</span></span>, it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">            <span class='comment'>//~ %1$s: weapon name, %2$s: NPC name</span></td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You forcefully take %1$s from %2$s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You forcefully take %1$s from %2$s!"<br> ) ) )</span></span>, it-&gt;tname(), target.get_name() );</td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">            <span class='comment'>// wield() will deduce our moves, consider to deduce more/less moves for balance</span></td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">            item rem_it = target.i_rem( &amp;*it );</td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">            wield( rem_it );</td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>( my_roll &gt;= their_roll / 2 ) {</td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You grab at %s and pull with all your force, but it drops nearby!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You grab at %s and pull with all your force, but it drops nearby!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line">                     it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line">            <span class='keyword'>const</span> tripoint tp = target.pos() + tripoint( rng( -1, 1 ), rng( -1, 1 ), 0 );</td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">            here.add_item_or_charges( tp, target.i_rem( &amp;*it ) );</td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">            mod_moves( -100 );</td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You grab at %s and pull with all your force, but in vain!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You grab at %s and pull with all your force, but in vain!"<br> ) ) )</span></span>, it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">            mod_moves( -100 );</td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line">        target.on_attacked( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">        <span class='comment'>// Make their weapon fall on floor if we've rolled enough.</span></td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">        mod_moves( -100 - attack_speed( *get_wielded_item() ) );</td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line">        <span class='keyword'>if</span>( my_roll &gt;= their_roll ) {</td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You smash %s with all your might forcing their %s to drop down nearby!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You smash %s with all your might forcing their %s to drop down nearby!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line">                     target.get_name(), it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line">            <span class='keyword'>const</span> tripoint tp = target.pos() + tripoint( rng( -1, 1 ), rng( -1, 1 ), 0 );</td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line">            here.add_item_or_charges( tp, target.i_rem( &amp;*it ) );</td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">            add_msg( <span class='macro'>_( <span class='string_literal'>"You smash %s with all your might but %s remains in their hands!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You smash %s with all your might but %s remains in their hands!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">                     target.get_name(), it-&gt;tname() );</td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line">        target.on_attacked( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line"><span class='keyword'>void</span> avatar::steal( npc &amp;target )</td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line">    <span class='keyword'>if</span>( target.is_enemy() ) {</td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line">        add_msg( <span class='macro'>_( <span class='string_literal'>"%s is hostile!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "%s is hostile!" ) ) )</span></span>, target.get_name() );</td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">    item_location loc = game_menus::inv::steal( *<span class='keyword'>this</span>, target );</td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line">    <span class='keyword'>if</span>( !loc ) {</td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line">    <span class='comment'>/** @EFFECT_DEX defines the chance to steal */</span></td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line">    <span class='keyword'>int</span> my_roll = dice( 3, get_dex() );</td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line">    <span class='comment'>/** @EFFECT_UNARMED adds bonus to stealing when wielding nothing */</span></td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line">    <span class='keyword'>if</span>( !is_armed() ) {</td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line">        my_roll += dice( 4, 3 );</td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line">    <span class='keyword'>if</span>( has_trait( trait_DEFT ) ) {</td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line">        my_roll += dice( 2, 6 );</td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line">    <span class='keyword'>if</span>( has_trait( trait_CLUMSY ) ) {</td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line">        my_roll -= dice( 4, 6 );</td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line">    <span class='keyword'>int</span> their_roll = dice( 5, target.get_per() );</td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line">    <span class='keyword'>const</span> item *it = loc.get_item();</td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line">    <span class='keyword'>if</span>( my_roll &gt;= their_roll &amp;&amp; !target.is_hallucination() ) {</td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line">        add_msg( <span class='macro'>_( <span class='string_literal'>"You sneakily steal %1$s from %2$s!"</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You sneakily steal %1$s from %2$s!"<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line">                 it-&gt;tname(), target.get_name() );</td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line">        i_add( target.i_rem( it ) );</td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>( my_roll &gt;= their_roll / 2 ) {</td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line">        add_msg( <span class='macro'>_( <span class='string_literal'>"You failed to steal %1$s from %2$s, but did not attract attention."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You failed to steal %1$s from %2$s, but did not attract attention."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line">                 it-&gt;tname(), target.get_name() );</td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line">    } <span class='keyword'>else</span>  {</td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line">        add_msg( <span class='macro'>_( <span class='string_literal'>"You failed to steal %1$s from %2$s."</span> )<span class='macro_popup'>( ( []( const auto &amp; arg ) { static auto cache = detail::<br>get_local_translation_cache( arg ); return cache( arg ); } )(<br> translation_argument_identity( "You failed to steal %1$s from %2$s."<br> ) ) )</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line">                 it-&gt;tname(), target.get_name() );</td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line">        target.on_attacked( *<span class='keyword'>this</span> );</td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line">    <span class='comment'>// consider to deduce less/more moves for balance</span></td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line">    mod_moves( -200 );</td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line"><span class='comment'>/**</span></td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line"> <span class='comment'>* Once the accuracy (sum of modifiers) of an attack has been determined,</span></td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line"> <span class='comment'>* this is used to actually roll the "hit value" of the attack to be compared to dodge.</span></td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line"><span class='keyword'>float</span> melee::melee_hit_range( <span class='keyword'>float</span> accuracy )</td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line">    <span class='keyword'>return</span> normal_roll( accuracy * 5, 25.0f );</td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line">melee_statistic_data melee::get_stats()</td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line">    <span class='keyword'>return</span> melee_stats;</td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line"><span class='keyword'>void</span> melee::clear_stats()</td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line">    melee_stats = melee_statistic_data{};</td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line"><span class='keyword'>namespace</span> melee</td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line">melee_statistic_data melee_stats;</td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line">} <span class='comment'>// namespace melee</span></td></tr>
</table></body></html>
